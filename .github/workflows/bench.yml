# ══════════════════════════════════════════════════════════════════════════════
#                      🎭 Playwright CI Benchmark Workflow                       
#                                                                                 
#   Purpose: パッケージマネージャー (bun/pnpm/npm) とキャッシュ戦略による              
#            E2Eテスト実行時間の比較ベンチマーク                                     
#                                                                                
#   Structure:                                                                     
#     1. prepare-cache    → 🚀 [高速化コア] キャッシュの事前準備                
#     2. e2e-with-cache   → ⏱️ [ベンチマーク] キャッシュあり計測                
#     3. e2e-without-cache→ ⏱️ [ベンチマーク] キャッシュなし計測                
#     4. summary          → 📊 [結果集計] 統計・比較レポート生成                
# ══════════════════════════════════════════════════════════════════════════════

name: Playwright CI Benchmark

on:
  push:

# PRへの書き込み権限を付与
permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXTAUTH_URL: http://localhost:3000
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
  NEXT_PUBLIC_ENABLE_MOCK_AUTH: true
  PLAYWRIGHT_BROWSERS: chromium

jobs:
  # ════════════════════════════════════════════════════════════════════════════
  # ██ Step 1: prepare-cache
  # ██ 🚀 高速化コア機能: キャッシュの事前準備
  # ██ 
  # ██ 依存パッケージとPlaywrightブラウザをキャッシュに保存し、
  # ██ 後続のテスト実行を高速化する
  # ════════════════════════════════════════════════════════════════════════════
  prepare-cache:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-manager: [bun, pnpm, npm]
    steps:
      - uses: actions/checkout@v4
      
      # Package Manager Setup
      - name: Setup Bun
        if: matrix.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Node.js for pnpm/npm
        if: matrix.package-manager != 'bun'
        uses: actions/setup-node@v6
        with:
          node-version: '24'
      
      - name: Setup pnpm
        if: matrix.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      # ────────────────────────────────────────────────────────────────────
      #  ⚙️ 環境設定 (Environment Configuration)
      #  パッケージマネージャーごとのコマンドとパスを一元管理
      # ────────────────────────────────────────────────────────────────────
      - name: Configure Environment
        run: |
          if [ "${{ matrix.package-manager }}" = "bun" ]; then
            echo "LOCKFILE=bun.lock" >> $GITHUB_ENV
            echo "CACHE_DIR=$HOME/.bun/install/cache" >> $GITHUB_ENV
            echo "INSTALL_CMD=bun install --frozen-lockfile" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=bunx playwright install --with-deps" >> $GITHUB_ENV
            echo "PLAYWRIGHT_VERSION_CMD=bunx playwright --version" >> $GITHUB_ENV
          elif [ "${{ matrix.package-manager }}" = "pnpm" ]; then
            echo "LOCKFILE=pnpm-lock.yaml" >> $GITHUB_ENV
            echo "CACHE_DIR=$(pnpm store path)" >> $GITHUB_ENV
            echo "INSTALL_CMD=pnpm install --frozen-lockfile" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=pnpm exec playwright install --with-deps" >> $GITHUB_ENV
            echo "PLAYWRIGHT_VERSION_CMD=pnpm exec playwright --version" >> $GITHUB_ENV
          else
            echo "LOCKFILE=package-lock.json" >> $GITHUB_ENV
            echo "CACHE_DIR=$HOME/.npm" >> $GITHUB_ENV
            echo "INSTALL_CMD=npm ci" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=npx playwright install --with-deps" >> $GITHUB_ENV
            echo "PLAYWRIGHT_VERSION_CMD=npx playwright --version" >> $GITHUB_ENV
          fi

      # ────────────────────────────────────────────────────────────────────
      #  🔑 共通化されたキャッシュキー生成ロジック
      #  依存パッケージ用のキャッシュパスとキーを生成
      # ────────────────────────────────────────────────────────────────────
      - name: Generate dependency cache key
        id: deps-cache-key
        run: |
          LOCKFILE_HASH=$(sha256sum ${{ env.LOCKFILE }} | cut -d' ' -f1)
          CACHE_KEY="${{ runner.os }}-${{ matrix.package-manager }}-deps-${LOCKFILE_HASH}"
          
          echo "dir=${{ env.CACHE_DIR }}" >> $GITHUB_OUTPUT
          echo "lockfile=${{ env.LOCKFILE }}" >> $GITHUB_OUTPUT
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          
          echo "📦 Dependency Cache Configuration:"
          echo "  Directory: ${{ env.CACHE_DIR }}"
          echo "  Lockfile: ${{ env.LOCKFILE }}"
          echo "  Cache Key: ${CACHE_KEY}"

      # ────────────────────────────────────────────────────────────────────
      #  🚀 高速化コア: 依存パッケージキャッシュ                            
      #  共通化されたキャッシュキーを使用
      # ────────────────────────────────────────────────────────────────────
      - name: Cache dependencies
        uses: actions/cache@v5
        id: deps-cache
        with:
          path: |
            ${{ steps.deps-cache-key.outputs.dir }}
            node_modules
          key: ${{ steps.deps-cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.package-manager }}-deps-
      
      - name: Install dependencies
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
          echo "📥 Installing dependencies..."
          ${{ env.INSTALL_CMD }}

      # ────────────────────────────────────────────────────────────────────
      #  🔑 共通化されたキャッシュキー生成ロジック
      #  Playwright用のバージョンとキャッシュキーを生成
      # ────────────────────────────────────────────────────────────────────
      - name: Generate Playwright cache key
        id: playwright-cache-key
        run: |
          VERSION=$(jq -r '.devDependencies["@playwright/test"] // .dependencies["@playwright/test"]' package.json | sed 's/[\^~]//g')
          CACHE_KEY="playwright-${{ runner.os }}-${{ matrix.package-manager }}-${VERSION}-${{ env.PLAYWRIGHT_BROWSERS }}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          
          echo "🎭 Playwright Cache Configuration:"
          echo "  Version: ${VERSION}"
          echo "  Browsers: ${{ env.PLAYWRIGHT_BROWSERS }}"
          echo "  Cache Key: ${CACHE_KEY}"

      # ────────────────────────────────────────────────────────────────────
      #  🚀 高速化コア: Playwrightブラウザキャッシュ                        
      #  共通化されたキャッシュキーを使用
      # ────────────────────────────────────────────────────────────────────
      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ steps.playwright-cache-key.outputs.key }}
      
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          echo "🎭 Installing Playwright browsers..."
          ${{ env.PLAYWRIGHT_INSTALL_CMD }} ${{ env.PLAYWRIGHT_BROWSERS }}
      
      - name: Verify Playwright installation
        run: |
          echo "✅ Verifying Playwright installation..."
          ls -la ~/.cache/ms-playwright || echo "❌ Cache directory not found"
          ${{ env.PLAYWRIGHT_VERSION_CMD }}

  # ════════════════════════════════════════════════════════════════════════════
  # ██ Step 2: e2e-with-cache
  # ██ ⏱️  ベンチマーク計測: キャッシュあり
  # ██
  # ██ 各ステップの実行時間を計測し、JSONに記録
  # ██ 計測項目: setup_pm, install_deps, get_version, install_browsers, test_execution
  # ════════════════════════════════════════════════════════════════════════════
  e2e-with-cache:
    needs: prepare-cache
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-manager: [bun, pnpm, npm]
        run: [1, 2, 3, 4, 5]

    steps:
      - uses: actions/checkout@v4
      
      - name: Record job start
        run: echo "JOB_START=$(date +%s)" >> $GITHUB_ENV

      # Package Manager Setup
      - name: Setup Bun
        if: matrix.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Node.js for pnpm/npm
        if: matrix.package-manager != 'bun'
        uses: actions/setup-node@v6
        with:
          node-version: '24'
      
      - name: Setup pnpm
        if: matrix.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 10
      
      - name: Record setup time
        run: echo "SETUP_TIME=$(date +%s)" >> $GITHUB_ENV

      # ────────────────────────────────────────────────────────────────────
      #  ⚙️ 環境設定 (Environment Configuration)
      # ────────────────────────────────────────────────────────────────────
      - name: Configure Environment
        run: |
          if [ "${{ matrix.package-manager }}" = "bun" ]; then
            echo "LOCKFILE=bun.lock" >> $GITHUB_ENV
            echo "CACHE_DIR=$HOME/.bun/install/cache" >> $GITHUB_ENV
            echo "INSTALL_CMD=bun install --frozen-lockfile" >> $GITHUB_ENV
            echo "PLAYWRIGHT_CMD=bunx playwright" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=bunx playwright install --with-deps" >> $GITHUB_ENV
          elif [ "${{ matrix.package-manager }}" = "pnpm" ]; then
            echo "LOCKFILE=pnpm-lock.yaml" >> $GITHUB_ENV
            echo "CACHE_DIR=$(pnpm store path)" >> $GITHUB_ENV
            echo "INSTALL_CMD=pnpm install --frozen-lockfile" >> $GITHUB_ENV
            echo "PLAYWRIGHT_CMD=pnpm exec playwright" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=pnpm exec playwright install --with-deps" >> $GITHUB_ENV
          else
            echo "LOCKFILE=package-lock.json" >> $GITHUB_ENV
            echo "CACHE_DIR=$HOME/.npm" >> $GITHUB_ENV
            echo "INSTALL_CMD=npm ci" >> $GITHUB_ENV
            echo "PLAYWRIGHT_CMD=npx playwright" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=npx playwright install --with-deps" >> $GITHUB_ENV
          fi

      # ────────────────────────────────────────────────────────────────────
      #  🔑 共通化されたキャッシュキー生成ロジック（prepare-cacheと同一）
      # ────────────────────────────────────────────────────────────────────
      - name: Generate dependency cache key
        id: deps-cache-key
        run: |
          LOCKFILE_HASH=$(sha256sum ${{ env.LOCKFILE }} | cut -d' ' -f1)
          CACHE_KEY="${{ runner.os }}-${{ matrix.package-manager }}-deps-${LOCKFILE_HASH}"
          
          echo "dir=${{ env.CACHE_DIR }}" >> $GITHUB_OUTPUT
          echo "lockfile=${{ env.LOCKFILE }}" >> $GITHUB_OUTPUT
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          
          echo "📦 Restoring with key: ${CACHE_KEY}"

      # ────────────────────────────────────────────────────────────────────
      #  🚀 高速化コア: 依存パッケージキャッシュ復元                        
      #  prepare-cacheで保存したキャッシュを復元
      # ────────────────────────────────────────────────────────────────────
      - name: Restore dependencies cache
        uses: actions/cache/restore@v5
        id: deps-cache
        with:
          path: |
            ${{ steps.deps-cache-key.outputs.dir }}
            node_modules
          key: ${{ steps.deps-cache-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.package-manager }}-deps-
      
      - name: Check cache status
        run: |
          if [ "${{ steps.deps-cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Dependencies cache HIT"
          else
            echo "⚠️ Dependencies cache MISS"
          fi

      # ────────────────────────────────────────────────────────────────────
      #  ⏱️  ベンチマーク計測セクション (install_deps)                     
      # ────────────────────────────────────────────────────────────────────
      - name: Install dependencies
        run: |
          START=$(date +%s)
          ${{ env.INSTALL_CMD }}
          END=$(date +%s)
          echo "INSTALL_DEPS_DURATION=$((END - START))" >> $GITHUB_ENV

      # ────────────────────────────────────────────────────────────────────
      #  🔑 共通化されたキャッシュキー生成ロジック（prepare-cacheと同一）
      # ────────────────────────────────────────────────────────────────────
      - name: Generate Playwright cache key
        id: playwright-cache-key
        run: |
          START=$(date +%s)
          VERSION=$(jq -r '.devDependencies["@playwright/test"] // .dependencies["@playwright/test"]' package.json | sed 's/[\^~]//g')
          CACHE_KEY="playwright-${{ runner.os }}-${{ matrix.package-manager }}-${VERSION}-${{ env.PLAYWRIGHT_BROWSERS }}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          
          END=$(date +%s)
          echo "GET_VERSION_DURATION=$((END - START))" >> $GITHUB_ENV
          echo "🎭 Restoring with key: ${CACHE_KEY}"

      # ────────────────────────────────────────────────────────────────────
      #  🚀 高速化コア: Playwrightブラウザキャッシュ復元
      # ────────────────────────────────────────────────────────────────────
      - name: Restore Playwright browsers cache
        uses: actions/cache/restore@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ steps.playwright-cache-key.outputs.key }}
      
      - name: Check Playwright cache status
        run: |
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Playwright cache HIT"
          else
            echo "⚠️ Playwright cache MISS"
          fi

      # ────────────────────────────────────────────────────────────────────
      #  🎭 Playwrightブラウザインストール
      #  キャッシュヒットの場合は完全にスキップ（システム依存関係も不要）
      #  キャッシュミスの場合のみフルインストール
      # ────────────────────────────────────────────────────────────────────
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          START=$(date +%s)
          echo "⚠️ Cache miss - Installing browsers with dependencies..."
          ${{ env.PLAYWRIGHT_INSTALL_CMD }} ${{ env.PLAYWRIGHT_BROWSERS }}
          END=$(date +%s)
          echo "INSTALL_BROWSERS_DURATION=$((END - START))" >> $GITHUB_ENV
      
      - name: Record zero time for cache hit
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          echo "✅ Cache hit - Skipping browser installation completely"
          echo "INSTALL_BROWSERS_DURATION=0" >> $GITHUB_ENV
        
      - name: Run E2E tests (run #${{ matrix.run }})
        id: playwright-tests
        continue-on-error: true
        run: |
          START=$(date +%s)
          ${{ env.PLAYWRIGHT_CMD }} test
          END=$(date +%s)
          echo "TEST_DURATION=$((END - START))" >> $GITHUB_ENV
      
      # ────────────────────────────────────────────────────────────────────
      #  💾 ベンチマーク結果保存                                           
      # ────────────────────────────────────────────────────────────────────
      - name: Save timing data
        if: always()
        run: |
          JOB_END=$(date +%s)
          TOTAL_DURATION=$((JOB_END - JOB_START))
          SETUP_DURATION=$((SETUP_TIME - JOB_START))
          
          cat << EOF > timing-${{ matrix.package-manager }}-cached-${{ matrix.run }}.json
          {
            "package_manager": "${{ matrix.package-manager }}",
            "cache_enabled": true,
            "run": ${{ matrix.run }},
            "total": $TOTAL_DURATION,
            "setup_pm": $SETUP_DURATION,
            "install_deps": ${INSTALL_DEPS_DURATION:-0},
            "deps_cache_hit": "${{ steps.deps-cache.outputs.cache-hit }}",
            "get_version": ${GET_VERSION_DURATION:-0},
            "install_browsers": ${INSTALL_BROWSERS_DURATION:-0},
            "playwright_cache_hit": "${{ steps.playwright-cache.outputs.cache-hit }}",
            "test_execution": ${TEST_DURATION:-0},
            "test_result": "${{ steps.playwright-tests.outcome }}"
          }
          EOF
          
          cat timing-${{ matrix.package-manager }}-cached-${{ matrix.run }}.json
          
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: timing-data-${{ matrix.package-manager }}-cached-${{ matrix.run }}
          path: timing-${{ matrix.package-manager }}-cached-${{ matrix.run }}.json
          retention-days: 7

  # ════════════════════════════════════════════════════════════════════════════
  # ██ Step 3: e2e-without-cache
  # ██ ⏱️  ベンチマーク計測: キャッシュなし
  # ════════════════════════════════════════════════════════════════════════════
  e2e-without-cache:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-manager: [bun, pnpm, npm]
        run: [1, 2, 3, 4, 5]
    steps:
      - uses: actions/checkout@v4
      
      - name: Record job start
        run: echo "JOB_START=$(date +%s)" >> $GITHUB_ENV

      # Package Manager Setup
      - name: Setup Bun
        if: matrix.package-manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Setup Node.js for pnpm/npm
        if: matrix.package-manager != 'bun'
        uses: actions/setup-node@v6
        with:
          node-version: '24'
      
      - name: Setup pnpm
        if: matrix.package-manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 10
      
      - name: Record setup time
        run: echo "SETUP_TIME=$(date +%s)" >> $GITHUB_ENV

      # ────────────────────────────────────────────────────────────────────
      #  ⚙️ 環境設定 (Environment Configuration)
      # ────────────────────────────────────────────────────────────────────
      - name: Configure Environment
        run: |
          if [ "${{ matrix.package-manager }}" = "bun" ]; then
            echo "LOCKFILE=bun.lock" >> $GITHUB_ENV
            echo "CACHE_DIR=$HOME/.bun/install/cache" >> $GITHUB_ENV
            echo "INSTALL_CMD=bun install --frozen-lockfile" >> $GITHUB_ENV
            echo "PLAYWRIGHT_CMD=bunx playwright" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=bunx playwright install --with-deps" >> $GITHUB_ENV
          elif [ "${{ matrix.package-manager }}" = "pnpm" ]; then
            echo "LOCKFILE=pnpm-lock.yaml" >> $GITHUB_ENV
            echo "CACHE_DIR=$(pnpm store path)" >> $GITHUB_ENV
            echo "INSTALL_CMD=pnpm install --frozen-lockfile" >> $GITHUB_ENV
            echo "PLAYWRIGHT_CMD=pnpm exec playwright" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=pnpm exec playwright install --with-deps" >> $GITHUB_ENV
          else
            echo "LOCKFILE=package-lock.json" >> $GITHUB_ENV
            echo "CACHE_DIR=$HOME/.npm" >> $GITHUB_ENV
            echo "INSTALL_CMD=npm ci" >> $GITHUB_ENV
            echo "PLAYWRIGHT_CMD=npx playwright" >> $GITHUB_ENV
            echo "PLAYWRIGHT_INSTALL_CMD=npx playwright install --with-deps" >> $GITHUB_ENV
          fi

      - name: Install dependencies (no cache)
        run: |
          START=$(date +%s)
          ${{ env.INSTALL_CMD }}
          END=$(date +%s)
          echo "INSTALL_DEPS_DURATION=$((END - START))" >> $GITHUB_ENV
      
      - name: Get Playwright version
        id: playwright-version
        run: |
          START=$(date +%s)
          VERSION=$(jq -r '.devDependencies["@playwright/test"] // .dependencies["@playwright/test"]' package.json | sed 's/[\^~]//g')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          END=$(date +%s)
          echo "GET_VERSION_DURATION=$((END - START))" >> $GITHUB_ENV
      
      - name: Install Playwright browsers (no cache)
        run: |
          START=$(date +%s)
          ${{ env.PLAYWRIGHT_INSTALL_CMD }} ${{ env.PLAYWRIGHT_BROWSERS }}
          END=$(date +%s)
          echo "INSTALL_BROWSERS_DURATION=$((END - START))" >> $GITHUB_ENV
        
      - name: Run E2E tests (run #${{ matrix.run }})
        id: playwright-tests
        continue-on-error: true
        run: |
          START=$(date +%s)
          ${{ env.PLAYWRIGHT_CMD }} test
          END=$(date +%s)
          echo "TEST_DURATION=$((END - START))" >> $GITHUB_ENV
      
      - name: Save timing data
        if: always()
        run: |
          JOB_END=$(date +%s)
          TOTAL_DURATION=$((JOB_END - JOB_START))
          SETUP_DURATION=$((SETUP_TIME - JOB_START))
          
          cat << EOF > timing-${{ matrix.package-manager }}-nocache-${{ matrix.run }}.json
          {
            "package_manager": "${{ matrix.package-manager }}",
            "cache_enabled": false,
            "run": ${{ matrix.run }},
            "total": $TOTAL_DURATION,
            "setup_pm": $SETUP_DURATION,
            "install_deps": ${INSTALL_DEPS_DURATION:-0},
            "deps_cache_hit": "false",
            "get_version": ${GET_VERSION_DURATION:-0},
            "install_browsers": ${INSTALL_BROWSERS_DURATION:-0},
            "playwright_cache_hit": "false",
            "test_execution": ${TEST_DURATION:-0},
            "test_result": "${{ steps.playwright-tests.outcome }}"
          }
          EOF
          
          cat timing-${{ matrix.package-manager }}-nocache-${{ matrix.run }}.json
          
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: timing-data-${{ matrix.package-manager }}-nocache-${{ matrix.run }}
          path: timing-${{ matrix.package-manager }}-nocache-${{ matrix.run }}.json
          retention-days: 7

  # ════════════════════════════════════════════════════════════════════════════
  # ██ Step 4: summary
  # ██ 📊 結果集計: 統計・比較レポート生成
  # ════════════════════════════════════════════════════════════════════════════
  summary:
    needs: [e2e-with-cache, e2e-without-cache]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all timing data
        uses: actions/download-artifact@v4
        with:
          pattern: timing-data-*
          merge-multiple: true
      
      - name: Calculate averages and generate summary
        run: |
          echo "## 🎭 Playwright E2E Test Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat timing-*.json | jq -s '
            group_by(.package_manager, .cache_enabled) | 
            map({
              "package_manager": .[0].package_manager,
              "cache_enabled": .[0].cache_enabled,
              "runs": length,
              "averages": {
                "total": (map(.total) | add / length),
                "setup_pm": (map(.setup_pm) | add / length),
                "install_deps": (map(.install_deps) | add / length),
                "get_version": (map(.get_version) | add / length),
                "install_browsers": (map(.install_browsers) | add / length),
                "test_execution": (map(.test_execution) | add / length)
              },
              "cache_hits": {
                "deps": (map(select(.deps_cache_hit == "true")) | length),
                "playwright": (map(select(.playwright_cache_hit == "true")) | length)
              },
              "details": .
            })
          ' > summary.json
          
          echo "### 📊 Performance Comparison by Package Manager & Cache Strategy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package Manager | Cache | Runs | Total Time | Setup | Install Deps | Browsers | Tests | Deps Cache | PW Cache |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|-------|------|------------|-------|--------------|----------|-------|------------|----------|" >> $GITHUB_STEP_SUMMARY
          
          cat summary.json | jq -r '.[] | 
            "| **\(.package_manager)** | \(if .cache_enabled then "✅ Enabled" else "❌ Disabled" end) | \(.runs) | \(.averages.total | floor)s | \(.averages.setup_pm | floor)s | \(.averages.install_deps | floor)s | \(.averages.install_browsers | floor)s | \(.averages.test_execution | floor)s | \(.cache_hits.deps)/\(.runs) | \(.cache_hits.playwright)/\(.runs) |"
          ' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🏆 Best Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat summary.json | jq -r '
            sort_by(.averages.total) | 
            .[0] | 
            "**Fastest Configuration**: \(.package_manager) with cache \(if .cache_enabled then "enabled" else "disabled" end) - **\(.averages.total | floor)s** average total time"
          ' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📈 Cache Impact Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cat summary.json | jq -r '
            group_by(.package_manager) |
            map({
              pm: .[0].package_manager,
              with_cache: (map(select(.cache_enabled)) | .[0].averages.total),
              without_cache: (map(select(.cache_enabled | not)) | .[0].averages.total)
            }) |
            .[] |
            "- **\(.pm)**: Cache saves **\((.without_cache - .with_cache) | floor)s** (\(((.without_cache - .with_cache) / .without_cache * 100) | floor)% faster)"
          ' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Individual Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for pm in bun pnpm npm; do
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>📦 $pm detailed results</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            cat summary.json | jq -r --arg pm "$pm" '
              map(select(.package_manager == $pm)) |
              .[] |
              "#### Cache: \(if .cache_enabled then "Enabled ✅" else "Disabled ❌" end)\n",
              "| Run | Total | Setup | Deps | Browsers | Tests | Deps Cache | PW Cache |",
              "|-----|-------|-------|------|----------|-------|------------|----------|",
              (.details[] | "| \(.run) | \(.total)s | \(.setup_pm)s | \(.install_deps)s | \(.install_browsers)s | \(.test_execution)s | \(.deps_cache_hit) | \(.playwright_cache_hit) |"),
              ""
            ' >> $GITHUB_STEP_SUMMARY
            
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done
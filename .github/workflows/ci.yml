name: Playwright E2E Tests

on:
  pull_request:

# PR„Å∏„ÅÆÊõ∏„ÅçËæº„ÅøÊ®©Èôê„Çí‰ªò‰∏é
permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      NEXT_PUBLIC_ENABLE_MOCK_AUTH: true
      
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(node -p "require('./package-lock.json').packages['node_modules/@playwright/test'].version")" >> $GITHUB_OUTPUT
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
      
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps
      
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps
        
      - name: Run E2E tests
        id: playwright-tests
        continue-on-error: true
        run: npx playwright test
      
      # GitHub Summary„Å´ÁµêÊûú„ÇíÂá∫Âäõ
      - name: Generate test summary
        if: always()
        run: |
          echo "## üé≠ Playwright E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f playwright-report/index.html ]; then
            # „ÉÜ„Çπ„ÉàÁµêÊûú„ÅÆÁµ±Ë®à„ÇíÊäΩÂá∫ÔºàÁ∞°ÊòìÁâàÔºâ
            if [ "${{ steps.playwright-tests.outcome }}" == "success" ]; then
              echo "‚úÖ **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä [View detailed report in Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No test report generated" >> $GITHUB_STEP_SUMMARY
          fi
        
      # PR„Å´„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: daun/playwright-report-comment@v3
        with:
          report-path: playwright-report
          report-url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
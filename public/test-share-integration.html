<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 5.5 統合テスト - 公開URLの動作確認</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #2563eb;
      border-bottom: 3px solid #2563eb;
      padding-bottom: 10px;
    }
    .step {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .step h2 {
      margin-top: 0;
      color: #1f2937;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1d4ed8;
    }
    button.success {
      background: #10b981;
    }
    button.danger {
      background: #ef4444;
    }
    .output {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .result {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .result.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    .result.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    .url-box {
      background: #f3f4f6;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      word-break: break-all;
      font-family: monospace;
    }
    .instructions {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <h1>🧪 Phase 5.5 統合テスト - 公開URL動作確認</h1>

  <div class="instructions">
    <h3>📝 このテストについて</h3>
    <p>このページでは、しおり公開機能の実際の動作を確認します。LocalStorageにテストデータを保存し、公開URLにアクセスして正しく表示されるかをテストします。</p>
    <p><strong>注意:</strong> このテストは開発サーバー上（http://localhost:3000）で実行してください。</p>
  </div>

  <!-- Step 1: テストデータの作成 -->
  <div class="step">
    <h2>Step 1: テストデータを作成</h2>
    <p>LocalStorageにテスト用の公開しおりを保存します。</p>
    <button onclick="step1()">テストデータを作成</button>
    <button class="danger" onclick="clearTestData()">テストデータをクリア</button>
    <div id="step1-output"></div>
  </div>

  <!-- Step 2: LocalStorageの確認 -->
  <div class="step">
    <h2>Step 2: LocalStorageの確認</h2>
    <p>テストデータが正しく保存されているか確認します。</p>
    <button onclick="step2()">LocalStorageを確認</button>
    <div id="step2-output"></div>
  </div>

  <!-- Step 3: 公開URLの生成と表示 -->
  <div class="step">
    <h2>Step 3: 公開URLの確認</h2>
    <p>生成された公開URLを表示します。</p>
    <button onclick="step3()">公開URLを表示</button>
    <div id="step3-output"></div>
    <div id="public-url-display"></div>
  </div>

  <!-- Step 4: 公開ページを開く -->
  <div class="step">
    <h2>Step 4: 公開ページを開く</h2>
    <p>公開URLに新しいタブでアクセスして、正しく表示されるか確認します。</p>
    <button onclick="step4()" class="success">公開ページを開く</button>
    <div id="step4-output"></div>
  </div>

  <!-- Step 5: 完全なフロー -->
  <div class="step">
    <h2>Step 5: 完全フローテスト</h2>
    <p>すべてのステップを自動実行します。</p>
    <button onclick="runFullTest()" class="success">完全テストを実行</button>
    <div id="full-test-output"></div>
  </div>

  <script type="module">
    // モックしおりデータ
    const mockItinerary = {
      id: 'integration-test-1',
      title: '京都・奈良3泊4日の旅',
      destination: '京都',
      startDate: '2024-04-01',
      endDate: '2024-04-04',
      duration: 4,
      summary: '古都の魅力を満喫する4日間の旅程',
      schedule: [
        {
          day: 1,
          date: '2024-04-01',
          title: '京都到着・清水寺周辺',
          spots: [
            {
              id: 'spot-1',
              name: '清水寺',
              description: '世界遺産の有名寺院',
              category: 'sightseeing',
              scheduledTime: '10:00',
              duration: 90,
              estimatedCost: 500,
            },
            {
              id: 'spot-2',
              name: '二寧坂・産寧坂',
              description: '風情ある石畳の坂道',
              category: 'sightseeing',
              scheduledTime: '12:00',
              duration: 60,
              estimatedCost: 0,
            },
            {
              id: 'spot-3',
              name: '京都料理 瓢亭',
              description: '京懐石ランチ',
              category: 'dining',
              scheduledTime: '13:30',
              duration: 90,
              estimatedCost: 5000,
            },
          ],
          totalCost: 5500,
          totalDistance: 3.5,
          status: 'completed',
        },
        {
          day: 2,
          date: '2024-04-02',
          title: '嵐山・金閣寺',
          spots: [
            {
              id: 'spot-4',
              name: '金閣寺',
              description: '金色に輝く美しい寺院',
              category: 'sightseeing',
              scheduledTime: '09:00',
              duration: 60,
              estimatedCost: 500,
            },
          ],
          totalCost: 500,
          status: 'completed',
        },
      ],
      totalBudget: 6000,
      status: 'completed',
      createdAt: new Date('2024-03-01').toISOString(),
      updatedAt: new Date('2024-03-15').toISOString(),
      // Phase 5.5: 公開設定
      isPublic: true,
      publicSlug: 'test-kyoto-trip-2024',
      publishedAt: new Date('2024-03-15').toISOString(),
      viewCount: 0,
      allowPdfDownload: true,
      customMessage: 'この京都旅行計画を参考にしてください！素敵な旅になりますように✨',
    };

    let currentSlug = 'test-kyoto-trip-2024';

    // Step 1: テストデータを作成
    window.step1 = function() {
      const output = document.getElementById('step1-output');
      output.innerHTML = '';
      
      try {
        // LocalStorageに保存
        const publicItineraries = JSON.parse(
          localStorage.getItem('journee_public_itineraries') || '{}'
        );
        
        publicItineraries[currentSlug] = mockItinerary;
        
        localStorage.setItem(
          'journee_public_itineraries',
          JSON.stringify(publicItineraries)
        );
        
        output.innerHTML = `
          <div class="result success">
            ✅ テストデータを作成しました<br>
            スラッグ: <strong>${currentSlug}</strong><br>
            タイトル: <strong>${mockItinerary.title}</strong><br>
            目的地: <strong>${mockItinerary.destination}</strong><br>
            日数: <strong>${mockItinerary.duration}日間</strong>
          </div>
        `;
      } catch (error) {
        output.innerHTML = `
          <div class="result error">
            ❌ エラー: ${error.message}
          </div>
        `;
      }
    };

    // Step 2: LocalStorageを確認
    window.step2 = function() {
      const output = document.getElementById('step2-output');
      output.innerHTML = '';
      
      try {
        const data = localStorage.getItem('journee_public_itineraries');
        
        if (!data) {
          output.innerHTML = `
            <div class="result error">
              ❌ LocalStorageにデータがありません<br>
              Step 1でテストデータを作成してください
            </div>
          `;
          return;
        }
        
        const publicItineraries = JSON.parse(data);
        const keys = Object.keys(publicItineraries);
        
        output.innerHTML = `
          <div class="result success">
            ✅ LocalStorageデータ確認<br>
            保存されているスラッグ数: <strong>${keys.length}</strong><br>
            スラッグ一覧: <strong>${keys.join(', ')}</strong>
          </div>
          <div class="output">${JSON.stringify(publicItineraries, null, 2)}</div>
        `;
      } catch (error) {
        output.innerHTML = `
          <div class="result error">
            ❌ エラー: ${error.message}
          </div>
        `;
      }
    };

    // Step 3: 公開URLを表示
    window.step3 = function() {
      const output = document.getElementById('step3-output');
      const urlDisplay = document.getElementById('public-url-display');
      output.innerHTML = '';
      urlDisplay.innerHTML = '';
      
      try {
        const publicUrl = `${window.location.origin}/share/${currentSlug}`;
        
        output.innerHTML = `
          <div class="result success">
            ✅ 公開URL生成完了
          </div>
        `;
        
        urlDisplay.innerHTML = `
          <div class="url-box">
            <strong>公開URL:</strong><br>
            <a href="${publicUrl}" target="_blank" style="color: #2563eb; text-decoration: underline;">
              ${publicUrl}
            </a>
          </div>
          <p style="color: #6b7280; font-size: 14px;">
            ⬆️ このリンクをクリックすると新しいタブで公開ページが開きます
          </p>
        `;
      } catch (error) {
        output.innerHTML = `
          <div class="result error">
            ❌ エラー: ${error.message}
          </div>
        `;
      }
    };

    // Step 4: 公開ページを開く
    window.step4 = function() {
      const output = document.getElementById('step4-output');
      output.innerHTML = '';
      
      const publicUrl = `${window.location.origin}/share/${currentSlug}`;
      
      output.innerHTML = `
        <div class="result success">
          ✅ 新しいタブで公開ページを開きます...<br>
          <strong>確認項目:</strong><br>
          □ しおりのタイトルが表示される<br>
          □ 目的地が表示される<br>
          □ 日程が表示される<br>
          □ スポット情報が表示される<br>
          □ カスタムメッセージが青いボックスで表示される<br>
          □ 編集ボタンが表示されない（Read-only）<br>
          □ 共有ボタンが表示される<br>
          □ PDFダウンロードボタンが表示される<br>
          □ フッターに閲覧数・公開日が表示される
        </div>
      `;
      
      // 新しいタブで開く
      window.open(publicUrl, '_blank');
    };

    // 完全フローテスト
    window.runFullTest = async function() {
      const output = document.getElementById('full-test-output');
      output.innerHTML = '<div class="output">テスト開始...\n</div>';
      
      const log = (message) => {
        const div = document.getElementById('full-test-output');
        div.innerHTML += message + '\n';
      };
      
      try {
        // Step 1: データ作成
        log('\n📝 Step 1: テストデータを作成...');
        const publicItineraries = JSON.parse(
          localStorage.getItem('journee_public_itineraries') || '{}'
        );
        publicItineraries[currentSlug] = mockItinerary;
        localStorage.setItem(
          'journee_public_itineraries',
          JSON.stringify(publicItineraries)
        );
        log('✅ テストデータを作成しました');
        
        // Step 2: LocalStorage確認
        log('\n🔍 Step 2: LocalStorageを確認...');
        const saved = localStorage.getItem('journee_public_itineraries');
        if (!saved) {
          throw new Error('LocalStorageにデータがありません');
        }
        const parsedData = JSON.parse(saved);
        if (!parsedData[currentSlug]) {
          throw new Error('スラッグが見つかりません');
        }
        log('✅ LocalStorageに正しく保存されています');
        log(`   スラッグ: ${currentSlug}`);
        log(`   タイトル: ${parsedData[currentSlug].title}`);
        
        // Step 3: 公開URL生成
        log('\n🔗 Step 3: 公開URLを生成...');
        const publicUrl = `${window.location.origin}/share/${currentSlug}`;
        log('✅ 公開URL:');
        log(`   ${publicUrl}`);
        
        // Step 4: データ検証
        log('\n✅ Step 4: データ検証...');
        const itinerary = parsedData[currentSlug];
        log(`   公開フラグ: ${itinerary.isPublic ? '✅ true' : '❌ false'}`);
        log(`   スラッグ: ${itinerary.publicSlug}`);
        log(`   PDFダウンロード: ${itinerary.allowPdfDownload ? '✅ 許可' : '❌ 不許可'}`);
        log(`   カスタムメッセージ: ${itinerary.customMessage || 'なし'}`);
        
        // 完了
        log('\n🎉 すべてのテストが成功しました！');
        log('\n次のステップ:');
        log('1. 上の「公開ページを開く」ボタンをクリック');
        log('2. 新しいタブでしおりが正しく表示されるか確認');
        log('3. 編集ボタンが表示されないことを確認（Read-only）');
        
      } catch (error) {
        log(`\n❌ エラー: ${error.message}`);
      }
    };

    // テストデータをクリア
    window.clearTestData = function() {
      localStorage.removeItem('journee_public_itineraries');
      alert('✅ テストデータをクリアしました');
    };
  </script>
</body>
</html>

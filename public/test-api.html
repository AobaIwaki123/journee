<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 3 API テスト</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    
    .test-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
    }
    
    .test-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      margin-bottom: 10px;
      resize: vertical;
    }
    
    .result-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 15px;
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status.loading {
      background: #fff3cd;
      color: #856404;
    }
    
    .streaming-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      margin-left: 8px;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>🧪 Phase 3 API テストツール</h1>
      <p class="subtitle">Journee - AI統合機能のテスト</p>
    </div>

    <!-- Test 1: Health Check -->
    <div class="test-section">
      <h2>1️⃣ ヘルスチェック</h2>
      <div class="test-controls">
        <button onclick="testHealth()">実行</button>
      </div>
      <div id="health-result" class="result-box">結果がここに表示されます</div>
    </div>

    <!-- Test 2: Simple Chat -->
    <div class="test-section">
      <h2>2️⃣ シンプルなチャット（非ストリーミング）</h2>
      <textarea id="simple-message" placeholder="メッセージを入力...">こんにちは、AIさん</textarea>
      <div class="test-controls">
        <button onclick="testSimpleChat()">送信</button>
      </div>
      <div id="simple-result" class="result-box">結果がここに表示されます</div>
    </div>

    <!-- Test 3: Travel Planning -->
    <div class="test-section">
      <h2>3️⃣ 旅行計画作成（非ストリーミング）</h2>
      <textarea id="travel-message" placeholder="旅行の希望を入力...">東京で3日間の旅行計画を立てたいです。浅草、スカイツリー、渋谷を回りたいです。</textarea>
      <div class="test-controls">
        <button onclick="testTravelPlanning()">送信</button>
      </div>
      <div id="travel-result" class="result-box">結果がここに表示されます</div>
    </div>

    <!-- Test 4: Streaming Chat -->
    <div class="test-section">
      <h2>4️⃣ ストリーミングチャット</h2>
      <textarea id="stream-message" placeholder="メッセージを入力...">京都で2日間の旅行計画を立てたいです</textarea>
      <div class="test-controls">
        <button onclick="testStreamingChat()" id="stream-btn">送信（ストリーミング）</button>
        <button onclick="stopStreaming()" id="stop-btn" disabled>停止</button>
      </div>
      <div id="stream-result" class="result-box">結果がここに表示されます</div>
      
      <!-- Stats -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="chunk-count">0</div>
          <div class="stat-label">メッセージチャンク</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="char-count">0</div>
          <div class="stat-label">受信文字数</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="time-elapsed">0s</div>
          <div class="stat-label">経過時間</div>
        </div>
      </div>
    </div>

    <!-- Test 5: Error Handling -->
    <div class="test-section">
      <h2>5️⃣ エラーハンドリング</h2>
      <div class="test-controls">
        <button onclick="testEmptyMessage()">空メッセージ</button>
        <button onclick="testInvalidRequest()">不正なリクエスト</button>
      </div>
      <div id="error-result" class="result-box">結果がここに表示されます</div>
    </div>
  </div>

  <script>
    let streamReader = null;
    let streamController = null;
    let startTime = 0;
    let timerInterval = null;

    // ヘルスチェック
    async function testHealth() {
      const result = document.getElementById('health-result');
      result.innerHTML = '<span class="status loading">実行中...</span>';
      
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        result.innerHTML = `<span class="status success">✅ 成功</span>\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        result.innerHTML = `<span class="status error">❌ エラー</span>\n${error.message}`;
      }
    }

    // シンプルなチャット
    async function testSimpleChat() {
      const message = document.getElementById('simple-message').value;
      const result = document.getElementById('simple-result');
      
      result.innerHTML = '<span class="status loading">送信中...</span>';
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, stream: false })
        });
        
        const data = await response.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        
        if (response.ok) {
          result.innerHTML = `<span class="status success">✅ 成功 (${elapsed}秒)</span>\n\n【AIの応答】\n${data.message}\n\n【生データ】\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="status error">❌ エラー</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">❌ エラー</span>\n${error.message}`;
      }
    }

    // 旅行計画作成
    async function testTravelPlanning() {
      const message = document.getElementById('travel-message').value;
      const result = document.getElementById('travel-result');
      
      result.innerHTML = '<span class="status loading">旅行計画を作成中...</span>';
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, stream: false })
        });
        
        const data = await response.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        
        if (response.ok) {
          let output = `<span class="status success">✅ 成功 (${elapsed}秒)</span>\n\n`;
          output += `【AIの応答】\n${data.message}\n\n`;
          
          if (data.itinerary) {
            output += `【しおり情報】\n`;
            output += `タイトル: ${data.itinerary.title}\n`;
            output += `目的地: ${data.itinerary.destination}\n`;
            output += `期間: ${data.itinerary.startDate} 〜 ${data.itinerary.endDate}\n`;
            output += `日数: ${data.itinerary.schedule?.length || 0}日\n\n`;
            
            if (data.itinerary.schedule) {
              data.itinerary.schedule.forEach(day => {
                output += `\n【${day.day}日目】\n`;
                day.spots.forEach(spot => {
                  output += `  • ${spot.name} (${spot.scheduledTime || '時間未定'})\n`;
                });
              });
            }
          }
          
          output += `\n\n【生データ】\n${JSON.stringify(data, null, 2)}`;
          result.innerHTML = output;
        } else {
          result.innerHTML = `<span class="status error">❌ エラー</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">❌ エラー</span>\n${error.message}`;
      }
    }

    // ストリーミングチャット
    async function testStreamingChat() {
      const message = document.getElementById('stream-message').value;
      const result = document.getElementById('stream-result');
      const streamBtn = document.getElementById('stream-btn');
      const stopBtn = document.getElementById('stop-btn');
      
      // UI更新
      streamBtn.disabled = true;
      stopBtn.disabled = false;
      
      // カウンターリセット
      let chunkCount = 0;
      let charCount = 0;
      startTime = Date.now();
      
      document.getElementById('chunk-count').textContent = '0';
      document.getElementById('char-count').textContent = '0';
      document.getElementById('time-elapsed').textContent = '0s';
      
      // タイマー開始
      timerInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('time-elapsed').textContent = `${elapsed}s`;
      }, 100);
      
      result.innerHTML = '<span class="status loading">ストリーミング中<span class="streaming-indicator"></span></span>\n\n';
      let fullMessage = '';
      let itineraryReceived = false;
      
      try {
        streamController = new AbortController();
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, stream: true }),
          signal: streamController.signal
        });
        
        streamReader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
          const { done, value } = await streamReader.read();
          
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                
                if (data.type === 'message' && data.content) {
                  fullMessage += data.content;
                  charCount += data.content.length;
                  chunkCount++;
                  
                  // UI更新
                  document.getElementById('chunk-count').textContent = chunkCount;
                  document.getElementById('char-count').textContent = charCount;
                  
                  result.innerHTML = `<span class="status loading">ストリーミング中<span class="streaming-indicator"></span></span>\n\n${fullMessage}`;
                  result.scrollTop = result.scrollHeight;
                  
                } else if (data.type === 'itinerary') {
                  itineraryReceived = true;
                } else if (data.type === 'done') {
                  break;
                } else if (data.type === 'error') {
                  throw new Error(data.error);
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            }
          }
        }
        
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        result.innerHTML = `<span class="status success">✅ 完了 (${elapsed}秒)</span>\n\n${fullMessage}\n\n${itineraryReceived ? '✅ しおりデータを受信しました' : ''}`;
        
      } catch (error) {
        if (error.name === 'AbortError') {
          result.innerHTML = `<span class="status error">⚠️ 停止されました</span>\n\n${fullMessage}`;
        } else {
          result.innerHTML = `<span class="status error">❌ エラー</span>\n${error.message}`;
        }
      } finally {
        clearInterval(timerInterval);
        streamBtn.disabled = false;
        stopBtn.disabled = true;
        streamReader = null;
        streamController = null;
      }
    }

    // ストリーミング停止
    function stopStreaming() {
      if (streamController) {
        streamController.abort();
      }
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    }

    // エラーテスト: 空メッセージ
    async function testEmptyMessage() {
      const result = document.getElementById('error-result');
      result.innerHTML = '<span class="status loading">テスト中...</span>';
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: '', stream: false })
        });
        
        const data = await response.json();
        
        if (response.status === 400) {
          result.innerHTML = `<span class="status success">✅ 正しくエラーハンドリングされました</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="status error">❌ 期待しないレスポンス</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">❌ エラー</span>\n${error.message}`;
      }
    }

    // エラーテスト: 不正なリクエスト
    async function testInvalidRequest() {
      const result = document.getElementById('error-result');
      result.innerHTML = '<span class="status loading">テスト中...</span>';
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stream: false }) // messageがない
        });
        
        const data = await response.json();
        
        if (response.status === 400) {
          result.innerHTML = `<span class="status success">✅ 正しくエラーハンドリングされました</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="status error">❌ 期待しないレスポンス</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">❌ エラー</span>\n${error.message}`;
      }
    }

    // ページロード時にヘルスチェック
    window.addEventListener('load', () => {
      testHealth();
    });
  </script>
</body>
</html>

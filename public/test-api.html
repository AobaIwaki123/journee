<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 3 API ãƒ†ã‚¹ãƒˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
    }
    
    .test-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
    }
    
    .test-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #5568d3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      margin-bottom: 10px;
      resize: vertical;
    }
    
    .result-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 15px;
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status.loading {
      background: #fff3cd;
      color: #856404;
    }
    
    .streaming-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      margin-left: 8px;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ§ª Phase 3 API ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</h1>
      <p class="subtitle">Journee - AIçµ±åˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ</p>
    </div>

    <!-- Test 1: Health Check -->
    <div class="test-section">
      <h2>1ï¸âƒ£ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</h2>
      <div class="test-controls">
        <button onclick="testHealth()">å®Ÿè¡Œ</button>
      </div>
      <div id="health-result" class="result-box">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <!-- Test 2: Simple Chat -->
    <div class="test-section">
      <h2>2ï¸âƒ£ ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ£ãƒƒãƒˆï¼ˆéã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰</h2>
      <textarea id="simple-message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">ã“ã‚“ã«ã¡ã¯ã€AIã•ã‚“</textarea>
      <div class="test-controls">
        <button onclick="testSimpleChat()">é€ä¿¡</button>
      </div>
      <div id="simple-result" class="result-box">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <!-- Test 3: Travel Planning -->
    <div class="test-section">
      <h2>3ï¸âƒ£ æ—…è¡Œè¨ˆç”»ä½œæˆï¼ˆéã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰</h2>
      <textarea id="travel-message" placeholder="æ—…è¡Œã®å¸Œæœ›ã‚’å…¥åŠ›...">æ±äº¬ã§3æ—¥é–“ã®æ—…è¡Œè¨ˆç”»ã‚’ç«‹ã¦ãŸã„ã§ã™ã€‚æµ…è‰ã€ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ã€æ¸‹è°·ã‚’å›ã‚ŠãŸã„ã§ã™ã€‚</textarea>
      <div class="test-controls">
        <button onclick="testTravelPlanning()">é€ä¿¡</button>
      </div>
      <div id="travel-result" class="result-box">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <!-- Test 4: Streaming Chat -->
    <div class="test-section">
      <h2>4ï¸âƒ£ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆ</h2>
      <textarea id="stream-message" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">äº¬éƒ½ã§2æ—¥é–“ã®æ—…è¡Œè¨ˆç”»ã‚’ç«‹ã¦ãŸã„ã§ã™</textarea>
      <div class="test-controls">
        <button onclick="testStreamingChat()" id="stream-btn">é€ä¿¡ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰</button>
        <button onclick="stopStreaming()" id="stop-btn" disabled>åœæ­¢</button>
      </div>
      <div id="stream-result" class="result-box">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
      
      <!-- Stats -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="chunk-count">0</div>
          <div class="stat-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ£ãƒ³ã‚¯</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="char-count">0</div>
          <div class="stat-label">å—ä¿¡æ–‡å­—æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="time-elapsed">0s</div>
          <div class="stat-label">çµŒéæ™‚é–“</div>
        </div>
      </div>
    </div>

    <!-- Test 5: Error Handling -->
    <div class="test-section">
      <h2>5ï¸âƒ£ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</h2>
      <div class="test-controls">
        <button onclick="testEmptyMessage()">ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
        <button onclick="testInvalidRequest()">ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
      </div>
      <div id="error-result" class="result-box">çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
  </div>

  <script>
    let streamReader = null;
    let streamController = null;
    let startTime = 0;
    let timerInterval = null;

    // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    async function testHealth() {
      const result = document.getElementById('health-result');
      result.innerHTML = '<span class="status loading">å®Ÿè¡Œä¸­...</span>';
      
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        result.innerHTML = `<span class="status success">âœ… æˆåŠŸ</span>\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${error.message}`;
      }
    }

    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ£ãƒƒãƒˆ
    async function testSimpleChat() {
      const message = document.getElementById('simple-message').value;
      const result = document.getElementById('simple-result');
      
      result.innerHTML = '<span class="status loading">é€ä¿¡ä¸­...</span>';
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, stream: false })
        });
        
        const data = await response.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        
        if (response.ok) {
          result.innerHTML = `<span class="status success">âœ… æˆåŠŸ (${elapsed}ç§’)</span>\n\nã€AIã®å¿œç­”ã€‘\n${data.message}\n\nã€ç”Ÿãƒ‡ãƒ¼ã‚¿ã€‘\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${error.message}`;
      }
    }

    // æ—…è¡Œè¨ˆç”»ä½œæˆ
    async function testTravelPlanning() {
      const message = document.getElementById('travel-message').value;
      const result = document.getElementById('travel-result');
      
      result.innerHTML = '<span class="status loading">æ—…è¡Œè¨ˆç”»ã‚’ä½œæˆä¸­...</span>';
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, stream: false })
        });
        
        const data = await response.json();
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        
        if (response.ok) {
          let output = `<span class="status success">âœ… æˆåŠŸ (${elapsed}ç§’)</span>\n\n`;
          output += `ã€AIã®å¿œç­”ã€‘\n${data.message}\n\n`;
          
          if (data.itinerary) {
            output += `ã€ã—ãŠã‚Šæƒ…å ±ã€‘\n`;
            output += `ã‚¿ã‚¤ãƒˆãƒ«: ${data.itinerary.title}\n`;
            output += `ç›®çš„åœ°: ${data.itinerary.destination}\n`;
            output += `æœŸé–“: ${data.itinerary.startDate} ã€œ ${data.itinerary.endDate}\n`;
            output += `æ—¥æ•°: ${data.itinerary.schedule?.length || 0}æ—¥\n\n`;
            
            if (data.itinerary.schedule) {
              data.itinerary.schedule.forEach(day => {
                output += `\nã€${day.day}æ—¥ç›®ã€‘\n`;
                day.spots.forEach(spot => {
                  output += `  â€¢ ${spot.name} (${spot.scheduledTime || 'æ™‚é–“æœªå®š'})\n`;
                });
              });
            }
          }
          
          output += `\n\nã€ç”Ÿãƒ‡ãƒ¼ã‚¿ã€‘\n${JSON.stringify(data, null, 2)}`;
          result.innerHTML = output;
        } else {
          result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${error.message}`;
      }
    }

    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆ
    async function testStreamingChat() {
      const message = document.getElementById('stream-message').value;
      const result = document.getElementById('stream-result');
      const streamBtn = document.getElementById('stream-btn');
      const stopBtn = document.getElementById('stop-btn');
      
      // UIæ›´æ–°
      streamBtn.disabled = true;
      stopBtn.disabled = false;
      
      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
      let chunkCount = 0;
      let charCount = 0;
      startTime = Date.now();
      
      document.getElementById('chunk-count').textContent = '0';
      document.getElementById('char-count').textContent = '0';
      document.getElementById('time-elapsed').textContent = '0s';
      
      // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
      timerInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('time-elapsed').textContent = `${elapsed}s`;
      }, 100);
      
      result.innerHTML = '<span class="status loading">ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­<span class="streaming-indicator"></span></span>\n\n';
      let fullMessage = '';
      let itineraryReceived = false;
      
      try {
        streamController = new AbortController();
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, stream: true }),
          signal: streamController.signal
        });
        
        streamReader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
          const { done, value } = await streamReader.read();
          
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                
                if (data.type === 'message' && data.content) {
                  fullMessage += data.content;
                  charCount += data.content.length;
                  chunkCount++;
                  
                  // UIæ›´æ–°
                  document.getElementById('chunk-count').textContent = chunkCount;
                  document.getElementById('char-count').textContent = charCount;
                  
                  result.innerHTML = `<span class="status loading">ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­<span class="streaming-indicator"></span></span>\n\n${fullMessage}`;
                  result.scrollTop = result.scrollHeight;
                  
                } else if (data.type === 'itinerary') {
                  itineraryReceived = true;
                } else if (data.type === 'done') {
                  break;
                } else if (data.type === 'error') {
                  throw new Error(data.error);
                }
              } catch (e) {
                console.error('Parse error:', e);
              }
            }
          }
        }
        
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        result.innerHTML = `<span class="status success">âœ… å®Œäº† (${elapsed}ç§’)</span>\n\n${fullMessage}\n\n${itineraryReceived ? 'âœ… ã—ãŠã‚Šãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸ' : ''}`;
        
      } catch (error) {
        if (error.name === 'AbortError') {
          result.innerHTML = `<span class="status error">âš ï¸ åœæ­¢ã•ã‚Œã¾ã—ãŸ</span>\n\n${fullMessage}`;
        } else {
          result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${error.message}`;
        }
      } finally {
        clearInterval(timerInterval);
        streamBtn.disabled = false;
        stopBtn.disabled = true;
        streamReader = null;
        streamController = null;
      }
    }

    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°åœæ­¢
    function stopStreaming() {
      if (streamController) {
        streamController.abort();
      }
      if (timerInterval) {
        clearInterval(timerInterval);
      }
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ: ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    async function testEmptyMessage() {
      const result = document.getElementById('error-result');
      result.innerHTML = '<span class="status loading">ãƒ†ã‚¹ãƒˆä¸­...</span>';
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: '', stream: false })
        });
        
        const data = await response.json();
        
        if (response.status === 400) {
          result.innerHTML = `<span class="status success">âœ… æ­£ã—ãã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã¾ã—ãŸ</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="status error">âŒ æœŸå¾…ã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${error.message}`;
      }
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    async function testInvalidRequest() {
      const result = document.getElementById('error-result');
      result.innerHTML = '<span class="status loading">ãƒ†ã‚¹ãƒˆä¸­...</span>';
      
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stream: false }) // messageãŒãªã„
        });
        
        const data = await response.json();
        
        if (response.status === 400) {
          result.innerHTML = `<span class="status success">âœ… æ­£ã—ãã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã¾ã—ãŸ</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="status error">âŒ æœŸå¾…ã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹</span>\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status error">âŒ ã‚¨ãƒ©ãƒ¼</span>\n${error.message}`;
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    window.addEventListener('load', () => {
      testHealth();
    });
  </script>
</body>
</html>

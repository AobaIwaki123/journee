<!-- 0e7868ee-5a6f-4055-bb3a-bee03cbd8d4f aa38adfa-a4f7-48db-a391-bb6b08fffdab -->
# Gemini 2.5 FlashÂØæÂøú„Å®„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥DB‰øùÂ≠òÂÆüË£Ö - ÂÜçÊßãÊàêÁâà

## üìä ÂÆüË£ÖÁä∂Ê≥Å„Çµ„Éû„É™„Éº

### ‚úÖ ÂÆå‰∫Ü„Åó„Åü„Éï„Çß„Éº„Ç∫

| Phase | ÂÜÖÂÆπ | Áä∂ÊÖã |

|-------|------|------|

| Phase 1 | Gemini 2.5 Flash „É¢„Éá„É´ËøΩÂä† | ‚úÖ ÂÆå‰∫Ü |

| Phase 2 | DB„Çπ„Ç≠„Éº„ÉûÊõ¥Êñ∞ÔºàÊöóÂè∑ÂåñÂØæÂøúÔºâ | ‚úÖ ÂÆå‰∫Ü |

| Phase 3 | „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„É™„Éù„Ç∏„Éà„É™‰ΩúÊàê | ‚úÖ ÂÆå‰∫Ü |

| Phase 4 | „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÂ≠òAPI | ‚úÖ ÂÆå‰∫Ü |

| Phase 5 | „ÉÅ„É£„ÉÉ„ÉàAPIÁµ±ÂêàÔºàËá™Âãï‰øùÂ≠òÔºâ | ‚ö†Ô∏è 80%ÂÆå‰∫Ü |

### ‚ùå Êú™ÂÆüË£Ö„ÅÆ„Éï„Çß„Éº„Ç∫

| Phase | ÂÜÖÂÆπ | Áä∂ÊÖã | ÂÑ™ÂÖàÂ∫¶ |

|-------|------|------|--------|

| Phase 5 (ÊÆã„Çä) | „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÂ≠ò„Éê„Ç∞‰øÆÊ≠£ | ‚ùå Êú™ÂÆüË£Ö | üî¥ È´ò |

| Phase 6 | AI„Éó„É≠„É≥„Éó„ÉàÊîπÂñÑ„Å®„Éà„Éº„ÇØ„É≥ÁÆ°ÁêÜ | ‚ùå Êú™ÂÆüË£Ö | üî¥ È´ò |

| Phase 7 | „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÁµ±Âêà | ‚ùå Êú™ÂÆüË£Ö | üî¥ È´ò |

| Phase 8 | Áí∞Â¢ÉÂ§âÊï∞Ë®≠ÂÆö | ‚ö†Ô∏è ÈÉ®ÂàÜÁöÑ | üü° ‰∏≠ |

| Phase 9 | „ÉÜ„Çπ„Éà„Å®„Éâ„Ç≠„É•„É°„É≥„ÉàÊõ¥Êñ∞ | ‚ùå Êú™ÂÆüË£Ö | üü¢ ‰Ωé |

---

## üéØ ÊÆãÂÆüË£ÖÈ†ÖÁõÆ„ÅÆË©≥Á¥∞

## Phase 4: „É¶„Éº„Ç∂„Éº„Å´„Çà„ÇãËøΩÂä†Ë™≤È°å„ÅÆ„Åü„ÇÅÊÉÖÂ†±„ÅåÂ∞ë„Å™„ÅÑË™≤È°å

- „ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆ„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ„ÅåÊ¨≤„Åó„ÅÑ
- ÁêÜÁî±: ‰ªäÂõû„ÅÆÂ§âÊõ¥„Å´„Çà„Çä‰ºöË©±Â±•Ê≠¥„ÅåÂÖ®„Å¶ÈÄÅ„Çâ„Çå„Çã„Çà„ÅÜ„Å´„Å™„Å£„Å¶„Åó„Åæ„ÅÜ„Åü„ÇÅ„ÄÅ‰∏çË¶Å„Å™Â±•Ê≠¥„ÅØÂâäÈô§„Åß„Åç„ÇãÊñπ„Åå„É¶„Éº„Ç∂„Éº‰ΩìÈ®ì„ÅåËâØ„ÅÑ
- ‰ªïÊßò
  - ÂâäÈô§„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅUI‰∏ä„Åä„Çà„Å≥ÂÜÖÈÉ®ÁöÑ„Å™„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÊåÅÊÉÖÂ†±„ÇÇÂâäÈô§„Åï„Çå„ÄÅÊ¨°„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°ÊôÇ„Å´Á¢∫ÂÆü„Å´‰Ωï„ÇÇ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Åå„Å™„ÅÑÁä∂ÊÖã„Åß‰ºöË©±„ÇíÂßã„ÇÅ„Çâ„Çå„Çã
  - ‰ΩÜ„Åó„ÄÅ„Åô„Åß„Å´DB„Å´‰øùÂ≠ò„Åï„Çå„Å¶„Åó„Åæ„Å£„Åü„ÉÅ„É£„ÉÉ„Éà„Åæ„ÅßÂâäÈô§„Åô„ÇãÂøÖË¶Å„ÅØ„Å™„ÅÑ„ÄÇUI‰∏ä„Åã„ÇâÂâäÈô§„Åï„Çå„ÄÅ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Å´Ëºâ„Çâ„Å™„ÅÑ„Åì„Å®„Åå‰Ωï„Çà„Çä„ÇÇÈáçË¶Å
- „É¨„Ç§„Ç¢„Ç¶„Éà
  - „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂè≥‰∏ã„Å´„Éõ„Éê„Éº„Åï„Åõ„Çã

### Phase 5ÔºàÊÆã„ÇäÔºâ: „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÂ≠òÂïèÈ°å„ÅÆ‰øÆÊ≠£

**ÁèæÁä∂:**

- `app/api/itinerary/load/route.ts` „ÅØ„ÄÅ„Åó„Åä„Çä„Éá„Éº„Çø„ÅÆ„Åø„ÇíËøî„Åó„Å¶„ÅÑ„Çã
- „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅØÂèñÂæó„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ
- üö® **ÈáçÂ§ß„Å™ÂïèÈ°å**: „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå‰øùÂ≠ò„Åï„Çå„Å™„ÅÑÔºà„Åó„Åä„ÇäID„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ

**„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÂ≠òÂïèÈ°å„ÅÆË©≥Á¥∞:**

#### ÂïèÈ°å„ÅÆÂéüÂõ†
`app/api/chat/route.ts` (Ë°å272, 325, 420, 536) „Åß„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„Åß„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí‰øùÂ≠ò:

```typescript
if (updatedItinerary?.id) {
  await saveMessage(updatedItinerary.id, { ... });
}
```

**ÂïèÈ°åÁÇπ:**
- „ÉÅ„É£„ÉÉ„ÉàÈñãÂßãÊôÇ„ÄÅ„Åó„Åä„Çä„ÅØ„Åæ„Å†‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ
- `currentItinerary.id` „Åå `undefined`
- ‚Üí `saveMessage()` „ÅåÂëº„Å∞„Çå„Åö„ÄÅ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå‰øùÂ≠ò„Åï„Çå„Å™„ÅÑ

**ÂøÖË¶Å„Å™ÂÆüË£Ö:**

#### 5.1 „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÂ≠ò„ÅÆ‰øÆÊ≠£Ôºà„ÉÅ„É£„ÉÉ„ÉàAPIÂÅ¥Ôºâ

**„Éï„Ç°„Ç§„É´:** `app/api/chat/route.ts`

```typescript
// Ë°å272, 325, 420, 536 „ÅÆsaveMessageÂëº„Å≥Âá∫„ÅóÈÉ®ÂàÜ„Çí‰øÆÊ≠£

// ‚ùå ÁèæÂú®Ôºà„Ç®„É©„Éº„ÅåÊè°„Çä„Å§„Å∂„Åï„Çå„Çã + „Åó„Åä„ÇäID„Åå„Å™„ÅÑ„Å®‰øùÂ≠ò„Åï„Çå„Å™„ÅÑÔºâ
if (updatedItinerary?.id) {
  await saveMessage(updatedItinerary.id, { ... });
}

// ‚úÖ ÊîπÂñÑÔºà„Ç®„É©„Éº„É≠„Ç∞ËøΩÂä† + ID‰∏çÂú®ÊôÇ„ÅÆË≠¶ÂëäÔºâ
if (updatedItinerary?.id) {
  const saveResult = await saveMessage(updatedItinerary.id, {
    role: 'user',
    content: message,
    timestamp: new Date(),
  });

  if (!saveResult.success) {
    console.error('Failed to save user message:', saveResult.error);
  }
} else {
  console.warn('Itinerary ID not found. Chat history will be saved on itinerary save.');
}
```

#### 5.2 Zustand„Çπ„Éà„Ç¢„Å´‰∏ÄÊôÇ‰øùÂ≠ò„Éï„É©„Ç∞„ÇíËøΩÂä†

**„Éï„Ç°„Ç§„É´:** `lib/store/useStore.ts`

```typescript
interface AppState {
  // ... Êó¢Â≠ò„ÅÆÂÆöÁæ© ...

  // ËøΩÂä†: „Åó„Åä„Çä„Åå„Åæ„Å†Êú™‰øùÂ≠ò„Åã„Å©„ÅÜ„Åã
  isItineraryUnsaved: boolean;
  setItineraryUnsaved: (unsaved: boolean) => void;
}

export const useStore = create<AppState>((set, get) => ({
  // ...
  isItineraryUnsaved: true, // ÂàùÊúüÁä∂ÊÖã„ÅØÊú™‰øùÂ≠ò
  setItineraryUnsaved: (unsaved) => set({ isItineraryUnsaved: unsaved }),
}));
```

#### 5.3 „Åó„Åä„Çä‰øùÂ≠òÊôÇ„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇÇ‰∏ÄÊã¨‰øùÂ≠ò

**„Éï„Ç°„Ç§„É´:** `components/itinerary/SaveButton.tsx` „Åæ„Åü„ÅØ `lib/utils/api-client.ts`

```typescript
// „Åó„Åä„Çä„Çí‰øùÂ≠ò„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
export async function saveItineraryWithChatHistory(
  itinerary: ItineraryData,
  messages: Message[]
): Promise<ItineraryData> {
  const isFirstSave = !itinerary.id;

  // 1. „Åó„Åä„Çä„Çí‰øùÂ≠ò
  const response = await fetch('/api/itinerary/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(itinerary),
  });

  if (!response.ok) {
    throw new Error('Failed to save itinerary');
  }

  const savedItinerary = await response.json();

  // 2. ÂàùÂõû‰øùÂ≠ò„ÅÆÂ†¥Âêà„ÄÅ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇÇ‰∏ÄÊã¨‰øùÂ≠ò
  if (isFirstSave && messages.length > 0) {
    const chatHistoryResponse = await fetch('/api/chat/history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        itineraryId: savedItinerary.id,
        messages,
      }),
    });

    if (!chatHistoryResponse.ok) {
      console.error('Failed to save chat history');
    }

    // ‰øùÂ≠ò„Éï„É©„Ç∞„ÇíÊõ¥Êñ∞
    useStore.getState().setItineraryUnsaved(false);
  }

  return savedItinerary;
}
```

#### 5.4 SaveButton„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆÊõ¥Êñ∞

**„Éï„Ç°„Ç§„É´:** `components/itinerary/SaveButton.tsx`

```typescript
const handleSave = async () => {
  const { currentItinerary, messages } = useStore.getState();

  if (!currentItinerary) return;

  setLoading(true);
  try {
    // ‚úÖ „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇÇ‰∏ÄÁ∑í„Å´‰øùÂ≠ò
    const savedItinerary = await saveItineraryWithChatHistory(
      currentItinerary,
      messages
    );

    // „Çπ„Éà„Ç¢„ÇíÊõ¥Êñ∞
    useStore.getState().setItinerary(savedItinerary);

    showToast('„Åó„Åä„Çä„Å®„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
  } catch (error) {
    console.error('Save error:', error);
    showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
  } finally {
    setLoading(false);
  }
};
```

**ÂÑ™ÂÖàÂ∫¶:** üî¥ È´òÔºà„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÁµ±Âêà„Å´ÂøÖÈ†à„ÄÅ„Åã„Å§ÁèæÂú®„ÅÆ„Éê„Ç∞‰øÆÊ≠£Ôºâ

**„Éá„Éê„ÉÉ„Ç∞„Ç¨„Ç§„ÉâÂèÇÁÖß:** `.cursor/plans/chat-history-debug-guide.md` „Å´Ë©≥Á¥∞„Å™„Éá„Éê„ÉÉ„Ç∞ÊâãÈ†Ü„ÇíË®òËºâ

---

### Phase 6: AI„Éó„É≠„É≥„Éó„ÉàÊîπÂñÑ„Å®„Éà„Éº„ÇØ„É≥ÁÆ°ÁêÜ - ÂÆåÂÖ®Êú™ÂÆüË£Ö

**ÁèæÁä∂:**

- `lib/ai/gemini.ts`: `.slice(-10)` „ÅßÊúÄÊñ∞10‰ª∂„ÅÆ„ÅøÈÄÅ‰ø°
- `lib/ai/claude.ts`: `.slice(-10)` „ÅßÊúÄÊñ∞10‰ª∂„ÅÆ„ÅøÈÄÅ‰ø°
- „Éà„Éº„ÇØ„É≥ÁÆ°ÁêÜ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ
- Ëá™ÂãïË¶ÅÁ¥ÑÊ©üËÉΩ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ

**ÂøÖË¶Å„Å™ÂÆüË£Ö:**

#### 6.1 „Éà„Éº„ÇØ„É≥ÁÆ°ÁêÜ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `lib/ai/token-manager.ts`

```typescript
import type { Message } from '@/types/chat';

/**
 * „Éà„Éº„ÇØ„É≥Êï∞„ÅÆÊé®ÂÆöÔºàGPT-3/4„ÅÆ„Éà„Éº„ÇØ„Éä„Ç§„Ç∂„ÉºÁõ∏ÂΩìÔºâ
 * Êó•Êú¨Ë™û: Á¥Ñ1ÊñáÂ≠ó=2„Éà„Éº„ÇØ„É≥
 * Ëã±Ë™û: Á¥Ñ1ÂçòË™û=1.3„Éà„Éº„ÇØ„É≥
 */
export function estimateTokens(text: string): number {
  // Á∞°ÊòìÊé®ÂÆö: ÊñáÂ≠óÊï∞ * 2ÔºàÊó•Êú¨Ë™û„ÅåÂ§ö„ÅÑÊÉ≥ÂÆöÔºâ
  return Math.ceil(text.length * 2);
}

/**
 * „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÁ∑è„Éà„Éº„ÇØ„É≥Êï∞„ÇíË®àÁÆó
 */
export function calculateTotalTokens(messages: Message[]): number {
  return messages.reduce((total, msg) => {
    return total + estimateTokens(msg.content);
  }, 0);
}

/**
 * „Éà„Éº„ÇØ„É≥Âà∂ÈôêÂÜÖ„Å´Âèé„ÇÅ„Çã
 * Gemini: 100‰∏á„Éà„Éº„ÇØ„É≥
 * Claude: 20‰∏á„Éà„Éº„ÇØ„É≥
 */
export function limitChatHistoryByTokens(
  messages: Message[],
  maxTokens: number = 100000 // „Éá„Éï„Ç©„É´„Éà: 10‰∏á„Éà„Éº„ÇØ„É≥
): Message[] {
  const result: Message[] = [];
  let currentTokens = 0;

  // ÊúÄÊñ∞„É°„ÉÉ„Çª„Éº„Ç∏„Åã„ÇâÈÄÜÈ†Ü„ÅßËøΩÂä†
  for (let i = messages.length - 1; i >= 0; i--) {
    const msg = messages[i];
    const msgTokens = estimateTokens(msg.content);

    if (currentTokens + msgTokens > maxTokens) {
      break; // „Éà„Éº„ÇØ„É≥Âà∂Èôê„Å´ÈÅî„Åó„Åü„ÇâÁµÇ‰∫Ü
    }

    result.unshift(msg);
    currentTokens += msgTokens;
  }

  return result;
}

/**
 * Ë¶ÅÁ¥Ñ„ÅåÂøÖË¶Å„ÅãÂà§ÂÆöÔºàÈñæÂÄ§: 5‰∏á„Éà„Éº„ÇØ„É≥Ôºâ
 */
export function shouldSummarize(messages: Message[]): boolean {
  const totalTokens = calculateTotalTokens(messages);
  return totalTokens > 50000;
}

/**
 * Ë¶ÅÁ¥ÑÂØæË±°„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÁØÑÂõ≤„ÇíÊ±∫ÂÆö
 * - ÊúÄÊñ∞10‰ª∂„ÅØÊÆã„Åô
 * - „Åù„Çå„Çà„ÇäÂâç„ÇíË¶ÅÁ¥ÑÂØæË±°„Å®„Åô„Çã
 */
export function getSummaryRange(messages: Message[]): { start: number; end: number } {
  if (messages.length <= 10) {
    return { start: 0, end: 0 }; // Ë¶ÅÁ¥Ñ‰∏çË¶Å
  }

  return {
    start: 0,
    end: messages.length - 10, // ÊúÄÊñ∞10‰ª∂„ÇíÈô§„Åè
  };
}
```

#### 6.2 Ëá™ÂãïË¶ÅÁ¥ÑÊ©üËÉΩ

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `lib/ai/summarizer.ts`

```typescript
import type { Message } from '@/types/chat';
import type { AIModelId } from '@/types/ai';
import { GeminiClient } from './gemini';
import { ClaudeClient } from './claude';

/**
 * Ë¶ÅÁ¥ÑÂ∞ÇÁî®„Éó„É≠„É≥„Éó„Éà
 * ÊÉÖÂ†±Ê¨†ËêΩ„ÇíÊúÄÂ∞èÂåñ„Åô„Çã„Åü„ÇÅ„ÄÅ‰ª•‰∏ã„Çí‰øùÊåÅ:
 * 1. „É¶„Éº„Ç∂„Éº„ÅÆË¶ÅÊúõ„Å®Âà∂Á¥ÑÊù°‰ª∂
 * 2. Êó¢„Å´Ê±∫ÂÆö„Åó„ÅüÂÜÖÂÆπ
 * 3. ÈáçË¶Å„Å™ÊèêÊ°à„Å®„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
 * 4. ÊñáËÑàÊÉÖÂ†±ÔºàË®àÁîªÊÆµÈöé„ÄÅÈÄ≤ÊçóÁä∂Ê≥ÅÔºâ
 */
const SUMMARY_PROMPT = `‰ª•‰∏ã„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

**Ë¶ÅÁ¥ÑÊôÇ„Å´ÂøÖ„ÅöÂê´„ÇÅ„ÇãÊÉÖÂ†±:**
1. **ÊóÖË°å„ÅÆÂü∫Êú¨ÊÉÖÂ†±**: ÁõÆÁöÑÂú∞„ÄÅÊúüÈñì„ÄÅ‰∫àÁÆó„ÄÅ‰∫∫Êï∞
2. **„É¶„Éº„Ç∂„Éº„ÅÆË¶ÅÊúõ„Å®Âà∂Á¥Ñ**: ÁâπÂà•„Å™„É™„ÇØ„Ç®„Çπ„Éà„ÄÅÈÅø„Åë„Åü„ÅÑ„Åì„Å®„ÄÅÂ•Ω„Åø
3. **Êó¢„Å´Ê±∫ÂÆö„Åó„ÅüÂÜÖÂÆπ**: Á¢∫ÂÆö„Åó„ÅüÊóÖË°åÂÖà„ÄÅÊó•Á®ã„ÄÅË¶≥ÂÖâ„Çπ„Éù„ÉÉ„Éà„ÄÅÂÆøÊ≥äÊñΩË®≠
4. **ÈáçË¶Å„Å™ÊèêÊ°à„Å®„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ**: AI„ÅåÊèêÊ°à„Åó„Å¶„É¶„Éº„Ç∂„Éº„ÅåÊ∞ó„Å´ÂÖ•„Å£„ÅüÂÜÖÂÆπ„ÄÅÂç¥‰∏ã„Åï„Çå„ÅüÊèêÊ°à„Å®„Åù„ÅÆÁêÜÁî±
5. **ÁèæÂú®„ÅÆË®àÁîªÊÆµÈöé**: „Å©„ÅÆÊÆµÈöé„Åæ„ÅßÈÄ≤„Çì„Åß„ÅÑ„Çã„ÅãÔºàÊÉÖÂ†±ÂèéÈõÜ‰∏≠„ÄÅÈ™®ÁµÑ„Åø‰ΩúÊàê‰∏≠„ÄÅË©≥Á¥∞Âåñ‰∏≠„Å™„Å©Ôºâ

**Ë¶ÅÁ¥ÑÂΩ¢Âºè:**
- Á∞°ÊΩî„Åã„Å§ÂÖ∑‰ΩìÁöÑ„Å´
- ÁÆáÊù°Êõ∏„Åç„ÅßÊßãÈÄ†Âåñ
- ÈáçË¶Å„Å™Êï∞ÂÄ§„ÇÑÂõ∫ÊúâÂêçË©û„ÅØÁúÅÁï•„Åó„Å™„ÅÑ
- ÊôÇÁ≥ªÂàó„Çí‰øùÊåÅ

**„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥:**
`;

/**
 * „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíË¶ÅÁ¥Ñ
 * Gemini FlashÔºàÈ´òÈÄü„Éª‰Ωé„Ç≥„Çπ„ÉàÔºâ„Çí‰ΩøÁî®
 */
export async function summarizeChatHistory(
  messages: Message[],
  modelId: AIModelId = 'gemini-flash',
  claudeApiKey?: string
): Promise<string> {
  // Ë¶ÅÁ¥ÑÂØæË±°„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÉÜ„Ç≠„Çπ„Éà„Å´Â§âÊèõ
  const chatText = messages
    .map((msg) => `${msg.role === 'user' ? '„É¶„Éº„Ç∂„Éº' : 'AI'}: ${msg.content}`)
    .join('\n\n');

  const prompt = `${SUMMARY_PROMPT}\n\n${chatText}`;

  try {
    if (modelId === 'claude' && claudeApiKey) {
      // Claude‰ΩøÁî®
      const claude = new ClaudeClient(claudeApiKey);
      const response = await claude.chat(prompt, []);
      return response.message;
    } else {
      // Gemini Flash‰ΩøÁî®Ôºà„Éá„Éï„Ç©„É´„ÉàÔºâ
      const gemini = new GeminiClient('gemini-flash');
      const response = await gemini.chat(prompt, []);
      return response.message;
    }
  } catch (error) {
    console.error('Summarization error:', error);
    // „Ç®„É©„ÉºÊôÇ„ÅØÁ∞°ÊòìË¶ÅÁ¥Ñ„ÇíËøî„Åô
    return `ÈÅéÂéª„ÅÆ‰ºöË©±Ôºà${messages.length}‰ª∂Ôºâ„ÅåË¶ÅÁ¥Ñ„Åï„Çå„Åæ„Åó„Åü„ÄÇË©≥Á¥∞„ÅØÁúÅÁï•„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ`;
  }
}

/**
 * Ë¶ÅÁ¥ÑÁµêÊûú„Çíassistant„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Åó„Å¶ÁîüÊàê
 */
export function createSummaryMessage(summary: string): Message {
  return {
    id: `summary-${Date.now()}`,
    role: 'assistant',
    content: `üìù **ÈÅéÂéª„ÅÆ‰ºöË©±„ÅÆË¶ÅÁ¥Ñ**\n\n${summary}`,
    timestamp: new Date(),
  };
}
```

#### 6.3 „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂúßÁ∏Æ

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `lib/ai/chat-compressor.ts`

```typescript
import type { Message } from '@/types/chat';
import type { AIModelId } from '@/types/ai';
import { shouldSummarize, getSummaryRange, calculateTotalTokens } from './token-manager';
import { summarizeChatHistory, createSummaryMessage } from './summarizer';

/**
 * „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂúßÁ∏ÆÔºàË¶ÅÁ¥ÑÔºâ
 * 
 * Âãï‰Ωú:
 * 1. „Éà„Éº„ÇØ„É≥Êï∞„ÅåÈñæÂÄ§Ôºà5‰∏áÔºâ„ÇíË∂Ö„Åà„Åü„ÇâË¶ÅÁ¥Ñ„Éà„É™„Ç¨„Éº
 * 2. ÊúÄÊñ∞N‰ª∂Ôºà10‰ª∂Ôºâ„ÇíÊÆã„Åó„ÄÅ„Åù„Çå„Çà„ÇäÂâç„ÇíË¶ÅÁ¥Ñ
 * 3. Ë¶ÅÁ¥ÑÁµêÊûú„Çí1„Å§„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å´ÂúßÁ∏Æ
 * 4. [Ë¶ÅÁ¥Ñ„É°„ÉÉ„Çª„Éº„Ç∏, ÊúÄÊñ∞N‰ª∂] „ÅÆÊßãÊàê„ÅßËøî„Åô
 */
export async function compressChatHistory(
  messages: Message[],
  modelId: AIModelId,
  claudeApiKey?: string
): Promise<{ compressed: Message[]; didCompress: boolean }> {
  // Ë¶ÅÁ¥Ñ„ÅåÂøÖË¶Å„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  if (!shouldSummarize(messages)) {
    return { compressed: messages, didCompress: false };
  }

  // Ë¶ÅÁ¥ÑÂØæË±°ÁØÑÂõ≤„ÇíÂèñÂæó
  const { start, end } = getSummaryRange(messages);

  if (end <= start) {
    return { compressed: messages, didCompress: false };
  }

  try {
    // Ë¶ÅÁ¥ÑÂØæË±°„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
    const toSummarize = messages.slice(start, end);
    const recentMessages = messages.slice(end);

    console.log(`Summarizing ${toSummarize.length} messages (keeping ${recentMessages.length} recent)`);

    // Ë¶ÅÁ¥ÑÂÆüË°å
    const summary = await summarizeChatHistory(toSummarize, modelId, claudeApiKey);
    const summaryMessage = createSummaryMessage(summary);

    // ÂúßÁ∏ÆÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éà
    const compressed = [summaryMessage, ...recentMessages];

    console.log(`Compression complete. Total tokens: ${calculateTotalTokens(messages)} ‚Üí ${calculateTotalTokens(compressed)}`);

    return { compressed, didCompress: true };
  } catch (error) {
    console.error('Compression failed:', error);
    // „Ç®„É©„ÉºÊôÇ„ÅØÂúßÁ∏Æ„Åõ„Åö„Å´Ëøî„Åô
    return { compressed: messages, didCompress: false };
  }
}
```

#### 6.4 Gemini„Å®Claude„ÅÆÊõ¥Êñ∞

**„Éï„Ç°„Ç§„É´:** `lib/ai/gemini.ts`

```typescript
import { limitChatHistoryByTokens } from './token-manager';

// buildPrompt „É°„ÇΩ„ÉÉ„ÉâÂÜÖ
private buildPrompt(
  userMessage: string,
  chatHistory: ChatMessage[],
  currentItinerary?: ItineraryData,
  planningPhase: ItineraryPhase = 'initial',
  currentDetailingDay?: number | null
): string {
  // ...

  // ‚ùå ÂâäÈô§: chatHistory.slice(-10)
  // ‚úÖ Â§âÊõ¥: „Éà„Éº„ÇØ„É≥Âà∂ÈôêÂÜÖ„ÅÆÂÖ®Â±•Ê≠¥„ÇíÈÄÅ‰ø°
  if (chatHistory.length > 0) {
    const limitedHistory = limitChatHistoryByTokens(chatHistory, 100000); // Gemini: 10‰∏á„Éà„Éº„ÇØ„É≥
    const historyText = formatChatHistory(
      limitedHistory.map((msg) => ({
        role: msg.role,
        content: msg.content,
      }))
    );
    prompt += `## ‰ºöË©±Â±•Ê≠¥\n${historyText}\n\n`;
  }

  // ...
}
```

**„Éï„Ç°„Ç§„É´:** `lib/ai/claude.ts`

```typescript
import { limitChatHistoryByTokens } from './token-manager';

// buildPrompt „É°„ÇΩ„ÉÉ„ÉâÂÜÖ
private buildPrompt(
  userMessage: string,
  chatHistory: ChatMessage[],
  currentItinerary?: ItineraryData
): { systemPrompt: string; userPrompt: string } {
  // ...

  // ‚ùå ÂâäÈô§: chatHistory.slice(-10)
  // ‚úÖ Â§âÊõ¥: „Éà„Éº„ÇØ„É≥Âà∂ÈôêÂÜÖ„ÅÆÂÖ®Â±•Ê≠¥„ÇíÈÄÅ‰ø°
  if (chatHistory.length > 0) {
    const limitedHistory = limitChatHistoryByTokens(chatHistory, 50000); // Claude: 5‰∏á„Éà„Éº„ÇØ„É≥
    const historyText = formatChatHistory(
      limitedHistory.map((msg) => ({
        role: msg.role,
        content: msg.content,
      }))
    );
    userPrompt += `## ‰ºöË©±Â±•Ê≠¥\n${historyText}\n\n`;
  }

  // ...
}
```

**ÂÑ™ÂÖàÂ∫¶:** üî¥ È´òÔºà‰ºöË©±„ÅÆÊñáËÑà‰øùÊåÅ„Å´ÈáçË¶ÅÔºâ

---

### Phase 7: „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÁµ±Âêà - ÂÆåÂÖ®Êú™ÂÆüË£Ö

**ÁèæÁä∂:**

- Zustand„Çπ„Éà„Ç¢„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆËá™Âãï‰øùÂ≠ò„ÉªÂæ©ÂÖÉ„É≠„Ç∏„ÉÉ„ÇØ„Åå„Å™„ÅÑ
- „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Ââç„ÅÆËá™ÂãïÂúßÁ∏Æ„Åå„Å™„ÅÑ

**ÂøÖË¶Å„Å™ÂÆüË£Ö:**

#### 7.1 Zustand„Çπ„Éà„Ç¢„ÅÆÊã°Âºµ

**„Éï„Ç°„Ç§„É´:** `lib/store/useStore.ts`

```typescript
// AppState „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„Å´ËøΩÂä†
interface AppState {
  // ... Êó¢Â≠ò„ÅÆÂÆöÁæ© ...

  // ‚úÖ ËøΩÂä†: „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥DBÁµ±Âêà
  loadChatHistory: (itineraryId: string) => Promise<void>;
  saveChatHistoryToDb: (itineraryId: string) => Promise<boolean>;
  compressAndSaveChatHistory: (itineraryId: string) => Promise<void>;
}

// useStore ÂÆüË£Ö„Å´ËøΩÂä†
export const useStore = create<AppState>((set, get) => ({
  // ... Êó¢Â≠ò„ÅÆÂÆüË£Ö ...

  // ‚úÖ „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø
  loadChatHistory: async (itineraryId: string) => {
    try {
      const response = await fetch(`/api/chat/history?itineraryId=${itineraryId}`);
      
      if (!response.ok) {
        console.error('Failed to load chat history');
        return;
      }

      const data = await response.json();
      
      if (data.success && data.messages) {
        // „É°„ÉÉ„Çª„Éº„Ç∏„Çí„Çπ„Éà„Ç¢„Å´Ë®≠ÂÆö
        set({ messages: data.messages });
      }
    } catch (error) {
      console.error('Load chat history error:', error);
    }
  },

  // ‚úÖ „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò
  saveChatHistoryToDb: async (itineraryId: string) => {
    const { messages } = get();
    
    if (!itineraryId || messages.length === 0) {
      return false;
    }

    try {
      const response = await fetch('/api/chat/history', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          itineraryId,
          messages,
        }),
      });

      return response.ok;
    } catch (error) {
      console.error('Save chat history error:', error);
      return false;
    }
  },

  // ‚úÖ „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂúßÁ∏Æ„Å®‰øùÂ≠ò
  compressAndSaveChatHistory: async (itineraryId: string) => {
    const { messages, selectedAI, claudeApiKey } = get();

    // „Éà„Éº„ÇØ„É≥Êï∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    if (messages.length < 20) {
      // „É°„ÉÉ„Çª„Éº„Ç∏Êï∞„ÅåÂ∞ë„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
      return;
    }

    try {
      // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„ÅßÂúßÁ∏ÆAPI„ÇíÂëº„Å≥Âá∫„Åó
      const response = await fetch('/api/chat/compress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages,
          modelId: selectedAI,
          claudeApiKey,
        }),
      });

      if (response.ok) {
        const data = await response.json();
        
        if (data.didCompress && data.compressed) {
          // ÂúßÁ∏Æ„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏„Åß„Çπ„Éà„Ç¢„ÇíÊõ¥Êñ∞
          set({ messages: data.compressed });

          // DB„Å´‰øùÂ≠ò
          await get().saveChatHistoryToDb(itineraryId);

          // „É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•
          get().addToast('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅåÈï∑„Åè„Å™„Å£„Åü„Åü„ÇÅ„ÄÅËá™ÂãïÁöÑ„Å´Ë¶ÅÁ¥Ñ„Åï„Çå„Åæ„Åó„Åü', 'info');
        }
      }
    } catch (error) {
      console.error('Compress chat history error:', error);
    }
  },
}));
```

#### 7.3 „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Ââç„ÅÆËá™ÂãïÂúßÁ∏Æ

**„Éï„Ç°„Ç§„É´:** `components/chat/MessageInput.tsx`

```typescript
const handleSend = async () => {
  const { 
    currentItinerary, 
    compressAndSaveChatHistory, 
    messages 
  } = useStore.getState();

  if (!currentItinerary?.id) return;

  // ‚úÖ ËøΩÂä†: ÈÄÅ‰ø°Ââç„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂúßÁ∏ÆÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
  if (messages.length > 20) {
    await compressAndSaveChatHistory(currentItinerary.id);
  }

  // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Âá¶ÁêÜ
  // ...
};
```

#### 7.4 „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂúßÁ∏ÆAPI

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `app/api/chat/compress/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getCurrentUser } from '@/lib/auth/session';
import { compressChatHistory } from '@/lib/ai/chat-compressor';

export async function POST(req: NextRequest) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { messages, modelId, claudeApiKey } = await req.json();

    // ÂúßÁ∏ÆÂÆüË°å
    const result = await compressChatHistory(messages, modelId, claudeApiKey);

    return NextResponse.json(result);
  } catch (error) {
    console.error('Compress chat history error:', error);
    return NextResponse.json(
      { error: 'Failed to compress chat history' },
      { status: 500 }
    );
  }
}
```

**ÂÑ™ÂÖàÂ∫¶:** üî¥ È´òÔºà„É¶„Éº„Ç∂„Éº‰ΩìÈ®ì„Å´Áõ¥ÁµêÔºâ

---

### Phase 8: Áí∞Â¢ÉÂ§âÊï∞Ë®≠ÂÆö - ÈÉ®ÂàÜÁöÑÂÆå‰∫Ü

**ÁèæÁä∂:**

- `lib/db/chat-repository.ts` „Åß `CHAT_ENCRYPTION_KEY` „Åæ„Åü„ÅØ `NEXTAUTH_SECRET` „Çí‰ΩøÁî®
- `.env.example` „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ

**ÂøÖË¶Å„Å™ÂÆüË£Ö:**

#### 8.1 .env.example ‰ΩúÊàê

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `.env.example`

```bash
# .env.example - Áí∞Â¢ÉÂ§âÊï∞„ÉÜ„É≥„Éó„É¨„Éº„Éà

# =========================================
# Ë™çË®ºÔºàNextAuth.jsÔºâ
# =========================================
NEXTAUTH_SECRET=your-nextauth-secret-here
NEXTAUTH_URL=http://localhost:3000

GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# =========================================
# AI API
# =========================================
GEMINI_API_KEY=your-gemini-api-key

# =========================================
# „Éá„Éº„Çø„Éô„Éº„ÇπÔºàSupabaseÔºâ
# =========================================
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key

# =========================================
# „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÊöóÂè∑Âåñ
# =========================================
# „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÊöóÂè∑Âåñ„Ç≠„ÉºÔºàÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØNEXTAUTH_SECRET„Çí‰ΩøÁî®Ôºâ
# Êé®Â•®: openssl rand -base64 32
CHAT_ENCRYPTION_KEY=${NEXTAUTH_SECRET}

# =========================================
# „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
# =========================================
NODE_ENV=development
LOG_LEVEL=debug
```

**ÂÑ™ÂÖàÂ∫¶:** üü° ‰∏≠Ôºà„Éâ„Ç≠„É•„É°„É≥„ÉàÊï¥ÂÇôÔºâ

---

### Phase 9: „ÉÜ„Çπ„Éà„Å®„Éâ„Ç≠„É•„É°„É≥„ÉàÊõ¥Êñ∞ - ÂÆåÂÖ®Êú™ÂÆüË£Ö

**ÂøÖË¶Å„Å™ÂÆüË£Ö:**

#### 9.1 E2E„ÉÜ„Çπ„Éà

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `e2e/chat-history-db.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥DB‰øùÂ≠ò', () => {
  test('„É°„ÉÉ„Çª„Éº„Ç∏„ÅåDB„Å´‰øùÂ≠ò„Åï„Çå„Çã', async ({ page }) => {
    // „ÉÜ„Çπ„Éà„É≠„Ç∏„ÉÉ„ÇØ
  });

  test('„Åó„Åä„ÇäË™≠„ÅøËæº„ÅøÊôÇ„Å´Â±•Ê≠¥„ÅåÂæ©ÂÖÉ„Åï„Çå„Çã', async ({ page }) => {
    // „ÉÜ„Çπ„Éà„É≠„Ç∏„ÉÉ„ÇØ
  });

  test('„É¢„Éá„É´Âàá„ÇäÊõø„ÅàÊôÇ„ÇÇÂ±•Ê≠¥„Åå‰øùÊåÅ„Åï„Çå„Çã', async ({ page }) => {
    // „ÉÜ„Çπ„Éà„É≠„Ç∏„ÉÉ„ÇØ
  });
});
```

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `e2e/chat-auto-summary.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥Ëá™ÂãïË¶ÅÁ¥Ñ', () => {
  test('„Éà„Éº„ÇØ„É≥ÈñæÂÄ§Ë∂ÖÈÅéÊôÇ„Å´Ëá™ÂãïË¶ÅÁ¥Ñ„ÅåÂÆüË°å„Åï„Çå„Çã', async ({ page }) => {
    // „ÉÜ„Çπ„Éà„É≠„Ç∏„ÉÉ„ÇØ
  });

  test('Ë¶ÅÁ¥ÑÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„ÅåÂâäÊ∏õ„Åï„Çå„Çã', async ({ page }) => {
    // „ÉÜ„Çπ„Éà„É≠„Ç∏„ÉÉ„ÇØ
  });

  test('Ë¶ÅÁ¥ÑÂÜÖÂÆπ„ÅåÂ¶•ÂΩì„Åß„ÅÇ„Çã', async ({ page }) => {
    // „ÉÜ„Çπ„Éà„É≠„Ç∏„ÉÉ„ÇØ
  });
});
```

#### 9.2 „Éâ„Ç≠„É•„É°„É≥„Éà‰ΩúÊàê

**Êñ∞Ë¶è„Éï„Ç°„Ç§„É´:** `docs/CHAT_HISTORY.md`

```markdown
# „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÁÆ°ÁêÜ

## Ê¶ÇË¶Å
„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí„Åó„Åä„Çä„Å´Á¥ê„Å•„Åë„Å¶Supabase„Å´‰øùÂ≠ò„Åó„ÄÅÊöóÂè∑Âåñ„ÉªË¶ÅÁ¥ÑÊ©üËÉΩ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ

## Ê©üËÉΩ
- „Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÊöóÂè∑ÂåñÔºàpgcryptoÔºâ
- Ëá™ÂãïË¶ÅÁ¥ÑÔºà„Éà„Éº„ÇØ„É≥ÈñæÂÄ§Ë∂ÖÈÅéÊôÇÔºâ
- „É™„Ç¢„É´„Çø„Ç§„É†Ëá™Âãï‰øùÂ≠ò
- „Åó„Åä„ÇäË™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂ±•Ê≠¥Âæ©ÂÖÉ

## ÂÆüË£ÖË©≥Á¥∞
...
```

#### 9.3 API.md Êõ¥Êñ∞

**„Éï„Ç°„Ç§„É´:** `docs/API.md`

```markdown
## „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥API

### „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰øùÂ≠ò

**POST /api/chat/history**

### „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂèñÂæó

**GET /api/chat/history?itineraryId={id}**

### „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂúßÁ∏Æ

**POST /api/chat/compress**
```

**ÂÑ™ÂÖàÂ∫¶:** üü¢ ‰ΩéÔºàÊ©üËÉΩÂÆüË£ÖÂæå„Å´ÂÆüÊñΩÔºâ

---

## üìã Êé®Â•®ÂÆüË£ÖÈ†ÜÂ∫è

### üî¥ ÊúÄÂÑ™ÂÖàÔºàPhase 5ÊÆã„ÇäÔºö„Éê„Ç∞‰øÆÊ≠£ + Âü∫Êú¨Ê©üËÉΩÂÆåÊàêÔºâ

1. ‚úÖ **Phase 5.1**: „ÉÅ„É£„ÉÉ„ÉàAPIÂÅ¥„ÅÆ„Ç®„É©„Éº„É≠„Ç∞ÊîπÂñÑ
2. ‚úÖ **Phase 5.2**: Zustand„Çπ„Éà„Ç¢„Å´ `isItineraryUnsaved` „Éï„É©„Ç∞ËøΩÂä†
3. ‚úÖ **Phase 5.3**: „Åó„Åä„Çä‰øùÂ≠òÊôÇ„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥‰∏ÄÊã¨‰øùÂ≠ò„Éò„É´„Éë„ÉºÂÆüË£Ö
4. ‚úÖ **Phase 5.4**: SaveButton„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆÊõ¥Êñ∞
5. ‚úÖ **Phase 5.5**: `itinerary/load` API„ÅÆÊõ¥Êñ∞Ôºà„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂèñÂæóËøΩÂä†Ôºâ
6. ‚úÖ **Phase 7.1**: Zustand„Çπ„Éà„Ç¢„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥Èñ¢ÈÄ£„Ç¢„ÇØ„Ç∑„Éß„É≥ËøΩÂä†

**ÁõÆÁöÑ:**
- **„Éê„Ç∞‰øÆÊ≠£**: „Åó„Åä„ÇäÊú™‰øùÂ≠òÊôÇ„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå‰øùÂ≠ò„Åï„Çå„Å™„ÅÑÂïèÈ°å„ÇíËß£Ê±∫

**ÂèÇËÄÉ:** `.cursor/plans/chat-history-debug-guide.md` „Å´Ë©≥Á¥∞„Å™„Éá„Éê„ÉÉ„Ç∞ÊâãÈ†Ü„ÇíË®òËºâ

---

### üü° Ê¨°„Å´ÂÆüË£ÖÔºàPhase 6Ôºâ

4. ‚úÖ **Phase 6.1**: „Éà„Éº„ÇØ„É≥„Éû„Éç„Éº„Ç∏„É£„ÉºÂÆüË£Ö
5. ‚úÖ **Phase 6.2**: Ëá™ÂãïË¶ÅÁ¥ÑÊ©üËÉΩÂÆüË£Ö
6. ‚úÖ **Phase 6.3**: „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂúßÁ∏ÆÊ©üËÉΩÂÆüË£Ö
7. ‚úÖ **Phase 6.4**: Gemini„Å®Claude„ÅÆÊõ¥Êñ∞ÔºàÂÖ®Â±•Ê≠¥ÈÄÅ‰ø°ÂØæÂøúÔºâ
8. ‚úÖ **Phase 7.3**: „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Ââç„ÅÆËá™ÂãïÂúßÁ∏Æ
9. ‚úÖ **Phase 7.4**: „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥ÂúßÁ∏ÆAPI‰ΩúÊàê

**ÁõÆÁöÑ:** „Éà„Éº„ÇØ„É≥Â¢óÂ§ßÂØæÁ≠ñ„Å®ÊñáËÑà‰øùÊåÅ„ÅÆÂº∑Âåñ

---

### üü¢ ÊúÄÂæå„Å´ÂÆüË£ÖÔºàPhase 8, 9Ôºâ

10. ‚úÖ **Phase 8.1**: `.env.example` ‰ΩúÊàê
11. ‚úÖ **Phase 9.1**: E2E„ÉÜ„Çπ„Éà‰ΩúÊàê
12. ‚úÖ **Phase 9.2**: „Éâ„Ç≠„É•„É°„É≥„Éà‰ΩúÊàê
13. ‚úÖ **Phase 9.3**: API.md Êõ¥Êñ∞

**ÁõÆÁöÑ:** „Éâ„Ç≠„É•„É°„É≥„ÉàÊï¥ÂÇô„Å®ÂìÅË≥™‰øùË®º

---

## üéØ ÂÆå‰∫ÜÊôÇ„ÅÆÂãï‰Ωú„Ç§„É°„Éº„Ç∏

### „É¶„Éº„Ç∂„Éº‰ΩìÈ®ì

1. **„ÉÅ„É£„ÉÉ„ÉàÈñãÂßã**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „É¶„Éº„Ç∂„Éº„Åå„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„É™„Ç¢„É´„Çø„Ç§„É†„ÅßDB„Å´ÊöóÂè∑Âåñ‰øùÂ≠ò

2. **„Åó„Åä„ÇäË™≠„ÅøËæº„Åø**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „Åó„Åä„Çä„ÇíÈñã„Åè„Å®„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇÇËá™ÂãïÂæ©ÂÖÉ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - ‰ª•Ââç„ÅÆ‰ºöË©±„ÅÆÁ∂ö„Åç„Åã„ÇâÈñãÂßãÂèØËÉΩ

3. **Èï∑ÊôÇÈñì„ÅÆ‰ºöË©±**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅåÈï∑„Åè„Å™„Çã„Å®Ëá™ÂãïÁöÑ„Å´Ë¶ÅÁ¥Ñ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „Éà„Éº„ÇØ„É≥Âà∂ÈôêÂÜÖ„ÅßÊñáËÑà„Çí‰øùÊåÅ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „É¶„Éº„Ç∂„Éº„Å´„ÅØ„ÄåË¶ÅÁ¥Ñ„Åï„Çå„Åæ„Åó„Åü„Äç„Å®ÈÄöÁü•

4. **„É¢„Éá„É´Âàá„ÇäÊõø„Åà**

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Gemini„Å®Claude„ÇíÂàá„ÇäÊõø„Åà„Å¶„ÇÇÂ±•Ê≠¥„ÅØ‰øùÊåÅ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - „É¢„Éá„É´„Åî„Å®„ÅÆ„Éà„Éº„ÇØ„É≥Âà∂Èôê„Å´Âøú„Åò„Å¶ÊúÄÈÅ©Âåñ

---

## ‚úÖ „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà

### ÂÆüË£ÖÂâç„ÅÆÁ¢∫Ë™ç

- [x] Phase 1-4 „ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
- [x] `lib/db/chat-repository.ts` „ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åô„Çã„Åì„Å®
- [x] `app/api/chat/history/route.ts` „ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åô„Çã„Åì„Å®
- [x] Supabase„ÅÆÊöóÂè∑ÂåñÈñ¢Êï∞„ÅåÊúâÂäπ„Åß„ÅÇ„Çã„Åì„Å®

### ÂÆüË£ÖÂæå„ÅÆÁ¢∫Ë™ç

#### Phase 5-7

- [ ] üö® **„Éê„Ç∞‰øÆÊ≠£Á¢∫Ë™ç**: „Åó„Åä„ÇäÊú™‰øùÂ≠ò„Åß„ÇÇ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå‰øùÂ≠ò„Åï„Çå„ÇãÔºà„Åó„Åä„Çä‰øùÂ≠òÊôÇ„Å´‰∏ÄÊã¨‰øùÂ≠òÔºâ
- [ ] „ÉÅ„É£„ÉÉ„ÉàAPIÂÅ¥„ÅßÈÅ©Âàá„Å™„Ç®„É©„Éº„É≠„Ç∞„ÅåÂá∫Âäõ„Åï„Çå„Çã
- [ ] „Åó„Åä„ÇäÂàùÂõû‰øùÂ≠òÊôÇ„Å´„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå‰∏ÄÊã¨‰øùÂ≠ò„Åï„Çå„Çã
- [ ] „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°Âæå„ÄÅDB„Å´‰øùÂ≠ò„Åï„Çå„ÇãÔºà„Åó„Åä„ÇäID„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
- [ ] „Éà„Éº„ÇØ„É≥Êï∞„ÅåÈñæÂÄ§„ÇíË∂Ö„Åà„Çã„Å®Ëá™ÂãïË¶ÅÁ¥Ñ„Åï„Çå„Çã
- [ ] Ë¶ÅÁ¥ÑÂæå„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„ÅåÂâäÊ∏õ„Åï„Çå„Çã
- [ ] AI„Å´ÂÖ®Â±•Ê≠¥Ôºà„Éà„Éº„ÇØ„É≥Âà∂ÈôêÂÜÖÔºâ„ÅåÈÄÅ‰ø°„Åï„Çå„Çã

#### Phase 8-9

- [ ] `.env.example` „Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Çã
- [ ] E2E„ÉÜ„Çπ„Éà„ÅåÈÄöÈÅé„Åô„Çã
- [ ] `docs/CHAT_HISTORY.md` „Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Çã
- [ ] `docs/API.md` „ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Çã

---

## üìù Ê≥®ÊÑè‰∫ãÈ†Ö

### „Éà„Éº„ÇØ„É≥Êé®ÂÆö„ÅÆÁ≤æÂ∫¶

- ÁèæÂú®„ÅÆÂÆüË£Ö„ÅØÁ∞°ÊòìÊé®ÂÆöÔºàÊñáÂ≠óÊï∞ * 2Ôºâ
- „Çà„ÇäÊ≠£Á¢∫„Å™Êé®ÂÆö„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ `tiktoken` „Å™„Å©„ÅÆ„É©„Ç§„Éñ„É©„É™„Çí‰ΩøÁî®
- Êó•Êú¨Ë™û„Å®Ëã±Ë™û„ÅßÊé®ÂÆöÊñπÊ≥ï„ÇíÂ§âÊõ¥„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã

### Ë¶ÅÁ¥Ñ„ÅÆÂìÅË≥™

- Gemini Flash „Çí‰ΩøÁî®„Åó„ÅüË¶ÅÁ¥Ñ„ÅØÈ´òÈÄü„Å†„ÅåÁ≤æÂ∫¶„ÅØ‰∏≠Á®ãÂ∫¶
- ÈáçË¶Å„Å™ÊÉÖÂ†±„ÅåÊ¨†ËêΩ„Åó„Å™„ÅÑ„Çà„ÅÜ„Éó„É≠„É≥„Éó„Éà„ÇíË™øÊï¥
- ÂøÖË¶Å„Å´Âøú„Åò„Å¶Gemini Pro„Çí‰ΩøÁî®

### „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ

- „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂúßÁ∏Æ„ÅØ„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßÂÆüË°å
- „É¶„Éº„Ç∂„Éº„ÅÆÂÖ•Âäõ„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Å™„ÅÑ
- ÂúßÁ∏ÆÂ§±ÊïóÊôÇ„ÅØÂÖÉ„ÅÆÂ±•Ê≠¥„Çí‰øùÊåÅ

### „Çª„Ç≠„É•„É™„ÉÜ„Ç£

- ÊöóÂè∑Âåñ„Ç≠„Éº„ÅØÁí∞Â¢ÉÂ§âÊï∞„ÅßÁÆ°ÁêÜ
- „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„Å´Âπ≥Êñá„Çí‰øùÂ≠ò„Åó„Å™„ÅÑ
- API„Ç≠„Éº„Çí„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´Èú≤Âá∫„Åó„Å™„ÅÑ

---

## üîó Èñ¢ÈÄ£„Éâ„Ç≠„É•„É°„É≥„Éà

- [lib/db/chat-repository.ts](mdc:lib/db/chat-repository.ts) - „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„É™„Éù„Ç∏„Éà„É™
- [lib/db/schema-chat-encryption.sql](mdc:lib/db/schema-chat-encryption.sql) - ÊöóÂè∑Âåñ„Çπ„Ç≠„Éº„Éû
- [app/api/chat/history/route.ts](mdc:app/api/chat/history/route.ts) - „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥API
- [lib/ai/gemini.ts](mdc:lib/ai/gemini.ts) - Gemini„ÇØ„É©„Ç§„Ç¢„É≥„Éà
- [lib/ai/claude.ts](mdc:lib/ai/claude.ts) - Claude„ÇØ„É©„Ç§„Ç¢„É≥„Éà
- [lib/store/useStore.ts](mdc:lib/store/useStore.ts) - Zustand„Çπ„Éà„Ç¢

---

**„Åì„ÅÆ„Éó„É©„É≥„Å´Âæì„Å£„Å¶ÂÆüË£Ö„Åô„Çã„Åì„Å®„Åß„ÄÅ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆDB‰øùÂ≠ò„Å®Ëá™ÂãïË¶ÅÁ¥ÑÊ©üËÉΩ„ÅåÂÆåÊàê„Åó„Åæ„Åô„ÄÇ**

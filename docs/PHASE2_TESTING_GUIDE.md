# Phase 2 実装チェックガイド

Phase 2の認証機能の実装を確認するための手順です。

## 📋 事前準備

### 1. 環境変数の設定

`.env.local`ファイルが必要です：

```bash
# .env.exampleをコピー
cp .env.example .env.local
```

`.env.local`を編集：

```env
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=（以下のコマンドで生成）
GOOGLE_CLIENT_ID=（Google Cloudから取得）
GOOGLE_CLIENT_SECRET=（Google Cloudから取得）
```

**NEXTAUTH_SECRETの生成**:
```bash
openssl rand -base64 32
```

### 2. Google OAuth設定

まだ設定していない場合：

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. プロジェクトを作成
3. 「APIとサービス」→「OAuth同意画面」
   - 外部を選択
   - アプリ名：Journee
   - テストユーザーにあなたのGoogleアカウントを追加
4. 「認証情報」→「OAuth 2.0 クライアントID」を作成
   - アプリケーションの種類：ウェブアプリケーション
   - 承認済みのリダイレクトURI：`http://localhost:3000/api/auth/callback/google`
5. クライアントIDとシークレットをコピー

---

## 🚀 チェック手順

### Step 1: 開発サーバーの起動

```bash
# 依存関係のインストール（未実施の場合）
npm install

# 開発サーバー起動
npm run dev
```

起動後、以下のURLにアクセス：
- **メインページ**: http://localhost:3000
- **APIヘルスチェック**: http://localhost:3000/api/health

---

### Step 2: 認証フローのテスト

#### 2.1 未認証時のリダイレクト確認

1. ブラウザで http://localhost:3000 にアクセス
2. **期待結果**: 自動的に `/login` にリダイレクトされる

#### 2.2 ログインページの確認

ログインページが表示されることを確認：
- ✅ Journeeロゴが表示
- ✅ 「Googleでログイン」ボタンが表示
- ✅ 機能紹介（AI対話、しおり作成、PDF出力）が表示

#### 2.3 Googleログイン

1. 「Googleでログイン」ボタンをクリック
2. Googleの認証画面が表示される
3. テストユーザーのアカウントでログイン
4. **期待結果**: メインページ（/）にリダイレクトされる

#### 2.4 ログイン後の画面確認

メインページで以下を確認：
- ✅ ヘッダーにユーザーアバターが表示
- ✅ 左側にチャットボックスが表示
- ✅ 右側にしおりプレビューが表示

#### 2.5 ユーザーメニューの確認

1. 右上のアバターをクリック
2. **期待結果**: ドロップダウンメニューが表示される
   - ユーザー名
   - メールアドレス
   - マイページ
   - しおり一覧
   - 設定
   - ログアウト

#### 2.6 ログアウト

1. ユーザーメニューから「ログアウト」をクリック
2. **期待結果**: ログインページにリダイレクトされる

---

### Step 3: APIエンドポイントのテスト

#### 3.1 ヘルスチェック

```bash
curl http://localhost:3000/api/health
```

**期待結果**:
```json
{
  "status": "ok",
  "timestamp": "2025-10-07T...",
  "service": "Journee API",
  "version": "1.0.0",
  "environment": "development"
}
```

#### 3.2 セッション情報取得（未ログイン）

ブラウザで http://localhost:3000/api/auth/session にアクセス

**期待結果**:
```json
{}
```

#### 3.3 セッション情報取得（ログイン後）

ログイン後、同じURLにアクセス

**期待結果**:
```json
{
  "user": {
    "id": "...",
    "email": "your-email@gmail.com",
    "name": "Your Name",
    "image": "https://...",
    "googleId": "..."
  },
  "expires": "2025-11-07T..."
}
```

#### 3.4 ユーザー情報取得（ログイン後）

ブラウザで http://localhost:3000/api/user/me にアクセス

**期待結果**:
```json
{
  "id": "...",
  "email": "your-email@gmail.com",
  "name": "Your Name",
  "image": "https://...",
  "googleId": "..."
}
```

---

### Step 4: コンポーネントの動作確認

#### 4.1 Header（ヘッダー）

**確認項目**:
- ✅ Journeeロゴが表示される
- ✅ 未ログイン時：「Googleでログイン」ボタンが表示
- ✅ ログイン後：ユーザーアバターが表示
- ✅ ローディング時：グレーの円形プレースホルダーが表示

#### 4.2 LoginButton（ログインボタン）

**確認項目**:
- ✅ Googleロゴが表示される
- ✅ クリックすると認証フローが開始
- ✅ ローディング中は「ログイン中...」と表示

#### 4.3 UserMenu（ユーザーメニュー）

**確認項目**:
- ✅ アバター画像または名前の頭文字が表示
- ✅ ユーザー名とメールアドレスが表示
- ✅ クリックでドロップダウンメニューが開く
- ✅ メニュー外をクリックで閉じる
- ✅ ログアウトボタンが赤色で表示

#### 4.4 ChatBox（チャットボックス）

**確認項目**:
- ✅ 「AIチャット」ヘッダーが表示
- ✅ AIモデル選択が表示
- ✅ メッセージ入力フォームが表示
- ✅ メッセージを入力して送信できる（モック応答）

#### 4.5 ItineraryPreview（しおりプレビュー）

**確認項目**:
- ✅ プレースホルダーが表示（データがない場合）
- ✅ カレンダーアイコンとメッセージが表示

---

### Step 5: ブラウザ開発者ツールでの確認

#### 5.1 Cookieの確認

1. ブラウザの開発者ツールを開く（F12）
2. Application（Applicationタブ）→ Cookies
3. `http://localhost:3000` を選択

**確認項目**:
- ✅ `next-auth.session-token` が存在（ログイン後）
- ✅ HTTPOnly属性がついている
- ✅ 有効期限が設定されている（30日後）

#### 5.2 ネットワークリクエストの確認

1. Network（Networkタブ）を開く
2. ログインフローを実行

**確認するリクエスト**:
- ✅ `/api/auth/signin/google` - 認証開始
- ✅ `/api/auth/callback/google` - コールバック
- ✅ `/api/auth/session` - セッション取得
- ✅ `/api/user/me` - ユーザー情報取得

#### 5.3 コンソールエラーの確認

1. Console（Consoleタブ）を開く
2. エラーがないことを確認

**期待結果**:
- ❌ エラーなし（警告は許容）

---

### Step 6: レスポンシブデザインの確認

#### 6.1 デスクトップ表示

ブラウザを全画面で表示：
- ✅ チャットボックスが左側（40%）
- ✅ しおりプレビューが右側（60%）
- ✅ ヘッダーが適切に表示

#### 6.2 モバイル表示

ブラウザの開発者ツールでモバイルビューに切り替え：
- ✅ レイアウトが縦並びになる
- ✅ ヘッダーが適切に縮小表示
- ✅ タッチ操作が可能

---

## ✅ チェックリスト

### 認証機能
- [ ] 未認証時に自動リダイレクト
- [ ] Googleログインが成功する
- [ ] ログイン後にメインページが表示される
- [ ] ユーザーメニューが表示される
- [ ] ログアウトが正常に動作する

### APIエンドポイント
- [ ] `/api/health` が200を返す
- [ ] `/api/auth/session` がセッション情報を返す
- [ ] `/api/user/me` がユーザー情報を返す
- [ ] 未ログイン時に401エラーが返る

### UIコンポーネント
- [ ] Header が正しく表示される
- [ ] LoginButton が動作する
- [ ] UserMenu が動作する
- [ ] ChatBox が表示される
- [ ] ItineraryPreview が表示される

### セキュリティ
- [ ] HTTPOnly Cookieが設定される
- [ ] セッションが30日間有効
- [ ] CSRF保護が動作する
- [ ] 未認証時のリダイレクトが動作する

---

## 🐛 トラブルシューティング

### 問題: ログインできない

**原因**: Google OAuth設定が正しくない

**解決方法**:
1. `.env.local` のクライアントIDとシークレットを確認
2. Google Cloud Consoleでリダイレクトが正しく設定されているか確認
3. テストユーザーとして自分のアカウントが追加されているか確認

### 問題: "Invalid redirect URI"エラー

**原因**: リダイレクトURIが正しく設定されていない

**解決方法**:
1. Google Cloud Consoleの認証情報を確認
2. リダイレクトURIに以下が含まれているか確認：
   ```
   http://localhost:3000/api/auth/callback/google
   ```
3. 末尾のスラッシュがないことを確認

### 問題: セッションが保存されない

**原因**: `NEXTAUTH_SECRET` が設定されていない

**解決方法**:
1. `.env.local` に `NEXTAUTH_SECRET` が設定されているか確認
2. 開発サーバーを再起動

### 問題: ページが真っ白

**原因**: ビルドエラーまたはJavaScriptエラー

**解決方法**:
1. ブラウザの開発者ツールでコンソールエラーを確認
2. ターミナルのエラーメッセージを確認
3. 依存関係を再インストール：
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```

---

## 📊 期待される結果

すべてのチェック項目が完了すると：

✅ **認証システム**が正常に動作  
✅ **Google OAuth**でログイン可能  
✅ **セッション管理**が正常に機能  
✅ **ユーザーメニュー**が表示  
✅ **ログアウト**が正常に動作  
✅ **APIエンドポイント**が応答  
✅ **UIコンポーネント**が正しく表示  

---

## 🎉 次のステップ

Phase 2のチェックが完了したら：

1. **Phase 3: AI統合**の準備
   - Gemini APIキーの取得
   - AIチャット機能の実装

2. **Pull Requestの作成**
   - mainブランチへのマージ申請

---

**チェック実施日**: _____年___月___日  
**チェック実施者**: _______________  
**結果**: ✅ 合格 / ❌ 不合格

# Phase 4: æ®µéšçš„æ—…ç¨‹æ§‹ç¯‰ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“‹ æ¦‚è¦

å¾“æ¥ã®ã€Œä¸€åº¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Œå…¨ãªæ—…ç¨‹ã‚’ç”Ÿæˆã™ã‚‹ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‹ã‚‰ã€ã€Œè¤‡æ•°å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ®µéšçš„ã«æ—…ç¨‹ã‚’æ§‹ç¯‰ã™ã‚‹ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€AIã®è² è·ã‚’åˆ†æ•£ã—ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„æ—…ç¨‹ã‚’ä½œæˆã§ãã¾ã™ã€‚

## ğŸ¯ ç›®çš„

1. **AIè² è·ã®åˆ†æ•£**: ä¸€åº¦ã«å¤§é‡ã®æƒ…å ±ã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã¯ãªãã€æ®µéšçš„ã«ç”Ÿæˆ
2. **ç²¾åº¦ã®å‘ä¸Š**: å„æ®µéšã§ç„¦ç‚¹ã‚’çµã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè©³ç´°ã§æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›
3. **UXã®æ”¹å–„**: é€²æ—ãŒå¯è¦–åŒ–ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ§‹ç¯‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç†è§£ã—ã‚„ã™ã„
4. **æŸ”è»Ÿæ€§ã®å‘ä¸Š**: å„æ®µéšã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¿®æ­£ãƒ»èª¿æ•´ã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹

## ğŸ— ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### æ§‹ç¯‰ãƒ•ãƒ­ãƒ¼

```
ã€Phase 1: åŸºæœ¬æƒ…å ±åé›†ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "3æœˆã«2æ³Š3æ—¥ã§äº¬éƒ½æ—…è¡Œã«è¡ŒããŸã„"
        â†“
AIãŒç¢ºèª: è¡Œãå…ˆã€æœŸé–“ã€äººæ•°ã€èˆˆå‘³ãªã©ã‚’ç¢ºèª
        â†“

ã€Phase 2: éª¨çµ„ã¿ä½œæˆã€‘
AIãŒç”Ÿæˆ: å„æ—¥ã®å¤§ã¾ã‹ãªãƒ†ãƒ¼ãƒã‚’æ±ºå®š
å‡ºåŠ›ä¾‹:
  1æ—¥ç›®: äº¬éƒ½åˆ°ç€ãƒ»æ±å±±ã‚¨ãƒªã‚¢æ•£ç­–
  2æ—¥ç›®: åµå±±ãƒ»ç«¹æ—ã‚¨ãƒªã‚¢
  3æ—¥ç›®: é‡‘é–£å¯ºã‚¨ãƒªã‚¢ãƒ»å¸°è·¯
        â†“
ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹ï¼‰
        â†“

ã€Phase 3: 1æ—¥ç›®è©³ç´°åŒ–ã€‘
AIãŒç”Ÿæˆ: 1æ—¥ç›®ã®å…·ä½“çš„ãªã‚¹ãƒãƒƒãƒˆã€æ™‚é–“ã€ç§»å‹•æ‰‹æ®µ
å‡ºåŠ›ä¾‹:
  10:00 æ¸…æ°´å¯ºï¼ˆ90åˆ†ï¼‰
  12:00 æ˜¼é£Ÿãƒ»ãŠã°ã‚“ã–ã„ï¼ˆ60åˆ†ï¼‰
  14:00 å…«å‚ç¥ç¤¾ï¼ˆ45åˆ†ï¼‰
  ...
        â†“
ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹ï¼‰
        â†“

ã€Phase 4: 2æ—¥ç›®è©³ç´°åŒ–ã€‘
ï¼ˆä»¥ä¸‹åŒæ§˜ã«å„æ—¥ã‚’è©³ç´°åŒ–ï¼‰
        â†“

ã€Phase 5: æœ€çµ‚èª¿æ•´ã€‘
å…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã€äºˆç®—ç¢ºèªã€æœ€çµ‚ç¢ºèª
```

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ‹¡å¼µ

#### 1. æ—¥ç¨‹ã®çŠ¶æ…‹ç®¡ç†

```typescript
// types/itinerary.ts ã«è¿½åŠ 

export type DayStatus = 'draft' | 'skeleton' | 'detailed' | 'completed';

export interface DaySchedule {
  day: number;
  date?: string;
  title?: string;
  status: DayStatus;  // æ–°è¦è¿½åŠ 
  theme?: string;     // æ–°è¦è¿½åŠ : ãã®æ—¥ã®ãƒ†ãƒ¼ãƒï¼ˆéª¨çµ„ã¿æ®µéšã§è¨­å®šï¼‰
  spots: TouristSpot[];
  totalDistance?: number;
  totalCost?: number;
}

export type ItineraryPhase = 
  | 'initial'         // åˆæœŸçŠ¶æ…‹ï¼ˆã¾ã ä½•ã‚‚ä½œæˆã•ã‚Œã¦ã„ãªã„ï¼‰
  | 'collecting'      // åŸºæœ¬æƒ…å ±åé›†ä¸­
  | 'skeleton'        // éª¨çµ„ã¿ä½œæˆä¸­
  | 'detailing'       // è©³ç´°åŒ–ä¸­
  | 'completed';      // å®Œæˆ

export interface ItineraryData {
  id: string;
  title: string;
  destination: string;
  startDate?: string;
  endDate?: string;
  duration?: number;
  summary?: string;
  schedule: DaySchedule[];
  totalBudget?: number;
  status: 'draft' | 'completed' | 'archived';
  phase: ItineraryPhase;  // æ–°è¦è¿½åŠ 
  currentDay?: number;     // æ–°è¦è¿½åŠ : ç¾åœ¨è©³ç´°åŒ–ä¸­ã®æ—¥
  createdAt: Date;
  updatedAt: Date;
}
```

#### 2. çŠ¶æ…‹ç®¡ç†ã®æ‹¡å¼µ

```typescript
// lib/store/useStore.ts ã«è¿½åŠ 

interface AppState {
  // ... æ—¢å­˜ã®çŠ¶æ…‹ ...
  
  // Phase 4: æ®µéšçš„æ§‹ç¯‰ã®çŠ¶æ…‹
  planningPhase: ItineraryPhase;
  currentDetailingDay: number | null;
  setPlanningPhase: (phase: ItineraryPhase) => void;
  setCurrentDetailingDay: (day: number | null) => void;
  
  // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è‡ªå‹•çš„ã«é€²ã‚ã‚‹
  proceedToNextStep: () => void;
}
```

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥

#### 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„

```typescript
// lib/ai/prompts.ts

export const INCREMENTAL_SYSTEM_PROMPT = `ã‚ãªãŸã¯æ—…è¡Œè¨ˆç”»ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å¯¾è©±ã—ãªãŒã‚‰ã€æ®µéšçš„ã«æœ€é©ãªæ—…ã®ã—ãŠã‚Šã‚’ä½œæˆã—ã¾ã™ã€‚

ã€æ®µéšçš„æ§‹ç¯‰ã®ãƒ—ãƒ­ã‚»ã‚¹ã€‘
æ—…ç¨‹ã®ä½œæˆã¯ä»¥ä¸‹ã®æ®µéšã§é€²ã‚ã¾ã™ï¼š

1. **åŸºæœ¬æƒ…å ±åé›†**: 
   - è¡Œãå…ˆã€æœŸé–“ã€äººæ•°ã€èˆˆå‘³ã€äºˆç®—ã‚’ç¢ºèª
   - ä¸æ˜ãªæƒ…å ±ã¯è³ªå•ã—ã¦ç¢ºèª

2. **éª¨çµ„ã¿ä½œæˆ**:
   - å„æ—¥ã®å¤§ã¾ã‹ãªãƒ†ãƒ¼ãƒï¼ˆã‚¨ãƒªã‚¢ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰ã‚’æ±ºå®š
   - æ—¥ã”ã¨ã®æ¦‚è¦ã®ã¿ã‚’æç¤ºï¼ˆè©³ç´°ãªã‚¹ãƒãƒƒãƒˆã¯ã¾ã å«ã‚ãªã„ï¼‰
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹

3. **æ—¥ç¨‹ã®è©³ç´°åŒ–**ï¼ˆ1æ—¥ãšã¤ï¼‰:
   - 1æ—¥ã”ã¨ã«å…·ä½“çš„ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã€æ™‚é–“ã€ç§»å‹•æ‰‹æ®µã‚’ææ¡ˆ
   - å„ã‚¹ãƒãƒƒãƒˆã®è©³ç´°æƒ…å ±ï¼ˆæ‰€è¦æ™‚é–“ã€è²»ç”¨ã€èª¬æ˜ï¼‰ã‚’è¿½åŠ 
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã¦ã‹ã‚‰æ¬¡ã®æ—¥ã«é€²ã‚€

4. **æœ€çµ‚èª¿æ•´**:
   - å…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹ç¢ºèª
   - äºˆç®—ã®æœ€çµ‚èª¿æ•´
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›åæ˜ 

ã€é‡è¦ãªæŒ‡ç¤ºã€‘
- ç¾åœ¨ã©ã®æ®µéšã«ã„ã‚‹ã‹ã‚’å¸¸ã«æ„è­˜ã™ã‚‹
- éª¨çµ„ã¿æ®µéšã§ã¯è©³ç´°ãªã‚¹ãƒãƒƒãƒˆæƒ…å ±ã‚’å‡ºåŠ›ã—ãªã„
- è©³ç´°åŒ–æ®µéšã§ã¯1æ—¥ãšã¤é›†ä¸­ã—ã¦ä½œæˆã™ã‚‹
- å„æ®µéšã®çµ‚ã‚ã‚Šã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèªã‚’æ±‚ã‚ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿®æ­£ã‚’æ±‚ã‚ãŸã‚‰ã€ãã®æ®µéšã«æˆ»ã£ã¦èª¿æ•´ã™ã‚‹

ã€ç¾åœ¨ã®æ®µéšã€‘: {{CURRENT_PHASE}}
ã€ç¾åœ¨ä½œæˆä¸­ã®æ—¥ã€‘: {{CURRENT_DAY}}
`;
```

#### 2. æ®µéšåˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

```typescript
// lib/ai/prompts.ts

/**
 * éª¨çµ„ã¿ä½œæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 */
export function createSkeletonPrompt(
  destination: string,
  duration: number,
  interests?: string[]
): string {
  return `ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€æ—…è¡Œã®éª¨çµ„ã¿ï¼ˆå„æ—¥ã®ãƒ†ãƒ¼ãƒï¼‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

- è¡Œãå…ˆ: ${destination}
- æœŸé–“: ${duration}æ—¥é–“
${interests ? `- èˆˆå‘³: ${interests.join(', ')}` : ''}

ã€å‡ºåŠ›å½¢å¼ã€‘
å„æ—¥ã®å¤§ã¾ã‹ãªãƒ†ãƒ¼ãƒï¼ˆã‚¨ãƒªã‚¢ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰ã®ã¿ã‚’ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "title": "æ—…è¡Œã®ã‚¿ã‚¤ãƒˆãƒ«",
  "destination": "${destination}",
  "duration": ${duration},
  "summary": "æ—…è¡Œå…¨ä½“ã®æ¦‚è¦",
  "schedule": [
    {
      "day": 1,
      "title": "1æ—¥ç›®ã®ã‚¿ã‚¤ãƒˆãƒ«",
      "theme": "1æ—¥ç›®ã®ãƒ†ãƒ¼ãƒï¼ˆã‚¨ãƒªã‚¢ã‚„ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰",
      "status": "skeleton",
      "spots": []
    }
  ],
  "phase": "skeleton",
  "status": "draft"
}
\`\`\`

**é‡è¦**: ã“ã®æ®µéšã§ã¯å…·ä½“çš„ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã¯å«ã‚ãšã€å„æ—¥ã®ãƒ†ãƒ¼ãƒã®ã¿ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
è©³ç´°ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã¯æ¬¡ã®æ®µéšã§1æ—¥ãšã¤ä½œæˆã—ã¾ã™ã€‚

ã“ã®ãƒ—ãƒ©ãƒ³ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€1æ—¥ç›®ã‹ã‚‰é †ç•ªã«è©³ç´°ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚
å¤‰æ›´ã—ãŸã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚`;
}

/**
 * æ—¥ç¨‹è©³ç´°åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 */
export function createDayDetailPrompt(
  itinerary: ItineraryData,
  dayNumber: number
): string {
  const day = itinerary.schedule.find(d => d.day === dayNumber);
  
  return `ç¾åœ¨ä½œæˆä¸­ã®æ—…è¡Œã®${dayNumber}æ—¥ç›®ã®è©³ç´°ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

ã€æ—…è¡Œæƒ…å ±ã€‘
- è¡Œãå…ˆ: ${itinerary.destination}
- æœŸé–“: ${itinerary.duration}æ—¥é–“
- ${dayNumber}æ—¥ç›®ã®ãƒ†ãƒ¼ãƒ: ${day?.theme || 'æœªå®š'}

ã€ä»–ã®æ—¥ç¨‹ã®æ¦‚è¦ã€‘
${itinerary.schedule
  .filter(d => d.day !== dayNumber)
  .map(d => `${d.day}æ—¥ç›®: ${d.theme || d.title}`)
  .join('\n')}

ã€å‡ºåŠ›å½¢å¼ã€‘
${dayNumber}æ—¥ç›®ã®å…·ä½“çš„ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã€æ™‚é–“é…åˆ†ã€ç§»å‹•æ‰‹æ®µã‚’ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

\`\`\`json
{
  "schedule": [
    {
      "day": ${dayNumber},
      "title": "${dayNumber}æ—¥ç›®ã®ã‚¿ã‚¤ãƒˆãƒ«",
      "theme": "${day?.theme}",
      "status": "detailed",
      "spots": [
        {
          "id": "spot-${dayNumber}-1",
          "name": "è¦³å…‰ã‚¹ãƒãƒƒãƒˆå",
          "description": "è©³ç´°ãªèª¬æ˜ï¼ˆ3-5æ–‡ï¼‰",
          "scheduledTime": "10:00",
          "duration": 90,
          "category": "sightseeing",
          "estimatedCost": 500,
          "notes": "ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã‚„ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆ"
        }
      ],
      "totalCost": 5000
    }
  ],
  "phase": "detailing",
  "currentDay": ${dayNumber}
}
\`\`\`

**é‡è¦äº‹é …**:
- ç§»å‹•æ™‚é–“ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã—ã¦ãã ã•ã„
- é£Ÿäº‹ã®æ™‚é–“ã‚’é©åˆ‡ã«ç¢ºä¿ã—ã¦ãã ã•ã„
- å„ã‚¹ãƒãƒƒãƒˆã®èª¬æ˜ã¯å…·ä½“çš„ã«ï¼ˆè¦‹ã©ã“ã‚ã€ç‰¹å¾´ãªã©ï¼‰
- ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã‚„æ³¨æ„äº‹é …ã‚’notesã«è¨˜è¼‰ã—ã¦ãã ã•ã„

ã“ã®æ—¥ç¨‹ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€æ¬¡ã®æ—¥ã«é€²ã¿ã¾ã™ã€‚
å¤‰æ›´ã—ãŸã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚`;
}

/**
 * æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸ã®èª˜å°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 */
export function createNextStepPrompt(
  currentPhase: ItineraryPhase,
  itinerary?: ItineraryData
): string {
  switch (currentPhase) {
    case 'skeleton':
      return '\n\nã“ã®éª¨çµ„ã¿ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€1æ—¥ç›®ã®è©³ç´°ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\nã€Œ1æ—¥ç›®ã®è©³ç´°ã‚’æ•™ãˆã¦ã€ã¾ãŸã¯ã€Œæ¬¡ã¸ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    
    case 'detailing':
      const currentDay = itinerary?.currentDay || 1;
      const totalDays = itinerary?.duration || 1;
      
      if (currentDay < totalDays) {
        return `\n\nã“ã®æ—¥ç¨‹ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€${currentDay + 1}æ—¥ç›®ã®è©³ç´°ã‚’ä½œæˆã—ã¾ã™ã€‚\nã€Œ${currentDay + 1}æ—¥ç›®ã®è©³ç´°ã‚’æ•™ãˆã¦ã€ã¾ãŸã¯ã€Œæ¬¡ã¸ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;
      } else {
        return '\n\nå…¨ã¦ã®æ—¥ç¨‹ãŒå®Œæˆã—ã¾ã—ãŸï¼\næœ€çµ‚ç¢ºèªã‚’ã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¾ã™ã€‚å¤‰æ›´ã—ãŸã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚';
      }
    
    default:
      return '';
  }
}
```

### UIã®æ”¹å–„

#### 1. é€²æ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼

```typescript
// components/itinerary/PlanningProgress.tsx

interface PlanningProgressProps {
  phase: ItineraryPhase;
  totalDays: number;
  currentDay: number | null;
  schedule: DaySchedule[];
}

export const PlanningProgress: React.FC<PlanningProgressProps> = ({
  phase,
  totalDays,
  currentDay,
  schedule,
}) => {
  const getPhaseLabel = (phase: ItineraryPhase): string => {
    switch (phase) {
      case 'initial': return 'æº–å‚™ä¸­';
      case 'collecting': return 'æƒ…å ±åé›†ä¸­';
      case 'skeleton': return 'éª¨çµ„ã¿ä½œæˆä¸­';
      case 'detailing': return 'è©³ç´°åŒ–ä¸­';
      case 'completed': return 'å®Œæˆ';
    }
  };

  const getDayStatus = (day: number): 'pending' | 'in-progress' | 'completed' => {
    const daySchedule = schedule.find(s => s.day === day);
    if (!daySchedule || daySchedule.status === 'draft') return 'pending';
    if (daySchedule.status === 'skeleton') return 'in-progress';
    if (daySchedule.status === 'detailed' || daySchedule.status === 'completed') return 'completed';
    return 'pending';
  };

  return (
    <div className="bg-white border border-gray-200 rounded-lg p-4 mb-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-900">ä½œæˆé€²æ—</h3>
        <span className="text-sm font-medium text-blue-600">
          {getPhaseLabel(phase)}
        </span>
      </div>

      {phase === 'detailing' && (
        <div className="space-y-2">
          {Array.from({ length: totalDays }, (_, i) => i + 1).map((day) => {
            const status = getDayStatus(day);
            return (
              <div key={day} className="flex items-center space-x-3">
                <div className={`
                  w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium
                  ${status === 'completed' ? 'bg-green-500 text-white' :
                    status === 'in-progress' ? 'bg-blue-500 text-white' :
                    'bg-gray-200 text-gray-600'}
                `}>
                  {status === 'completed' ? 'âœ“' : day}
                </div>
                <div className="flex-1">
                  <div className={`h-2 rounded-full ${
                    status === 'completed' ? 'bg-green-500' :
                    status === 'in-progress' ? 'bg-blue-500 animate-pulse' :
                    'bg-gray-200'
                  }`} />
                </div>
                <span className="text-sm text-gray-600">
                  {status === 'completed' ? 'å®Œäº†' :
                   status === 'in-progress' ? 'ä½œæˆä¸­' :
                   'æœªä½œæˆ'}
                </span>
              </div>
            );
          })}
        </div>
      )}

      {phase === 'skeleton' && (
        <div className="text-sm text-gray-600">
          æ—…è¡Œã®éª¨çµ„ã¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™...
        </div>
      )}

      {phase === 'completed' && (
        <div className="flex items-center space-x-2 text-green-600">
          <span className="text-2xl">âœ“</span>
          <span className="font-medium">æ—…ç¨‹ãŒå®Œæˆã—ã¾ã—ãŸï¼</span>
        </div>
      )}
    </div>
  );
};
```

#### 2. ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³

```typescript
// components/itinerary/QuickActions.tsx

interface QuickActionsProps {
  phase: ItineraryPhase;
  currentDay: number | null;
  totalDays: number;
  onProceedNext: () => void;
}

export const QuickActions: React.FC<QuickActionsProps> = ({
  phase,
  currentDay,
  totalDays,
  onProceedNext,
}) => {
  const getActionLabel = (): string => {
    if (phase === 'skeleton') return '1æ—¥ç›®ã‚’è©³ç´°åŒ–';
    if (phase === 'detailing' && currentDay && currentDay < totalDays) {
      return `${currentDay + 1}æ—¥ç›®ã‚’è©³ç´°åŒ–`;
    }
    if (phase === 'detailing' && currentDay === totalDays) {
      return 'æœ€çµ‚ç¢ºèªã¸';
    }
    return 'æ¬¡ã¸';
  };

  const shouldShowAction = phase === 'skeleton' || 
    (phase === 'detailing' && currentDay && currentDay <= totalDays);

  if (!shouldShowAction) return null;

  return (
    <div className="mt-4">
      <button
        onClick={onProceedNext}
        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-medium 
                   hover:bg-blue-700 transition-colors duration-200
                   flex items-center justify-center space-x-2"
      >
        <span>{getActionLabel()}</span>
        <span>â†’</span>
      </button>
    </div>
  );
};
```

### API ã®å¤‰æ›´

#### ãƒãƒ£ãƒƒãƒˆAPIã®æ‹¡å¼µ

```typescript
// app/api/chat/route.ts

export async function POST(req: Request) {
  try {
    const { message, history, currentItinerary } = await req.json();
    
    // ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’åˆ¤å®š
    const phase = currentItinerary?.phase || 'initial';
    const currentDay = currentItinerary?.currentDay || null;
    
    // ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ãŸã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠ
    let systemPrompt = INCREMENTAL_SYSTEM_PROMPT
      .replace('{{CURRENT_PHASE}}', phase)
      .replace('{{CURRENT_DAY}}', currentDay ? `${currentDay}æ—¥ç›®` : 'ãªã—');
    
    // ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ãŸè¿½åŠ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    if (phase === 'skeleton' && message.toLowerCase().includes('æ¬¡')) {
      // éª¨çµ„ã¿ãŒæ‰¿èªã•ã‚ŒãŸã‚‰ã€1æ—¥ç›®ã®è©³ç´°åŒ–ã«é€²ã‚€
      systemPrompt += '\n' + createDayDetailPrompt(currentItinerary, 1);
    } else if (phase === 'detailing' && message.toLowerCase().includes('æ¬¡')) {
      // ç¾åœ¨ã®æ—¥ãŒæ‰¿èªã•ã‚ŒãŸã‚‰ã€æ¬¡ã®æ—¥ã®è©³ç´°åŒ–ã«é€²ã‚€
      const nextDay = (currentDay || 0) + 1;
      if (nextDay <= currentItinerary.duration) {
        systemPrompt += '\n' + createDayDetailPrompt(currentItinerary, nextDay);
      }
    }
    
    // ... æ®‹ã‚Šã®å®Ÿè£…ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜ ...
  } catch (error) {
    // ... ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ...
  }
}
```

## ğŸ“ å®Ÿè£…ã‚¿ã‚¹ã‚¯

### 4.1 å‹å®šç¾©ã®æ‹¡å¼µ
- [ ] `DayStatus` å‹ã®è¿½åŠ 
- [ ] `ItineraryPhase` å‹ã®è¿½åŠ 
- [ ] `DaySchedule` ã« `status`, `theme` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 
- [ ] `ItineraryData` ã« `phase`, `currentDay` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 

### 4.2 çŠ¶æ…‹ç®¡ç†ã®æ‹¡å¼µ
- [ ] `useStore.ts` ã«æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
- [ ] `planningPhase`, `currentDetailingDay` ã®çŠ¶æ…‹ç®¡ç†
- [ ] `proceedToNextStep` é–¢æ•°ã®å®Ÿè£…

### 4.3 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„
- [ ] `INCREMENTAL_SYSTEM_PROMPT` ã®ä½œæˆ
- [ ] `createSkeletonPrompt` é–¢æ•°ã®å®Ÿè£…
- [ ] `createDayDetailPrompt` é–¢æ•°ã®å®Ÿè£…
- [ ] `createNextStepPrompt` é–¢æ•°ã®å®Ÿè£…

### 4.4 UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¿½åŠ 
- [ ] `PlanningProgress` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
- [ ] `QuickActions` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
- [ ] `ItineraryPreview` ã«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºã‚’çµ±åˆ

### 4.5 APIã®æ‹¡å¼µ
- [ ] ãƒãƒ£ãƒƒãƒˆAPIã«ãƒ•ã‚§ãƒ¼ã‚ºåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
- [ ] è‡ªå‹•é€²è¡Œã®ãƒˆãƒªã‚¬ãƒ¼å®Ÿè£…ï¼ˆã€Œæ¬¡ã¸ã€ã®æ¤œå‡ºï¼‰
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã®æ”¹å–„

### 4.6 ã—ãŠã‚Šãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„
- [ ] éª¨çµ„ã¿æ®µéšã®ãƒãƒ¼ã‚¸å‡¦ç†
- [ ] æ—¥ç¨‹è©³ç´°åŒ–ã®ãƒãƒ¼ã‚¸å‡¦ç†ï¼ˆæ—¢å­˜ã®æ—¥ã‚’ä¿æŒï¼‰
- [ ] ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã®è‡ªå‹•æ¤œå‡º

### 4.7 ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°
- [ ] éª¨çµ„ã¿ä½œæˆã®ãƒ†ã‚¹ãƒˆ
- [ ] æ—¥ç¨‹è©³ç´°åŒ–ã®ãƒ†ã‚¹ãƒˆï¼ˆè¤‡æ•°æ—¥ï¼‰
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»‹å…¥ï¼ˆä¿®æ­£è¦æ±‚ï¼‰ã®ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

## ğŸ¨ æœŸå¾…ã•ã‚Œã‚‹UX

### åˆå›åˆ©ç”¨æ™‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "3æœˆã«2æ³Š3æ—¥ã§äº¬éƒ½æ—…è¡Œã«è¡ŒããŸã„"

AI: "ç´ æ•µã§ã™ã­ï¼äº¬éƒ½ã¸ã®2æ³Š3æ—¥ã®æ—…è¡Œã§ã™ã­ã€‚
     å°‘ã—è©³ã—ãæ•™ãˆã¦ãã ã•ã„ï¼š
     - ä½•åã§è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿ
     - èˆˆå‘³ã®ã‚ã‚‹ã“ã¨ã¯ï¼Ÿï¼ˆå¯ºç¤¾ã€ã‚°ãƒ«ãƒ¡ã€è‡ªç„¶ãªã©ï¼‰"

ãƒ¦ãƒ¼ã‚¶ãƒ¼: "2äººã§ã€å¯ºç¤¾ã¨ã‚°ãƒ«ãƒ¡ã«èˆˆå‘³ãŒã‚ã‚Šã¾ã™"

AI: "æ‰¿çŸ¥ã—ã¾ã—ãŸï¼ãã‚Œã§ã¯ã€äº¬éƒ½2æ³Š3æ—¥ã®æ—…ç¨‹ã®éª¨çµ„ã¿ã‚’ä½œæˆã—ã¾ã™ã€‚

     ã€æ—…ç¨‹ã®éª¨çµ„ã¿ã€‘
     1æ—¥ç›®: äº¬éƒ½åˆ°ç€ãƒ»æ±å±±ã‚¨ãƒªã‚¢æ•£ç­–
       æ¸…æ°´å¯ºå‘¨è¾ºã®å¯ºç¤¾å·¡ã‚Šã¨äº¬æ–™ç†ã‚’æ¥½ã—ã‚€æ—¥
     
     2æ—¥ç›®: åµå±±ãƒ»ç«¹æ—ã‚¨ãƒªã‚¢
       è‡ªç„¶è±Šã‹ãªåµå±±ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€ç²¾é€²æ–™ç†ä½“é¨“
     
     3æ—¥ç›®: é‡‘é–£å¯ºã‚¨ãƒªã‚¢ãƒ»å¸°è·¯
       äº¬éƒ½è¦³å…‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨æœ€å¾Œã®ã‚°ãƒ«ãƒ¡

     ã“ã®ãƒ—ãƒ©ãƒ³ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€1æ—¥ç›®ã®è©³ç´°ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
     ã€Œæ¬¡ã¸ã€ã¨å…¥åŠ›ã™ã‚‹ã‹ã€ä¿®æ­£ã—ãŸã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚"

ãƒ¦ãƒ¼ã‚¶ãƒ¼: "æ¬¡ã¸"

AI: "1æ—¥ç›®ã®è©³ç´°ãªè¦³å…‰ã‚¹ãƒãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ï¼

     ã€1æ—¥ç›®: äº¬éƒ½åˆ°ç€ãƒ»æ±å±±ã‚¨ãƒªã‚¢æ•£ç­–ã€‘
     
     10:00 æ¸…æ°´å¯ºï¼ˆ90åˆ†ï¼‰
       - ä¸–ç•Œéºç”£ã®ååˆ¹ã€æ¸…æ°´ã®èˆå°ã‹ã‚‰ã®çµ¶æ™¯
       - æ‹è¦³æ–™: 400å††/äºº
       
     12:00 æ˜¼é£Ÿ: ãŠã°ã‚“ã–ã„ãƒ©ãƒ³ãƒï¼ˆ60åˆ†ï¼‰
       - æ¸…æ°´å¯ºè¿‘ãã®äº¬æ–™ç†ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³
       - äºˆç®—: 2,000å††/äºº
       
     ...ï¼ˆä»¥ä¸‹ç¶šãï¼‰

     ã“ã®æ—¥ç¨‹ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€2æ—¥ç›®ã®è©³ç´°ã‚’ä½œæˆã—ã¾ã™ã€‚"
```

## ğŸš€ å®Ÿè£…é †åº

1. **Week 1**: å‹å®šç¾©ãƒ»çŠ¶æ…‹ç®¡ç†ã®æ‹¡å¼µï¼ˆ4.1, 4.2ï¼‰
2. **Week 1-2**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„ï¼ˆ4.3ï¼‰
3. **Week 2**: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…ï¼ˆ4.4ï¼‰
4. **Week 2**: APIçµ±åˆãƒ»ãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ4.5, 4.6ï¼‰
5. **Week 2**: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ï¼ˆ4.7ï¼‰

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

- [ ] éª¨çµ„ã¿ä½œæˆã‹ã‚‰å®Œæˆã¾ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿·ã‚ãšé€²ã‚ã‚‰ã‚Œã‚‹
- [ ] å„æ®µéšã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿®æ­£ã‚’åŠ ãˆã‚‰ã‚Œã‚‹
- [ ] AIã®ç”Ÿæˆç²¾åº¦ãŒå‘ä¸Šã™ã‚‹ï¼ˆæ®µéšçš„ã«ç„¦ç‚¹ã‚’çµã‚‹ãŸã‚ï¼‰
- [ ] å¤§è¦æ¨¡ãªæ—…ç¨‹ï¼ˆ5æ—¥ä»¥ä¸Šï¼‰ã§ã‚‚å®‰å®šã—ã¦å‹•ä½œã™ã‚‹

---

**æ›´æ–°æ—¥**: 2025-10-07  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆå®Œäº†ãƒ»å®Ÿè£…å¾…ã¡


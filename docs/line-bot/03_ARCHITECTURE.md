# LINE Bot ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ](#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
5. [ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†](#ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
7. [æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æˆ¦ç•¥](#æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æˆ¦ç•¥)
8. [ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£](#ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£)

---

## æ¦‚è¦

Journee LINE botã¯ã€æ—¢å­˜ã®Webç‰ˆã®æ©Ÿèƒ½ã‚’æœ€å¤§é™å†åˆ©ç”¨ã—ã¤ã¤ã€LINEãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ç‰¹æ€§ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¾ã™ã€‚

### è¨­è¨ˆã®åŸºæœ¬æ–¹é‡

1. **æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã®å†åˆ©ç”¨**: AIãƒ­ã‚¸ãƒƒã‚¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã‚’100%å†åˆ©ç”¨
2. **éåŒæœŸå‡¦ç†**: Webhookå¿œç­”æ™‚é–“åˆ¶é™ï¼ˆ30ç§’ï¼‰ã«å¯¾å¿œã—ãŸéåŒæœŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
3. **æ®µéšçš„é€ä¿¡**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’è§£æã—ã€å°å‡ºã—ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
4. **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹**: ã‚µãƒ¼ãƒãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã«ä¿ã¡ã€çŠ¶æ…‹ã¯ã™ã¹ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç®¡ç†

---

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          LINE Platform                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LINE Client  â”‚ â—„â”€â”€â”€â”€ Push Message â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Messaging API   â”‚  â”‚
â”‚  â”‚ (User's App) â”‚                              â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                              â–²            â”‚
â”‚         â”‚ User Message                                 â”‚            â”‚
â”‚         â–¼                                              â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”‚                     Webhook                                      â”‚
â””â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ POST /api/line/webhook
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Journee Backend (Next.js)                      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    API Routes Layer                           â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  /api/line/webhook â”€â”€â”                                       â”‚ â”‚
â”‚  â”‚                       â”‚                                       â”‚ â”‚
â”‚  â”‚                       â”œâ”€â–º Signature Verification             â”‚ â”‚
â”‚  â”‚                       â”‚                                       â”‚ â”‚
â”‚  â”‚                       â”œâ”€â–º Event Router                        â”‚ â”‚
â”‚  â”‚                       â”‚    â”œâ”€ Text Message Handler           â”‚ â”‚
â”‚  â”‚                       â”‚    â”œâ”€ Postback Handler               â”‚ â”‚
â”‚  â”‚                       â”‚    â”œâ”€ Follow/Unfollow Handler        â”‚ â”‚
â”‚  â”‚                       â”‚    â””â”€ Location Handler               â”‚ â”‚
â”‚  â”‚                       â”‚                                       â”‚ â”‚
â”‚  â”‚                       â””â”€â–º Async Message Processor             â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  Business Logic Layer                         â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚   AI Integration       â”‚  â”‚  Message Processing        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                        â”‚  â”‚                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Gemini Client       â”‚  â”‚  - Stream Parser           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Claude Client       â”‚  â”‚  - Message Formatter       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Prompt Manager      â”‚  â”‚  - Flex Message Builder    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Reuse from Web ver.) â”‚  â”‚                            â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚   Session Manager      â”‚  â”‚  Itinerary Builder         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                        â”‚  â”‚                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - User Context        â”‚  â”‚  - Planning Logic          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Conversation State  â”‚  â”‚  - Spot Extraction         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Cache Management    â”‚  â”‚  (Reuse from Web ver.)     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Data Access Layer                           â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  - User Repository                                            â”‚ â”‚
â”‚  â”‚  - Itinerary Repository (Reuse from Web ver.)                 â”‚ â”‚
â”‚  â”‚  - Session Repository                                         â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase (PostgreSQL)                          â”‚
â”‚                                                                     â”‚
â”‚  - users (extended with line_user_id)                               â”‚
â”‚  - itineraries                                                      â”‚
â”‚  - line_sessions (new table)                                        â”‚
â”‚  - line_messages (new table for logging)                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

### 1. API Routes Layer

#### `/app/api/line/webhook/route.ts`

**è²¬å‹™**: LINEã‹ã‚‰ã®Webhookãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã€å³åº§ã«200 OKã‚’è¿”ã™

```typescript
// app/api/line/webhook/route.ts
import { validateSignature } from '@/lib/line/signature-validator';
import { processEventAsync } from '@/lib/line/event-processor';

export async function POST(req: Request) {
  const signature = req.headers.get('x-line-signature');
  const body = await req.text();
  
  // ç½²åæ¤œè¨¼ï¼ˆåŒæœŸå‡¦ç†ï¼‰
  if (!validateSignature(body, signature, process.env.LINE_CHANNEL_SECRET!)) {
    return new Response('Unauthorized', { status: 401 });
  }
  
  const webhookBody = JSON.parse(body);
  
  // å³åº§ã«200 OKã‚’è¿”ã™
  const response = new Response('OK', { status: 200 });
  
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§éåŒæœŸå‡¦ç†
  // æ³¨: Next.jsã®Edge Runtimeã§ã¯åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€å®Ÿè£…ã«æ³¨æ„
  webhookBody.events.forEach((event: any) => {
    processEventAsync(event).catch(console.error);
  });
  
  return response;
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- ç½²åæ¤œè¨¼ã¯å¿…é ˆï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
- 30ç§’ä»¥å†…ã«å¿œç­”ã™ã‚‹ãŸã‚ã€å³åº§ã«200 OKã‚’è¿”ã™
- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã¯éåŒæœŸã§å®Ÿè¡Œ

#### `/app/api/line/message/route.ts`ï¼ˆç®¡ç†è€…ç”¨ï¼‰

**è²¬å‹™**: ç®¡ç†è€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹API

```typescript
// app/api/line/message/route.ts
export async function POST(req: Request) {
  // ç®¡ç†è€…èªè¨¼ãƒã‚§ãƒƒã‚¯
  const session = await getServerSession(authOptions);
  if (!session || !isAdmin(session.user)) {
    return new Response('Forbidden', { status: 403 });
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯
  // ...
}
```

### 2. Business Logic Layer

#### `/lib/line/event-processor.ts`

**è²¬å‹™**: ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒ©ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```typescript
// lib/line/event-processor.ts
import { WebhookEvent } from '@line/bot-sdk';
import { handleTextMessage } from './handlers/text-message-handler';
import { handlePostback } from './handlers/postback-handler';
import { handleFollow } from './handlers/follow-handler';

export async function processEventAsync(event: WebhookEvent) {
  try {
    switch (event.type) {
      case 'message':
        if (event.message.type === 'text') {
          await handleTextMessage(event);
        } else if (event.message.type === 'location') {
          await handleLocation(event);
        }
        break;
      
      case 'postback':
        await handlePostback(event);
        break;
      
      case 'follow':
        await handleFollow(event);
        break;
      
      case 'unfollow':
        await handleUnfollow(event);
        break;
      
      default:
        console.log('Unsupported event type:', event.type);
    }
  } catch (error) {
    console.error('Error processing event:', error);
    // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡
    await sendErrorMessage(event.source.userId);
  }
}
```

#### `/lib/line/handlers/text-message-handler.ts`

**è²¬å‹™**: ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã€AIå‡¦ç†ã‚’å®Ÿè¡Œ

```typescript
// lib/line/handlers/text-message-handler.ts
import { MessageEvent } from '@line/bot-sdk';
import { lineClient } from '../client';
import { getOrCreateSession } from '../session-manager';
import { processItineraryCreation } from '../itinerary-processor';

export async function handleTextMessage(event: MessageEvent) {
  const userId = event.source.userId!;
  const userMessage = event.message.type === 'text' ? event.message.text : '';
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
  const session = await getOrCreateSession(userId);
  
  // ã€Œè€ƒãˆä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  await lineClient.pushMessage(userId, {
    type: 'text',
    text: 'ğŸ¤” æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’è€ƒãˆã¦ã„ã¾ã™...',
  });
  
  // AIå‡¦ç†ã¨æ®µéšçš„é€ä¿¡
  await processItineraryCreation(userId, userMessage, session);
}
```

#### `/lib/line/itinerary-processor.ts`

**è²¬å‹™**: AIã‚’ä½¿ã£ã¦ã—ãŠã‚Šã‚’ä½œæˆã—ã€æ®µéšçš„ã«é€ä¿¡

```typescript
// lib/line/itinerary-processor.ts
import { streamGeminiResponse } from '@/lib/ai/gemini';
import { LINEStreamParser } from './stream-parser';
import { lineClient } from './client';

export async function processItineraryCreation(
  userId: string,
  userMessage: string,
  session: UserSession
) {
  // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ‘ãƒ¼ã‚µãƒ¼ã®åˆæœŸåŒ–
  const parser = new LINEStreamParser({
    onSpotExtracted: async (spot) => {
      // è¦³å…‰åœ°ãŒæŠ½å‡ºã•ã‚ŒãŸã‚‰å³åº§ã«é€ä¿¡
      const flexMessage = createSpotFlexMessage(spot);
      await lineClient.pushMessage(userId, flexMessage);
    },
    onMealExtracted: async (meal) => {
      // é£Ÿäº‹æƒ…å ±ãŒæŠ½å‡ºã•ã‚ŒãŸã‚‰å³åº§ã«é€ä¿¡
      const flexMessage = createMealFlexMessage(meal);
      await lineClient.pushMessage(userId, flexMessage);
    },
    onComplete: async (itinerary) => {
      // å®Œæˆã—ãŸã—ãŠã‚Šå…¨ä½“ã‚’ä¿å­˜ãƒ»é€ä¿¡
      await saveItinerary(userId, itinerary);
      const summaryMessage = createItinerarySummary(itinerary);
      await lineClient.pushMessage(userId, summaryMessage);
    },
  });
  
  // AIå¿œç­”ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å–å¾—ã—ã€ãƒ‘ãƒ¼ã‚¹
  await streamGeminiResponse({
    messages: [...session.messages, { role: 'user', content: userMessage }],
    onChunk: (chunk) => parser.addChunk(chunk),
    onComplete: () => parser.finalize(),
  });
}
```

#### `/lib/line/stream-parser.ts`

**è²¬å‹™**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚’è§£æã—ã€ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º

```typescript
// lib/line/stream-parser.ts
export class LINEStreamParser {
  private buffer: string = '';
  private callbacks: {
    onSpotExtracted?: (spot: SpotMessage) => Promise<void>;
    onMealExtracted?: (meal: SpotMessage) => Promise<void>;
    onComplete?: (itinerary: ItineraryData) => Promise<void>;
  };
  
  constructor(callbacks: typeof this.callbacks) {
    this.callbacks = callbacks;
  }
  
  addChunk(chunk: string) {
    this.buffer += chunk;
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§è¦³å…‰åœ°ã‚’æŠ½å‡º
    const spotPattern = /ã€è¦³å…‰åœ°ã€‘\s*(.+?)\nèª¬æ˜ï¼š(.+?)(?:\n|$)/g;
    let match;
    
    while ((match = spotPattern.exec(this.buffer)) !== null) {
      const spot: SpotMessage = {
        type: 'tourist_spot',
        name: match[1].trim(),
        description: match[2].trim(),
      };
      
      this.callbacks.onSpotExtracted?.(spot);
    }
    
    // åŒæ§˜ã«é£Ÿäº‹ã€æ­“æ¥½è¡—ãªã©ã‚‚æŠ½å‡º
    // ...
  }
  
  finalize() {
    // æœ€çµ‚çš„ãªã—ãŠã‚Šãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
    const itinerary = this.buildItinerary();
    this.callbacks.onComplete?.(itinerary);
  }
  
  private buildItinerary(): ItineraryData {
    // ãƒãƒƒãƒ•ã‚¡å…¨ä½“ã‹ã‚‰å®Œå…¨ãªã—ãŠã‚Šã‚’æ§‹ç¯‰
    // ...
  }
}
```

### 3. Data Access Layer

#### `/lib/line/session-manager.ts`

**è²¬å‹™**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç®¡ç†ï¼ˆä¼šè©±å±¥æ­´ã€çŠ¶æ…‹ï¼‰

```typescript
// lib/line/session-manager.ts
import { supabase } from '@/lib/db/supabase';

export interface UserSession {
  userId: string;
  lineUserId: string;
  messages: Message[];
  currentItineraryId?: string;
  state: 'idle' | 'planning' | 'detailing';
  createdAt: Date;
  updatedAt: Date;
}

export async function getOrCreateSession(lineUserId: string): Promise<UserSession> {
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
  const { data: session } = await supabase
    .from('line_sessions')
    .select('*')
    .eq('line_user_id', lineUserId)
    .single();
  
  if (session) {
    return session;
  }
  
  // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
  const { data: newSession } = await supabase
    .from('line_sessions')
    .insert({
      line_user_id: lineUserId,
      messages: [],
      state: 'idle',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    })
    .select()
    .single();
  
  return newSession;
}

export async function updateSession(userId: string, updates: Partial<UserSession>) {
  await supabase
    .from('line_sessions')
    .update({
      ...updates,
      updated_at: new Date().toISOString(),
    })
    .eq('line_user_id', userId);
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‹ã‚‰ã—ãŠã‚Šå®Œæˆã¾ã§ã®æµã‚Œ

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
   ã€Œäº¬éƒ½ã«2æ³Š3æ—¥ã§æ—…è¡Œã—ãŸã„ã€
   
   â†“

2. LINE PlatformãŒwebhookã‚’å‘¼ã³å‡ºã—
   POST /api/line/webhook
   
   â†“

3. Signatureæ¤œè¨¼ â†’ 200 OKå³åº§ã«è¿”ã™
   
   â†“

4. éåŒæœŸã§ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†é–‹å§‹
   processEventAsync(event)
   
   â†“

5. ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãŒå®Ÿè¡Œ
   handleTextMessage(event)
   
   â”œâ”€â–º ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—/ä½œæˆ
   â”‚   getOrCreateSession(userId)
   â”‚
   â”œâ”€â–º ã€Œè€ƒãˆä¸­...ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
   â”‚   lineClient.pushMessage()
   â”‚
   â””â”€â–º AIå‡¦ç†é–‹å§‹
       processItineraryCreation()
       
       â†“

6. AIå¿œç­”ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å–å¾—
   streamGeminiResponse()
   
   â”œâ”€â–º ãƒãƒ£ãƒ³ã‚¯ã”ã¨ã«ãƒ‘ãƒ¼ã‚µãƒ¼ã«æ¸¡ã™
   â”‚   parser.addChunk(chunk)
   â”‚
   â””â”€â–º ãƒ‘ãƒ¼ã‚µãƒ¼ãŒãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
       
       â”œâ”€â–º è¦³å…‰åœ°ã‚’æ¤œå‡º
       â”‚   â†’ createSpotFlexMessage()
       â”‚   â†’ lineClient.pushMessage()  â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å³åº§ã«é€ä¿¡
       â”‚
       â”œâ”€â–º é£Ÿäº‹æƒ…å ±ã‚’æ¤œå‡º
       â”‚   â†’ createMealFlexMessage()
       â”‚   â†’ lineClient.pushMessage()  â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å³åº§ã«é€ä¿¡
       â”‚
       â””â”€â–º æ­“æ¥½è¡—ã‚’æ¤œå‡º
           â†’ createEntertainmentFlexMessage()
           â†’ lineClient.pushMessage()  â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å³åº§ã«é€ä¿¡
   
   â†“

7. AIå¿œç­”å®Œäº†
   parser.finalize()
   
   â”œâ”€â–º å®Œå…¨ãªã—ãŠã‚Šãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
   â”‚   buildItinerary()
   â”‚
   â”œâ”€â–º ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
   â”‚   saveItinerary()
   â”‚
   â””â”€â–º ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
       createItinerarySummary()
       lineClient.pushMessage()  â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡
   
   â†“

8. ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
   updateSession()
   
   â†“

9. å®Œäº†
```

---

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¨®é¡

| ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¨®é¡ | ä¿å­˜å ´æ‰€ | æœ‰åŠ¹æœŸé™ | ç”¨é€” |
|-------------|---------|---------|------|
| **ä¼šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³** | PostgreSQL | 24æ™‚é–“ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã€çŠ¶æ…‹ç®¡ç† |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±** | PostgreSQL | æ°¸ç¶š | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€è¨­å®š |
| **ä¸€æ™‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥** | Redisï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ | 1æ™‚é–“ | AIå¿œç­”ã®ä¸€æ™‚ä¿å­˜ |

### ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹é·ç§»

```
idleï¼ˆã‚¢ã‚¤ãƒ‰ãƒ«ï¼‰
  â†“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
planningï¼ˆè¨ˆç”»ä¸­ï¼‰
  â†“ åŸºæœ¬æƒ…å ±åé›†å®Œäº†
detailingï¼ˆè©³ç´°åŒ–ä¸­ï¼‰
  â†“ ã—ãŠã‚Šå®Œæˆ
completedï¼ˆå®Œäº†ï¼‰
  â†“ 24æ™‚é–“å¾Œ
idleï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### `line_sessions` ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE line_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  line_user_id TEXT NOT NULL UNIQUE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  messages JSONB DEFAULT '[]'::jsonb,
  state TEXT DEFAULT 'idle',
  current_itinerary_id UUID REFERENCES itineraries(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_line_sessions_line_user_id ON line_sessions(line_user_id);
CREATE INDEX idx_line_sessions_user_id ON line_sessions(user_id);
```

#### `line_messages` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒ­ã‚°ç”¨ï¼‰

```sql
CREATE TABLE line_messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  line_user_id TEXT NOT NULL,
  direction TEXT NOT NULL, -- 'incoming' or 'outgoing'
  message_type TEXT NOT NULL, -- 'text', 'flex', etc.
  content JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_line_messages_line_user_id ON line_messages(line_user_id);
CREATE INDEX idx_line_messages_created_at ON line_messages(created_at);
```

### æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µ

#### `users` ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
ALTER TABLE users ADD COLUMN line_user_id TEXT UNIQUE;
CREATE INDEX idx_users_line_user_id ON users(line_user_id);
```

---

## æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æˆ¦ç•¥

### å†åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ãƒ•ã‚¡ã‚¤ãƒ« | å†åˆ©ç”¨ç‡ |
|-------------|---------|---------|
| **AIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ** | `/lib/ai/gemini.ts`, `/lib/ai/claude.ts` | 100% |
| **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ** | `/lib/ai/prompts.ts` | 100% |
| **ã—ãŠã‚Šãƒªãƒã‚¸ãƒˆãƒª** | `/lib/db/itinerary-repository.ts` | 95% |
| **å‹å®šç¾©** | `/types/itinerary.ts` | 90% |
| **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£** | `/lib/utils/*.ts` | 80% |

### å†åˆ©ç”¨ã®ä¾‹

```typescript
// Webç‰ˆã¨LINE botç‰ˆã§åŒã˜AIãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
import { streamGeminiResponse } from '@/lib/ai/gemini';
import { getItineraryPrompt } from '@/lib/ai/prompts';

// Webç‰ˆ: SSEã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”
export async function POST(req: Request) {
  const stream = await streamGeminiResponse({ ... });
  return new Response(stream, { headers: { 'Content-Type': 'text/event-stream' } });
}

// LINE botç‰ˆ: æ®µéšçš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
export async function processItineraryCreation(...) {
  await streamGeminiResponse({
    onChunk: (chunk) => parser.addChunk(chunk),
  });
}
```

---

## ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### è² è·å¯¾ç­–

| å¯¾ç­– | å®Ÿè£… | åŠ¹æœ |
|------|------|------|
| **æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°** | Kubernetes ReplicaSet | åŒæ™‚æ¥ç¶šæ•°ã«å¿œã˜ã¦Podè‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ« |
| **éåŒæœŸå‡¦ç†** | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ– | Webhookå¿œç­”æ™‚é–“ã‚’æœ€å°åŒ– |
| **ã‚­ãƒ£ãƒƒã‚·ãƒ¥** | Redisï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ | DBè² è·è»½æ¸› |
| **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** | API Gateway | éè² è·é˜²æ­¢ |

### æƒ³å®šè² è·

- **ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°**: ã€œ10,000äºº
- **åŒæ™‚æ¥ç¶š**: ã€œ100äºº
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸/ç§’**: ã€œ10 msg/s
- **AIå‡¦ç†æ™‚é–“**: 5-10ç§’/ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£ã—ãŸã‚‰ã€æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«é€²ã‚“ã§ãã ã•ã„ï¼š

- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¨­è¨ˆã™ã‚‹**: [04_MESSAGE_FORMAT.md](./04_MESSAGE_FORMAT.md)
- **å®Ÿè£…ã‚’å§‹ã‚ã‚‹**: [05_BACKEND_API.md](./05_BACKEND_API.md)

---

**æœ€çµ‚æ›´æ–°**: 2025-10-10  
**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [01_OVERVIEW.md](./01_OVERVIEW.md), [04_MESSAGE_FORMAT.md](./04_MESSAGE_FORMAT.md)

# 保存済み表示改善実装

## 概要

ユーザーフィードバック「保存済み表示がわかりづらい」に対応し、LocalStorageとデータベース保存の区別を明確化する実装。

**Issue**: [機能要望] 保存済み表示がわかりづらい
**実装日**: 2025-10-10

## 問題点

- 保存済み表示がLocalStorageにのみ保存されており、データベースに保存されていない
- ログイン/未ログインで保存先が異なることがユーザーに伝わっていない
- ブラウザデータ削除時にしおりが失われるリスクがある

## 実装内容

### 1. 新規型定義の追加 (`types/save.ts`)

保存機能に関する型定義を追加:

- `SaveLocation`: 保存先の種類（'browser' | 'database' | 'both'）
- `SaveState`: 保存状態の詳細情報
- `AutoSaveConfig`: 自動保存の設定

### 2. Zustandストアの拡張 (`lib/store/useStore.ts`)

保存状態の追跡機能を追加:

- `saveLocation`: 最後に保存した場所
- `dbSaveSuccess`: データベース保存が成功したか
- `setSaveLocation()`: 保存場所を設定
- `setDbSaveSuccess()`: DB保存成功状態を設定

### 3. 自動保存機能の強化 (`components/layout/AutoSave.tsx`)

**ログインユーザー向け**:
- LocalStorage保存: 変更から2秒後（即座のフィードバック用）
- データベース保存: 変更から5秒後（API負荷軽減）
- 定期保存: 5分ごとに両方に保存

**未ログインユーザー向け**:
- LocalStorage保存のみ: 変更から2秒後
- 定期保存: 5分ごと

**主な変更点**:
```typescript
// LocalStorageとデータベース保存を分離
const performLocalStorageSave = useCallback(...)
const performDatabaseSave = useCallback(...)

// 統合保存処理で両方を管理
const performSave = useCallback(async (itinerary, includeDatabase = true) => {
  const localStorageSuccess = performLocalStorageSave(itinerary);
  let databaseSuccess = false;

  if (includeDatabase && session?.user) {
    databaseSuccess = await performDatabaseSave(itinerary);
  }

  // 保存場所を記録
  if (localStorageSuccess && databaseSuccess) {
    setSaveLocation('both');
  } else if (databaseSuccess) {
    setSaveLocation('database');
  } else if (localStorageSuccess) {
    setSaveLocation('browser');
  }
})
```

### 4. 保存状態表示の改善 (`components/ui/SaveStatus.tsx`)

保存場所を明示的に表示:

- **データベース保存済み**: 緑色のチェックマーク + "データベースに保存済み"
- **ブラウザ保存（ログインユーザー）**: 黄色のハードドライブアイコン + "ブラウザに一時保存"
- **ブラウザ保存（未ログインユーザー）**: 黄色のハードドライブアイコン + "ブラウザに保存済み" + "※ログインすると永続的に保存されます"

**アイコンの使い分け**:
- `Check`: データベース保存成功
- `Database`: データベースのみ保存
- `HardDrive`: ブラウザのみ保存
- `Save`: 保存中
- `AlertCircle`: 未保存

### 5. ログインプロンプトバナーの追加 (`components/ui/LoginPromptBanner.tsx`)

未ログインユーザーにログインを促すバナーを追加:

**表示条件**:
- 未ログイン状態
- しおりが存在する
- ユーザーが閉じていない（セッション中のみ記憶）

**デザイン**:
- 黄色の背景で注意を引く
- ブラウザ保存のリスクを説明
- データベース保存のメリットを提示
- 「ログインして保存」ボタン

**配置**:
- `ItineraryPreview`コンポーネントの最上部
- ヘッダーの直下、コンテンツの前

### 6. 保存ボタンの説明強化 (`components/itinerary/SaveButton.tsx`)

**ツールチップの追加**:
- ログインユーザー: "データベースに保存します"
- 未ログインユーザー: "ブラウザに保存します（ログインするとデータベースに保存されます）"

**説明テキストの追加**（未ログインユーザーのみ）:
```
※現在はブラウザにのみ保存されます。ログインするとデータベースに永続的に保存されます。
```

## UX改善効果

### Before（改善前）
- 「保存済み」と表示されるが、どこに保存されているか不明
- ログイン/未ログインで挙動が違うことが分からない
- ブラウザデータ削除時のリスクに気づかない

### After（改善後）
- 保存場所が明示的に表示される（"データベース" or "ブラウザ"）
- ログインのメリットが分かりやすく提示される
- 未ログインユーザーには積極的にログインを促す
- ブラウザ保存のリスクが理解できる

## 技術的考慮事項

### デバウンス時間の設計

**LocalStorage: 2秒**
- ユーザーへの即座のフィードバック
- ブラウザクラッシュ時のデータロス最小化
- ストレージ操作は軽量なため短い間隔でも問題なし

**データベース: 5秒**
- API呼び出しのコスト削減
- サーバー負荷の軽減
- ネットワーク遅延を考慮

**定期保存: 5分**
- 長時間編集時の保険
- ユーザーが保存を忘れた場合の対策

### エラーハンドリング

- LocalStorage保存失敗時もデータベース保存は継続
- データベース保存失敗時もLocalStorage保存は成功
- 部分的な保存成功でも適切な状態表示

### パフォーマンス

- LocalStorageとDB保存を並列実行ではなく直列実行（状態の一貫性確保）
- デバウンスにより不要なAPI呼び出しを削減
- 保存状態の追跡により重複保存を防止

## 今後の拡張可能性

1. **オフライン対応**
   - Service Workerによるオフライン編集
   - オンライン復帰時の自動同期

2. **競合解決**
   - 複数デバイス編集時の競合検出
   - マージ戦略の実装

3. **保存履歴**
   - バージョン管理機能
   - 過去のしおりへの復元

4. **保存統計**
   - 保存回数のトラッキング
   - データ量の可視化

## テスト計画

### 手動テスト項目

- [ ] ログインユーザー: データベース保存が正常に動作する
- [ ] ログインユーザー: SaveStatusに「データベースに保存済み」と表示される
- [ ] 未ログインユーザー: LocalStorage保存のみが動作する
- [ ] 未ログインユーザー: SaveStatusに「ブラウザに保存済み」と表示される
- [ ] 未ログインユーザー: LoginPromptBannerが表示される
- [ ] LoginPromptBanner: 閉じるボタンで非表示になる
- [ ] SaveButton: ツールチップが適切に表示される
- [ ] SaveButton: 未ログインユーザーに説明文が表示される

### E2Eテスト（今後の実装）

```typescript
test('ログインユーザーはデータベースに保存される', async ({ page }) => {
  // ログイン
  // しおり作成
  // 5秒待機
  // SaveStatusを確認: "データベースに保存済み"
});

test('未ログインユーザーにLoginPromptBannerが表示される', async ({ page }) => {
  // 未ログイン状態
  // しおり作成
  // LoginPromptBannerの表示を確認
});
```

## リリースノート

### ユーザー向けメッセージ

**保存機能の改善**

しおりの保存状態がより分かりやすくなりました！

- 保存場所（ブラウザ/データベース）が明示的に表示されるようになりました
- ログインすると、しおりがデータベースに自動保存されるようになりました
- 未ログインの場合、ログインを促すメッセージが表示されます
- ブラウザ保存のリスクとデータベース保存のメリットが分かりやすくなりました

**重要**: 未ログインの場合、しおりはブラウザにのみ保存されます。ブラウザのデータを削除すると失われる可能性がありますので、大切なしおりはログインして保存することをお勧めします。

---

**実装者**: @cursoragent  
**レビュー**: 必要  
**デプロイ**: Phase 11として実施

# プルトゥリフレッシュ機能

## 概要

モバイルデバイスで画面を下に引っ張ることでコンテンツを再読み込みできる機能を実装しました。

## 実装されたページ

### 1. マイページ (`/mypage`)
- ユーザーのしおり一覧を再読み込み
- 統計情報の更新

### 2. しおり一覧ページ (`/itineraries`)
- 全てのしおりを再読み込み
- フィルター/ソート設定を維持したまま更新

## 技術詳細

### 実装ファイル

#### 1. カスタムフック: `lib/hooks/usePullToRefresh.ts`
プルトゥリフレッシュのコアロジックを提供するカスタムフック

**主要な機能:**
- タッチイベントの検出と処理
- プルダウン距離の計算
- リフレッシュ可能状態の判定
- 減衰効果による滑らかな操作感

**オプション:**
```typescript
interface PullToRefreshOptions {
  onRefresh: () => Promise<void>;        // リフレッシュ処理
  pullDownThreshold?: number;            // しきい値（デフォルト: 80px）
  disabled?: boolean;                    // 無効化フラグ
  maxPullDistance?: number;              // 最大プル距離（デフォルト: 150px）
}
```

**返り値:**
```typescript
interface PullToRefreshState {
  pullDistance: number;      // 現在のプルダウン距離
  isRefreshing: boolean;     // リフレッシュ中フラグ
  canRelease: boolean;       // リリース可能フラグ
}
```

#### 2. UIコンポーネント: `components/ui/PullToRefresh.tsx`
ビジュアルフィードバックを提供するラッパーコンポーネント

**機能:**
- プルダウンインジケーターの表示
- アニメーション効果
- ローディングスピナー
- 状態に応じたメッセージ表示

**使用方法:**
```tsx
<PullToRefresh onRefresh={async () => { await loadData(); }}>
  <YourContent />
</PullToRefresh>
```

#### 3. 統合コンポーネント
- `components/mypage/MyPageContent.tsx` - マイページコンテンツ
- `components/itinerary/ItineraryList.tsx` - しおり一覧

## UX/UI詳細

### 視覚的フィードバック

1. **プル開始時**
   - 下矢印アイコンが表示される
   - 「引っ張って更新」というテキストが表示される
   - アイコンがグレーで表示される

2. **しきい値到達前**
   - プル距離に応じてアイコンが回転
   - インジケーターの透明度が増加

3. **しきい値到達後**
   - アイコンが180度回転（上向き矢印に）
   - アイコンとテキストが青色に変化
   - 「離して更新」というテキストに変更

4. **リフレッシュ中**
   - ローディングスピナーが表示される
   - 「更新中...」というテキストが表示される
   - コンテンツが60px下にオフセット

### アニメーション

- **トランジション**: 200ms のスムーズな遷移
- **減衰効果**: プル距離に0.5倍の係数を適用
- **最大距離**: 150pxまで制限

## 動作条件

### プルトゥリフレッシュが有効になる条件:
1. ページのスクロール位置が最上部（scrollTop === 0）
2. タッチデバイスでの操作
3. 下方向へのスワイプ

### 無効化される条件:
- `disabled` プロパティが `true`
- すでにリフレッシュ中
- スクロール位置が上部でない

## ブラウザ互換性

- **モバイルブラウザ**: iOS Safari, Chrome Mobile, Firefox Mobile
- **タッチデバイス**: iPad, タブレット、タッチスクリーン付きPC
- **デスクトップ**: プルトゥリフレッシュは動作しないが、エラーも発生しない

## パフォーマンス最適化

1. **useCallback の使用**
   - イベントハンドラーのメモ化
   - 不要な再レンダリングの防止

2. **パッシブでないイベントリスナー**
   - スクロール防止のために `{ passive: false }` を使用
   - 必要な場合のみ `preventDefault()` を呼び出し

3. **減衰効果**
   - プル距離に係数を適用して滑らかな操作感を実現
   - 最大距離の制限によるパフォーマンス向上

## テスト方法

### 手動テスト（モバイルデバイス）

1. **マイページでのテスト**
   ```
   1. /mypage にアクセス
   2. ページを最上部までスクロール
   3. 画面を下方向にスワイプ
   4. 「離して更新」が表示されたら離す
   5. しおり一覧が更新されることを確認
   ```

2. **しおり一覧ページでのテスト**
   ```
   1. /itineraries にアクセス
   2. ページを最上部までスクロール
   3. 画面を下方向にスワイプ
   4. 「離して更新」が表示されたら離す
   5. しおりが更新されることを確認
   ```

### ブラウザDevToolsでのテスト

1. Chrome DevTools を開く
2. デバイスツールバーを有効化（Cmd+Shift+M / Ctrl+Shift+M）
3. モバイルデバイスを選択
4. 上記の手動テストを実行

## 今後の改善案

1. **ハプティックフィードバック**
   - Vibration API を使用した触覚フィードバック

2. **カスタマイズ可能なアニメーション**
   - ユーザー設定によるアニメーション速度の調整
   - カスタムアニメーションパターン

3. **オフライン対応**
   - オフライン時の適切なエラーハンドリング
   - キャッシュからのデータ読み込み

4. **アクセシビリティ**
   - スクリーンリーダー対応
   - キーボード操作によるリフレッシュ

5. **パフォーマンス監視**
   - リフレッシュ時間の計測
   - ユーザー行動の分析

## トラブルシューティング

### プルトゥリフレッシュが動作しない

**原因1: デスクトップブラウザで試している**
- 解決策: モバイルデバイスまたはDevToolsのデバイスモードを使用

**原因2: ページがスクロールされている**
- 解決策: ページを最上部までスクロール

**原因3: JavaScriptエラーが発生している**
- 解決策: ブラウザのコンソールを確認

### リフレッシュが完了しない

**原因: onRefresh関数でエラーが発生**
- 解決策: ネットワーク接続を確認、コンソールログを確認

## 参考リンク

- [Touch Events API (MDN)](https://developer.mozilla.org/en-US/docs/Web/API/Touch_events)
- [React Hooks (公式ドキュメント)](https://react.dev/reference/react)
- [Pull-to-Refresh Pattern (UX Design)](https://www.nngroup.com/articles/pull-to-refresh/)

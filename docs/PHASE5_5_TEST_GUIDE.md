# Phase 5.5: しおり公開・共有機能 テストガイド

**作成日**: 2025-10-07  
**更新日**: 2025-10-07（Critical Bug修正版）  
**対象**: Phase 5.5実装の動作確認

## 🔴 重要: バグ修正について

**LocalStorageキー名の不一致バグを修正しました**
- 修正前: `'public_itineraries'` ❌
- 修正後: `'journee_public_itineraries'` ✅

詳細: [PHASE5_5_CRITICAL_BUG_FIX.md](./PHASE5_5_CRITICAL_BUG_FIX.md)

## 🚀 クイックスタート（推奨）

最も簡単にテストする方法：

```bash
# 1. 開発サーバー起動
npm run dev

# 2. デバッグツールを開く
http://localhost:3000/debug-share.html

# 3. 「クイック公開テスト実行」ボタンをクリック
# → 自動的に公開ページが開く
# → しおりが表示されることを確認
```

## 📋 目次

1. [デバッグツール（推奨）](#デバッグツール)
2. [自動テスト](#自動テスト)
3. [手動テスト](#手動テスト)
4. [UIテスト](#uiテスト)
5. [統合テスト](#統合テスト)
6. [エラーケーステスト](#エラーケーステスト)

---

## 0. デバッグツール（推奨）

### 🔧 デバッグツール

**URL**: http://localhost:3000/debug-share.html

**機能**:
- ✅ リアルタイムステータス表示（サーバー、LocalStorage）
- ✅ LocalStorageビューア（データ確認）
- ✅ クイック公開テスト（ワンクリックで公開→ページ表示）
- ✅ URLテスター（スラッグの存在確認）
- ✅ デバッグログ（リアルタイムログ表示）

**使い方**:
1. デバッグツールを開く
2. 「クイック公開テスト実行」をクリック
3. 自動的に公開ページが開く
4. しおりが表示されるか確認
5. デバッグログで詳細を確認

### 📊 統合テストページ

**URL**: http://localhost:3000/test-share-integration.html

**機能**:
- ✅ Step-by-Stepテスト
- ✅ LocalStorageデータ作成
- ✅ データ確認
- ✅ 公開URL生成
- ✅ 公開ページ表示

**使い方**:
1. 統合テストページを開く
2. 「完全テストを実行」をクリック
3. ログを確認
4. 「公開ページを開く」で実際のページを確認

---

## 1. 自動テスト

### ブラウザテストページ

**アクセス**: http://localhost:3000/test-phase5-5.html

このページで以下のテストを実行できます：

#### テスト1: LocalStorage基本機能
- ✅ 1-1. 公開しおりの保存
- ✅ 1-2. 公開しおりの取得
- ✅ 1-3. 存在しないスラッグでの取得
- ✅ 1-4. 公開しおりの削除

#### テスト2: nanoid スラッグ生成
- ✅ 2-1. ユニークスラッグの生成（100個）
- ✅ 2-2. スラッグの形式チェック

#### テスト3: 公開URL生成
- ✅ 3-1. 公開URLフォーマットの確認

#### テスト4: エンドツーエンド
- ✅ 4-1. 公開→取得→非公開の一連の流れ

**実行方法**:
1. 開発サーバーを起動: `npm run dev`
2. ブラウザで http://localhost:3000/test-phase5-5.html を開く
3. 「すべてのテストを実行」ボタンをクリック
4. 各テスト結果を確認

---

## 2. 手動テスト

### 2-1. ブラウザコンソールテスト

開発者ツール（F12）のコンソールで以下を実行：

```javascript
// 1. しおりを作成（モック）
const mockItinerary = {
  id: 'test-1',
  title: '京都旅行',
  destination: '京都',
  schedule: [{
    day: 1,
    spots: [],
    totalCost: 0,
  }],
  status: 'completed',
  createdAt: new Date(),
  updatedAt: new Date(),
  isPublic: false,
};

// 2. Zustandストアにアクセス
const store = useStore.getState();

// 3. しおりを設定
store.setItinerary(mockItinerary);
console.log('✅ しおりを設定:', store.currentItinerary);

// 4. しおりを公開
const result = await store.publishItinerary({
  isPublic: true,
  allowPdfDownload: true,
  customMessage: 'テストメッセージ',
});
console.log('✅ 公開結果:', result);
// 期待: { success: true, publicUrl: "...", slug: "..." }

// 5. しおりの状態を確認
console.log('✅ 公開後のしおり:', {
  isPublic: store.currentItinerary.isPublic,
  publicSlug: store.currentItinerary.publicSlug,
  allowPdfDownload: store.currentItinerary.allowPdfDownload,
  customMessage: store.currentItinerary.customMessage,
});

// 6. LocalStorageを確認
const publicItineraries = JSON.parse(
  localStorage.getItem('journee_public_itineraries') || '{}'
);
console.log('✅ LocalStorage:', publicItineraries);

// 7. 公開設定を更新
store.updatePublicSettings({
  allowPdfDownload: false,
  customMessage: '更新されたメッセージ',
});
console.log('✅ 設定更新後:', store.currentItinerary);

// 8. しおりを非公開
const unpublishResult = await store.unpublishItinerary();
console.log('✅ 非公開結果:', unpublishResult);

// 9. 非公開後の確認
console.log('✅ 非公開後:', {
  isPublic: store.currentItinerary.isPublic,
  publicSlug: store.currentItinerary.publicSlug,
});
```

**期待される出力**:
- すべての操作でエラーが発生しない
- 公開時に10文字のスラッグが生成される
- LocalStorageに正しく保存される
- 非公開時にLocalStorageから削除される

---

## 3. UIテスト

### 3-1. しおり公開フロー

#### ステップ1: しおりを作成
1. ✅ アプリにログイン
2. ✅ チャットで旅行計画を作成
   - 例: 「京都に3泊4日で旅行に行きます。観光スポットを教えてください」
3. ✅ しおりが生成されることを確認

#### ステップ2: 共有ボタンをクリック
1. ✅ しおりプレビュー左上の「共有」ボタンをクリック
2. ✅ 公開設定パネルが開く
3. ✅ 初期状態は「非公開」

#### ステップ3: 公開設定
1. ✅ 「公開する」にチェックを入れる
2. ✅ 「PDFダウンロードを許可」にチェックを入れる
3. ✅ カスタムメッセージを入力（オプション）
   - 例: 「この旅行計画を参考にどうぞ！」
4. ✅ 「公開URLを発行」ボタンが有効になる
5. ✅ ボタンをクリック

#### ステップ4: 公開完了の確認
1. ✅ Toast通知「しおりを公開しました！」が表示される
2. ✅ パネルが「公開中」の状態に切り替わる
3. ✅ 公開URLが表示される
   - 形式: `http://localhost:3000/share/V1StGXR8_Z`
4. ✅ スラッグが10文字である

#### ステップ5: URLをコピー
1. ✅ コピーボタン（📋アイコン）をクリック
2. ✅ Toast通知「URLをコピーしました」が表示される
3. ✅ アイコンが一時的にチェックマーク（✓）に変わる
4. ✅ 2秒後に元のアイコンに戻る

#### ステップ6: 共有ボタン（モバイル）
1. ✅ 共有ボタン（🔗アイコン）をクリック
2. ✅ モバイル: OSのネイティブ共有ダイアログが表示される
3. ✅ デスクトップ: URLがコピーされる

### 3-2. 公開ページの確認

#### ステップ1: 公開ページを開く
1. ✅ 新しいタブで公開URLを開く
2. ✅ ページがロードされる
3. ✅ しおりの内容が表示される

#### ステップ2: Read-only モードの確認
1. ✅ タイトルが表示される（編集不可）
2. ✅ しおりサマリーが表示される
3. ✅ 日程表が表示される
4. ✅ 編集ボタンが表示されない
5. ✅ Undo/Redoボタンが表示されない

#### ステップ3: カスタムメッセージの確認
1. ✅ 青色のボックスでメッセージが表示される
2. ✅ メッセージ内容が正しい

#### ステップ4: PDFダウンロードボタン
1. ✅ 許可されている場合、PDFボタンが表示される
2. ✅ 許可されていない場合、ボタンが非表示

#### ステップ5: フッター情報
1. ✅ 「このしおりはJourneeで作成されました」リンクが表示される
2. ✅ 閲覧数が表示される（初期値: 0）
3. ✅ 公開日が表示される

### 3-3. 公開設定の変更

#### ステップ1: 設定パネルを開く
1. ✅ 元のタブに戻る
2. ✅ 「共有」ボタンをクリック
3. ✅ 「公開中」の状態で表示される

#### ステップ2: 設定を変更
1. ✅ PDFダウンロード許可のチェックを外す
2. ✅ カスタムメッセージを編集
   - 例: 「更新されたメッセージです」
3. ✅ 「設定を更新」ボタンが表示される
4. ✅ ボタンをクリック

#### ステップ3: 更新の確認
1. ✅ Toast通知「設定を更新しました」が表示される
2. ✅ パネルの設定が更新される

#### ステップ4: 公開ページで確認
1. ✅ 公開ページをリロード
2. ✅ PDFダウンロードボタンが非表示になっている
3. ✅ カスタムメッセージが更新されている

### 3-4. しおりを非公開にする

#### ステップ1: 非公開化
1. ✅ 元のタブで「共有」ボタンをクリック
2. ✅ 「公開を停止」ボタンをクリック
3. ✅ 確認ダイアログが表示される
   - テキスト: 「しおりを非公開にしますか？公開URLは無効になります。」
4. ✅ 「OK」をクリック

#### ステップ2: 非公開完了の確認
1. ✅ Toast通知「しおりを非公開にしました」が表示される
2. ✅ パネルが「非公開」の状態に切り替わる
3. ✅ 公開URL入力欄が消える
4. ✅ 「公開する」チェックボックスが表示される

#### ステップ3: 公開ページでの確認
1. ✅ 公開ページのタブをリロード
2. ✅ 404ページが表示される
3. ✅ 「しおりが見つかりません」メッセージが表示される
4. ✅ トップページへのリンクが表示される

---

## 4. 統合テスト

### 4-1. OGPメタデータの確認

#### ステップ1: ページソースの確認
1. ✅ 公開ページで右クリック→「ページのソースを表示」
2. ✅ `<meta property="og:title">` が存在する
3. ✅ `<meta property="og:description">` が存在する
4. ✅ `<meta property="og:image">` が存在する
5. ✅ `<meta name="twitter:card">` が存在する

#### ステップ2: SNSシェアプレビュー
1. ✅ [Twitter Card Validator](https://cards-dev.twitter.com/validator) でURLを確認
2. ✅ [Facebook Debugger](https://developers.facebook.com/tools/debug/) でURLを確認
3. ✅ タイトル、説明、画像が正しく表示される

### 4-2. Web Share API

#### ステップ1: モバイルデバイスでテスト
1. ✅ スマートフォンでアプリにアクセス
2. ✅ しおりを公開
3. ✅ 共有ボタンをタップ
4. ✅ OSのネイティブ共有ダイアログが表示される
5. ✅ LINE、Twitter、メールなどで共有可能

#### ステップ2: デスクトップでのフォールバック
1. ✅ デスクトップブラウザで共有ボタンをクリック
2. ✅ URLがクリップボードにコピーされる
3. ✅ Toast通知が表示される

### 4-3. LocalStorage管理

#### ステップ1: データの永続化
1. ✅ しおりを公開
2. ✅ ページをリロード
3. ✅ 公開状態が維持される
4. ✅ 公開URLが変わらない

#### ステップ2: 複数しおりの管理
1. ✅ 複数のしおりを作成
2. ✅ それぞれ異なるスラッグで公開
3. ✅ LocalStorageに複数のしおりが保存される
4. ✅ それぞれの公開URLが正しく機能する

---

## 5. エラーケーステスト

### 5-1. しおりが存在しない場合

#### テスト内容
1. ✅ しおりがnullの状態で「共有」ボタンが表示されない
2. ✅ または、ボタンが無効化されている

### 5-2. 存在しないスラッグへのアクセス

#### テスト内容
1. ✅ 存在しないスラッグでアクセス
   - 例: http://localhost:3000/share/nonexistent
2. ✅ 404ページが表示される
3. ✅ 「しおりが見つかりません」メッセージ
4. ✅ トップページへのリンクが機能する

### 5-3. 非公開しおりへのアクセス

#### テスト内容
1. ✅ しおりを公開
2. ✅ 公開URLを取得
3. ✅ しおりを非公開にする
4. ✅ 公開URLにアクセス
5. ✅ 404ページが表示される

### 5-4. ネットワークエラー

#### テスト内容（開発者ツールで実施）
1. ✅ Network タブを開く
2. ✅ Offline モードを有効化
3. ✅ しおりを公開しようとする
4. ✅ エラーToast「公開に失敗しました」が表示される

### 5-5. 無効な設定

#### テスト内容
1. ✅ 「公開する」チェックが外れている状態
2. ✅ 「公開URLを発行」ボタンが無効化されている
3. ✅ クリックできない

---

## 6. パフォーマンステスト

### 6-1. レスポンスタイム

| 操作 | 期待値 | 実測値 |
|------|--------|--------|
| 公開URL発行 | < 500ms | ___ms |
| 公開ページ読み込み | < 1s | ___ms |
| URLコピー | 即座 | ___ms |
| 設定更新 | < 200ms | ___ms |
| 非公開化 | < 500ms | ___ms |

### 6-2. スラッグ生成

#### テスト内容
```javascript
// 1000個のスラッグを生成して重複チェック
const slugs = new Set();
for (let i = 0; i < 1000; i++) {
  const { nanoid } = await import('nanoid');
  slugs.add(nanoid(10));
}
console.log('ユニーク数:', slugs.size); // 期待: 1000
```

**期待結果**: ✅ 1000個すべてがユニーク

---

## 7. チェックリスト

### 基本機能
- [ ] しおりを公開できる
- [ ] 公開URLが発行される
- [ ] 公開ページが表示される
- [ ] Read-onlyモードが機能する
- [ ] しおりを非公開にできる

### 公開設定
- [ ] PDFダウンロード許可の設定が機能する
- [ ] カスタムメッセージが表示される
- [ ] 設定を更新できる

### 共有機能
- [ ] URLコピーが機能する
- [ ] Web Share APIが機能する（モバイル）
- [ ] フォールバックが機能する（デスクトップ）

### OGP対応
- [ ] OGPメタデータが生成される
- [ ] SNSでリッチプレビューが表示される

### エラー処理
- [ ] 存在しないスラッグで404ページ
- [ ] 非公開しおりで404ページ
- [ ] ネットワークエラー時の適切な通知

### UI/UX
- [ ] Toast通知が適切に表示される
- [ ] ローディング状態が表示される
- [ ] 確認ダイアログが機能する
- [ ] レスポンシブ対応

---

## 8. テスト実行ログ

### 実行日: ___________

| テストケース | 結果 | 備考 |
|-------------|------|------|
| 自動テスト全体 | ⬜ | |
| UIテスト: 公開フロー | ⬜ | |
| UIテスト: 公開ページ | ⬜ | |
| UIテスト: 設定変更 | ⬜ | |
| UIテスト: 非公開化 | ⬜ | |
| OGPメタデータ | ⬜ | |
| Web Share API | ⬜ | |
| LocalStorage | ⬜ | |
| エラーケース | ⬜ | |
| パフォーマンス | ⬜ | |

### 検出された問題

1. _____________________________________
2. _____________________________________
3. _____________________________________

### 総合評価

- [ ] すべてのテストが成功
- [ ] 一部のテストが失敗（詳細を記載）
- [ ] Phase 5.5は本番環境準備完了

---

**テスト担当者**: ___________  
**承認者**: ___________  
**承認日**: ___________

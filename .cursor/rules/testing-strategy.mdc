---
globs: "e2e/**/*,**/*.test.ts,**/*.test.tsx,**/*.spec.ts,playwright.config.ts,jest.config.js"
description: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
---

# ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ - Playwright E2E Testing

## æ¦‚è¦
Playwrightã‚’ä½¿ç”¨ã—ãŸE2Eãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã€‚ä¸»è¦ãªæ©Ÿèƒ½ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã€å“è³ªã‚’ä¿è¨¼ã€‚

## ãƒ†ã‚¹ãƒˆæ§‹æˆ

### E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« (`e2e/`)
- [map-toggle.spec.ts](mdc:e2e/map-toggle.spec.ts) - åœ°å›³è¡¨ç¤ºãƒˆã‚°ãƒ«æ©Ÿèƒ½
- [test-command.spec.ts](mdc:e2e/test-command.spec.ts) - ã‚³ãƒžãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
- [comment-feature.spec.ts](mdc:e2e/comment-feature.spec.ts) - ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
- [itinerary-db-integration.spec.ts](mdc:e2e/itinerary-db-integration.spec.ts) - ã—ãŠã‚ŠDBçµ±åˆ
- [public-pdf-export.spec.ts](mdc:e2e/public-pdf-export.spec.ts) - å…¬é–‹ã—ãŠã‚ŠPDFå‡ºåŠ›

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- [playwright.config.ts](mdc:playwright.config.ts) - Playwrightè¨­å®š
- [jest.config.js](mdc:jest.config.js) - Jestè¨­å®šï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
- [jest.setup.js](mdc:jest.setup.js) - Jestã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [docs/TESTING.md](mdc:docs/TESTING.md) - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãƒ»å®Ÿè¡Œæ‰‹é †

## Playwrightè¨­å®š

### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  
  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
  timeout: 30 * 1000,
  expect: {
    timeout: 5000,
  },

  // ä¸¦åˆ—å®Ÿè¡Œ
  fullyParallel: true,
  
  // å¤±æ•—æ™‚ã®å†è©¦è¡Œ
  retries: process.env.CI ? 2 : 0,
  
  // ä¸¦åˆ—ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
  workers: process.env.CI ? 1 : undefined,

  // ãƒ¬ãƒãƒ¼ãƒˆè¨­å®š
  reporter: [
    ['html'],
    ['list'],
  ],

  // å…±é€šè¨­å®š
  use: {
    // ãƒ™ãƒ¼ã‚¹URL
    baseURL: 'http://localhost:3000',
    
    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    screenshot: 'only-on-failure',
    
    // ãƒ“ãƒ‡ã‚ª
    video: 'retain-on-failure',
    
    // ãƒˆãƒ¬ãƒ¼ã‚¹
    trace: 'on-first-retry',
  },

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    // ãƒ¢ãƒã‚¤ãƒ«
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

## ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### åŸºæœ¬ãƒ†ã‚¹ãƒˆæ§‹é€ 
```typescript
import { test, expect } from '@playwright/test';

test.describe('æ©Ÿèƒ½å', () => {
  test.beforeEach(async ({ page }) => {
    // å„ãƒ†ã‚¹ãƒˆã®å‰ã«å®Ÿè¡Œ
    await page.goto('/');
  });

  test('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å', async ({ page }) => {
    // ãƒ†ã‚¹ãƒˆå®Ÿè£…
    await page.click('button');
    await expect(page.locator('text=Success')).toBeVisible();
  });
});
```

### èªè¨¼ãƒ†ã‚¹ãƒˆ
```typescript
test.describe('èªè¨¼æ©Ÿèƒ½', () => {
  test('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ', async ({ page }) => {
    await page.goto('/login');
    
    // Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    await page.click('button:has-text("Googleã§ãƒ­ã‚°ã‚¤ãƒ³")');
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾…æ©Ÿ
    await page.waitForURL('/');
    
    // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
    await expect(page.locator('text=ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ')).toBeVisible();
  });

  test('æœªèªè¨¼ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™', async ({ page }) => {
    await page.goto('/mypage');
    
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    await page.waitForURL('/login');
  });
});
```

### ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
```typescript
test.describe('AIãƒãƒ£ãƒƒãƒˆ', () => {
  test('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¨å¿œç­”', async ({ page }) => {
    await page.goto('/');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›
    const input = page.locator('textarea[placeholder*="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"]');
    await input.fill('æ±äº¬ã§3æ—¥é–“ã®æ—…è¡Œè¨ˆç”»ã‚’ç«‹ã¦ãŸã„ã§ã™');
    
    // é€ä¿¡
    await page.click('button:has-text("é€ä¿¡")');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç¢ºèª
    await expect(page.locator('.loading')).toBeVisible();
    
    // AIå¿œç­”å¾…æ©Ÿï¼ˆæœ€å¤§30ç§’ï¼‰
    await expect(page.locator('.message-assistant').first()).toBeVisible({
      timeout: 30000,
    });
  });
});
```

### ã—ãŠã‚Šæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
```typescript
test.describe('ã—ãŠã‚Šç®¡ç†', () => {
  test('ã—ãŠã‚Šä¿å­˜', async ({ page }) => {
    await page.goto('/');
    
    // ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆçœç•¥ï¼‰
    
    // ã—ãŠã‚ŠãŒç”Ÿæˆã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    await page.waitForSelector('.itinerary-preview');
    
    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    await page.click('button:has-text("ä¿å­˜")');
    
    // æˆåŠŸé€šçŸ¥ç¢ºèª
    await expect(page.locator('text=ä¿å­˜ã—ã¾ã—ãŸ')).toBeVisible();
  });

  test('ã—ãŠã‚Šå…¬é–‹', async ({ page }) => {
    await page.goto('/mypage');
    
    // ã—ãŠã‚Šã‚’é¸æŠž
    await page.click('.itinerary-card').first();
    
    // å…¬é–‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    await page.click('button:has-text("å…¬é–‹")');
    
    // å…¬é–‹URLå–å¾—
    const shareUrl = await page.locator('input[readonly]').inputValue();
    expect(shareUrl).toContain('/share/');
    
    // å…¬é–‹ãƒšãƒ¼ã‚¸ã«ç§»å‹•
    await page.goto(shareUrl);
    
    // ã—ãŠã‚Šè¡¨ç¤ºç¢ºèª
    await expect(page.locator('.itinerary-preview')).toBeVisible();
  });
});
```

### ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
```typescript
test.describe('ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½', () => {
  test('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã¨è¡¨ç¤º', async ({ page }) => {
    // å…¬é–‹ã—ãŠã‚Šãƒšãƒ¼ã‚¸ã«ç§»å‹•
    await page.goto('/share/test-slug');
    
    // ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆçœç•¥ï¼‰
    
    // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›
    await page.fill('textarea[placeholder*="ã‚³ãƒ¡ãƒ³ãƒˆ"]', 'ãƒ†ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ');
    
    // æŠ•ç¨¿
    await page.click('button:has-text("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿")');
    
    // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºç¢ºèª
    await expect(page.locator('text=ãƒ†ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ')).toBeVisible();
  });
});
```

### PDFå‡ºåŠ›ãƒ†ã‚¹ãƒˆ
```typescript
test.describe('PDFå‡ºåŠ›', () => {
  test('PDFç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', async ({ page }) => {
    await page.goto('/share/test-slug');
    
    // PDFå‡ºåŠ›ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    const downloadPromise = page.waitForEvent('download');
    await page.click('button:has-text("PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")');
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç¢ºèª
    const download = await downloadPromise;
    expect(download.suggestedFilename()).toMatch(/\.pdf$/);
  });
});
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ†ã‚¹ãƒˆ
```typescript
test.describe('ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³', () => {
  test('ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º', async ({ page }) => {
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆè¨­å®š
    await page.setViewportSize({ width: 375, height: 667 });
    
    await page.goto('/');
    
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç¢ºèª
    await expect(page.locator('.mobile-menu')).toBeVisible();
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç¢ºèª
    await page.click('button:has-text("ã—ãŠã‚Š")');
    await expect(page.locator('.itinerary-preview')).toBeVisible();
  });

  test('ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤º', async ({ page }) => {
    await page.setViewportSize({ width: 1280, height: 720 });
    
    await page.goto('/');
    
    // ãƒªã‚µã‚¤ã‚ºå¯èƒ½ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºèª
    await expect(page.locator('.resizable-layout')).toBeVisible();
  });
});
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ
```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:e2e

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:e2e -- comment-feature.spec.ts

# UIãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
npm run test:e2e:ui

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
npm run test:e2e -- --debug
```

### CI/CDå®Ÿè¡Œ
```bash
# CIç’°å¢ƒã§ã®å®Ÿè¡Œ
CI=true npm run test:e2e
```

## ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼

### ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
```typescript
// e2e/fixtures/auth.ts
import { test as base } from '@playwright/test';

export const test = base.extend({
  authenticatedPage: async ({ page }, use) => {
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    await page.goto('/login');
    await page.click('button:has-text("Googleã§ãƒ­ã‚°ã‚¤ãƒ³")');
    await page.waitForURL('/');
    
    await use(page);
  },
});
```

### ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ‡ãƒ«
```typescript
// e2e/pages/ItineraryPage.ts
export class ItineraryPage {
  constructor(private page: Page) {}

  async goto() {
    await this.page.goto('/');
  }

  async sendMessage(message: string) {
    await this.page.fill('textarea[placeholder*="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"]', message);
    await this.page.click('button:has-text("é€ä¿¡")');
  }

  async waitForAIResponse() {
    await this.page.waitForSelector('.message-assistant', {
      timeout: 30000,
    });
  }

  async saveItinerary() {
    await this.page.click('button:has-text("ä¿å­˜")');
    await this.page.waitForSelector('text=ä¿å­˜ã—ã¾ã—ãŸ');
  }
}

// ä½¿ç”¨ä¾‹
test('ã—ãŠã‚Šä½œæˆãƒ•ãƒ­ãƒ¼', async ({ page }) => {
  const itineraryPage = new ItineraryPage(page);
  await itineraryPage.goto();
  await itineraryPage.sendMessage('æ±äº¬æ—…è¡Œ');
  await itineraryPage.waitForAIResponse();
  await itineraryPage.saveItinerary();
});
```

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### DOï¼ˆæŽ¨å¥¨ï¼‰
- âœ… ãƒ†ã‚¹ãƒˆã‚’ç‹¬ç«‹ã•ã›ã‚‹ï¼ˆä»–ã®ãƒ†ã‚¹ãƒˆã«ä¾å­˜ã—ãªã„ï¼‰
- âœ… æ˜Žç¢ºãªãƒ†ã‚¹ãƒˆåã‚’ä½¿ç”¨
- âœ… é©åˆ‡ãªå¾…æ©Ÿå‡¦ç†ï¼ˆwaitForSelectorç­‰ï¼‰
- âœ… ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ»ãƒ“ãƒ‡ã‚ªéŒ²ç”»ã‚’æ´»ç”¨
- âœ… CI/CDã§ã®è‡ªå‹•å®Ÿè¡Œ
- âœ… ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
- âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã§å…±é€šå‡¦ç†ã‚’æŠ½è±¡åŒ–

### DON'Tï¼ˆéžæŽ¨å¥¨ï¼‰
- âŒ sleep()ã§ã®å›ºå®šå¾…æ©Ÿ
- âŒ ä¸å®‰å®šãªã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆä½ç½®ãƒ™ãƒ¼ã‚¹ç­‰ï¼‰
- âŒ ãƒ†ã‚¹ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚
- âŒ éŽåº¦ã«é•·ã„ãƒ†ã‚¹ãƒˆ
- âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¸è¶³
- âŒ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰

## ãƒ‡ãƒãƒƒã‚°

### Playwright Inspector
```bash
npm run test:e2e -- --debug
```

### ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±
```typescript
await page.screenshot({ path: 'screenshot.png' });
```

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ç¢ºèª
```typescript
page.on('console', (msg) => console.log('PAGE LOG:', msg.text()));
```

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆç¢ºèª
```typescript
page.on('request', (request) =>
  console.log('>>', request.method(), request.url())
);
page.on('response', (response) =>
  console.log('<<', response.status(), response.url())
);
```

## CI/CDçµ±åˆ

### GitHub Actionsä¾‹
```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

## ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### ç¾åœ¨ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆPhase 10.4æ™‚ç‚¹ï¼‰
- âœ… åœ°å›³è¡¨ç¤ºãƒˆã‚°ãƒ«
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
- âœ… ã—ãŠã‚ŠDBçµ±åˆ
- âœ… å…¬é–‹ã—ãŠã‚ŠPDFå‡ºåŠ›
- âœ… åŸºæœ¬çš„ãªã‚³ãƒžãƒ³ãƒ‰

### ä»Šå¾Œè¿½åŠ äºˆå®š
- ðŸ“‹ èªè¨¼ãƒ•ãƒ­ãƒ¼
- ðŸ“‹ ã—ãŠã‚Šç·¨é›†æ©Ÿèƒ½
- ðŸ“‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
- ðŸ“‹ è¨­å®šå¤‰æ›´
- ðŸ“‹ ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

## å‚è€ƒãƒªãƒ³ã‚¯

- [Playwright Documentation](https://playwright.dev/)
- [Best Practices](https://playwright.dev/docs/best-practices)
- [docs/TESTING.md](mdc:docs/TESTING.md) - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥è©³ç´°
- [playwright.config.ts](mdc:playwright.config.ts) - Playwrightè¨­å®š
- [e2e/](mdc:e2e/) - E2Eãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

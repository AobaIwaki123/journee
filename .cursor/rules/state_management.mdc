---
alwaysApply: true
description: ZustandçŠ¶æ…‹ç®¡ç†ã®è¨­è¨ˆãƒ»å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
---

# Zustand çŠ¶æ…‹ç®¡ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

## æ¦‚è¦

ã™ã¹ã¦ã®çŠ¶æ…‹ç®¡ç†ã¯ [useStore.ts](mdc:lib/store/useStore.ts) ã«é›†ç´„ã€‚Zustandã‚’ä½¿ç”¨ã—ãŸã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ç®¡ç†ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€‚

## ã‚¹ãƒˆã‚¢æ§‹é€ 

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢
[useStore.ts](mdc:lib/store/useStore.ts) - å˜ä¸€ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢ã§ã™ã¹ã¦ã®çŠ¶æ…‹ã‚’ç®¡ç†

### ä¸»è¦ãªçŠ¶æ…‹

#### ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹
- `messages`: ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´
- `isLoading`: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
- `isStreaming`: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã®çŠ¶æ…‹
- `streamingMessage`: ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

#### ã—ãŠã‚ŠçŠ¶æ…‹
- `currentItinerary`: ç¾åœ¨ã®ã—ãŠã‚Šãƒ‡ãƒ¼ã‚¿ï¼ˆ`ItineraryData`å‹ï¼‰
- `planningPhase`: ç¾åœ¨ã®è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚º
- `currentDetailingDay`: è©³ç´°åŒ–ä¸­ã®æ—¥ç¨‹

#### UIçŠ¶æ…‹
- `selectedAI`: é¸æŠä¸­ã®AIãƒ¢ãƒ‡ãƒ«ï¼ˆgemini / claudeï¼‰
- `error`: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
- `soundEnabled`: åŠ¹æœéŸ³ON/OFF
- `soundVolume`: éŸ³é‡è¨­å®šï¼ˆ0.0 - 1.0ï¼‰

#### APIã‚­ãƒ¼ç®¡ç†
- `claudeApiKey`: Claude APIã‚­ãƒ¼

## ã‚¹ãƒˆã‚¢å®šç¾©ãƒ‘ã‚¿ãƒ¼ãƒ³

### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
```typescript
interface AppState {
  // ã‚¹ãƒ†ãƒ¼ãƒˆ
  messages: Message[];
  isLoading: boolean;
  currentItinerary: ItineraryData | null;
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
  addMessage: (message: Message) => void;
  setLoading: (loading: boolean) => void;
  setItinerary: (itinerary: ItineraryData | null) => void;
}
```

### ã‚¹ãƒˆã‚¢ä½œæˆ
```typescript
export const useStore = create<AppState>((set) => ({
  // åˆæœŸå€¤
  messages: [],
  isLoading: false,
  currentItinerary: null,
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
  addMessage: (message) =>
    set((state) => ({ messages: [...state.messages, message] })),
  
  setLoading: (loading) => 
    set({ isLoading: loading }),
  
  setItinerary: (itinerary) => 
    set({ currentItinerary: itinerary }),
}));
```

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ä½¿ç”¨

### ã‚¹ãƒ†ãƒ¼ãƒˆå–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// âœ… Good - å¿…è¦ãªéƒ¨åˆ†ã®ã¿å–å¾—
const { messages, isLoading } = useStore();

// âœ… Good - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿å–å¾—
const addMessage = useStore((state) => state.addMessage);

// âœ… Good - ã‚»ãƒ¬ã‚¯ã‚¿ã§å¿…è¦ãªå€¤ã®ã¿
const messageCount = useStore((state) => state.messages.length);

// âŒ Bad - å…¨ä½“ã‚’å–å¾—
const store = useStore();
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

```typescript
// âœ… Good - ã‚»ãƒ¬ã‚¯ã‚¿ä½¿ç”¨ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€å°åŒ–ï¼‰
const messageCount = useStore((state) => state.messages.length);

// âŒ Bad - å…¨ä½“å–å¾—ï¼ˆmessagesãŒå¤‰ã‚ã‚‹ãŸã³ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰
const { messages } = useStore();
const messageCount = messages.length;
```

### è¤‡æ•°çŠ¶æ…‹ã®è³¼èª­

```typescript
// âœ… Good - å¿…è¦ãªçŠ¶æ…‹ã®ã¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å–å¾—
const {
  planningPhase,
  currentDetailingDay,
  proceedToNextStep
} = useStore(state => ({
  planningPhase: state.planningPhase,
  currentDetailingDay: state.currentDetailingDay,
  proceedToNextStep: state.proceedToNextStep
}));
```

## ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³

### å˜ç´”ãªæ›´æ–°
```typescript
setLoading: (loading) => set({ isLoading: loading })
```

### é…åˆ—ã¸ã®è¿½åŠ 
```typescript
addMessage: (message) =>
  set((state) => ({ 
    messages: [...state.messages, message] 
  }))
```

### é…åˆ—ã®æ›´æ–°
```typescript
updateMessage: (id, updates) =>
  set((state) => ({
    messages: state.messages.map(msg =>
      msg.id === id ? { ...msg, ...updates } : msg
    )
  }))
```

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
```typescript
updateItinerary: (updates) =>
  set((state) => ({
    currentItinerary: state.currentItinerary
      ? { ...state.currentItinerary, ...updates }
      : null,
  }))
```

### ã‚¯ãƒªã‚¢ãƒ»ãƒªã‚»ãƒƒãƒˆ
```typescript
clearMessages: () => set({ messages: [] })

resetChat: () => set({ 
  messages: [], 
  isLoading: false,
  isStreaming: false,
})
```

### è¤‡æ•°ã‚¹ãƒ†ãƒ¼ãƒˆåŒæ™‚æ›´æ–°
```typescript
resetState: () => set({
  messages: [],
  currentItinerary: null,
  isLoading: false,
  error: null,
})
```

## éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§async/await
```typescript
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…
const { addMessage, setLoading } = useStore();

const handleSend = async (content: string) => {
  setLoading(true);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
  addMessage({
    id: generateId(),
    role: 'user',
    content,
    timestamp: new Date(),
  });
  
  try {
    // APIå‘¼ã³å‡ºã—
    const response = await fetch('/api/chat', {
      method: 'POST',
      body: JSON.stringify({ content }),
    });
    const data = await response.json();
    
    // AIå¿œç­”è¿½åŠ 
    addMessage({
      id: generateId(),
      role: 'assistant',
      content: data.message,
      timestamp: new Date(),
    });
  } catch (error) {
    console.error('Error:', error);
  } finally {
    setLoading(false);
  }
};
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚¹ãƒˆã‚¢ã«asyncã‚¢ã‚¯ã‚·ãƒ§ãƒ³
```typescript
// useStore.ts
interface AppState {
  // ...
  sendMessage: (content: string) => Promise<void>;
}

export const useStore = create<AppState>((set, get) => ({
  // ...
  sendMessage: async (content) => {
    set({ isLoading: true });
    
    try {
      // APIå‘¼ã³å‡ºã—
      const response = await fetch('/api/chat', {
        method: 'POST',
        body: JSON.stringify({ content }),
      });
      const data = await response.json();
      
      // ã‚¹ãƒ†ãƒ¼ãƒˆæ›´æ–°
      set((state) => ({
        messages: [
          ...state.messages,
          { id: generateId(), role: 'user', content, timestamp: new Date() },
          { id: generateId(), role: 'assistant', content: data.message, timestamp: new Date() },
        ],
      }));
    } catch (error) {
      console.error('Error:', error);
      set({ error: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ' });
    } finally {
      set({ isLoading: false });
    }
  },
}));
```

## æ°¸ç¶šåŒ–ï¼ˆLocalStorageé€£æºï¼‰

### persist ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

export const useStore = create<AppState>()(
  persist(
    (set) => ({
      // ã‚¹ãƒˆã‚¢å®šç¾©
      selectedAI: 'gemini',
      soundEnabled: true,
      // ...
    }),
    {
      name: 'journee-storage',
      // æ°¸ç¶šåŒ–ã—ãŸã„ã‚­ãƒ¼ã‚’æŒ‡å®š
      partialize: (state) => ({
        selectedAI: state.selectedAI,
        soundEnabled: state.soundEnabled,
        soundVolume: state.soundVolume,
      }),
    }
  )
);
```

## ãƒ‡ãƒãƒƒã‚°

### Redux DevToolsçµ±åˆ
```typescript
import { devtools } from 'zustand/middleware';

export const useStore = create<AppState>()(
  devtools(
    (set) => ({
      // ã‚¹ãƒˆã‚¢å®šç¾©
    }),
    { name: 'JourneeStore' }
  )
);
```

### é–‹ç™ºç’°å¢ƒã§ã®ãƒ­ã‚®ãƒ³ã‚°
```typescript
export const useStore = create<AppState>((set) => ({
  addMessage: (message) =>
    set((state) => {
      const newMessages = [...state.messages, message];
      if (process.env.NODE_ENV === 'development') {
        console.log('Messages updated:', newMessages.length);
      }
      return { messages: newMessages };
    }),
}));
```

## å®Ÿè£…ãƒ«ãƒ¼ãƒ«

### 1. çŠ¶æ…‹ã®åˆ†å‰²
- é–¢é€£ã™ã‚‹çŠ¶æ…‹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
- é©åˆ‡ãªã‚¹ãƒ©ã‚¤ã‚¹åˆ†å‰²
- çŠ¶æ…‹é–“ã®ä¾å­˜é–¢ä¿‚ã‚’æœ€å°åŒ–

### 2. å‹å®‰å…¨æ€§
- ã™ã¹ã¦ã®çŠ¶æ…‹ã«æ˜ç¤ºçš„ãªå‹å®šç¾©
- Unionå‹ã‚’æ´»ç”¨ã—ãŸãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†
- å‹ã‚¬ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å®‰å…¨ãªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
- `any`å‹ã®ä½¿ç”¨ç¦æ­¢

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- å¿…è¦ãªçŠ¶æ…‹ã®ã¿ã‚’è³¼èª­
- ã‚»ãƒ¬ã‚¯ã‚¿é–¢æ•°ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–
- ãƒ¡ãƒ¢åŒ–ï¼ˆReact.memo, useMemoï¼‰ã®æ´»ç”¨
- ãƒãƒƒãƒæ›´æ–°ã®æ´»ç”¨

### 4. æ°¸ç¶šåŒ–
- LocalStorageã«ã‚ˆã‚‹çŠ¶æ…‹ã®æ°¸ç¶šåŒ–
- å¿…è¦ãªçŠ¶æ…‹ã®ã¿ã‚’æ°¸ç¶šåŒ–ï¼ˆ`partialize`ä½¿ç”¨ï¼‰
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã®å®Ÿè£…

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### DOï¼ˆæ¨å¥¨ï¼‰
- âœ… ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªæ›´æ–°ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ä½¿ç”¨ï¼‰
- âœ… å‹å®šç¾©ã‚’å¸¸ã«æ˜ç¤º
- âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åã¯å‹•è©ã§å§‹ã‚ã‚‹ï¼ˆadd, set, update, clear, resetï¼‰
- âœ… å¿…è¦ãªéƒ¨åˆ†ã®ã¿ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å–å¾—
- âœ… ã‚»ãƒ¬ã‚¯ã‚¿é–¢æ•°ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–
- âœ… å˜ä¸€ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢ã‚’ç¶­æŒ

### DON'Tï¼ˆéæ¨å¥¨ï¼‰
- âŒ ç›´æ¥ã‚¹ãƒ†ãƒ¼ãƒˆã‚’å¤‰æ›´ï¼ˆ`state.messages.push()`ï¼‰
- âŒ è¤‡æ•°ã®ã‚¹ãƒˆã‚¢ã«åˆ†å‰²
- âŒ useEffectå†…ã§ã®ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼ˆä¾å­˜é…åˆ—ã«æ³¨æ„ï¼‰
- âŒ ä¸å¿…è¦ãªå…¨ä½“å–å¾—
- âŒ anyå‹ã®ä½¿ç”¨

## æ³¨æ„äº‹é …

### 1. çŠ¶æ…‹ã®æ­£è¦åŒ–
- é‡è¤‡ã‚’é¿ã‘ã‚‹
- å˜ä¸€ã®ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºï¼ˆSingle Source of Truthï¼‰ã‚’ç¶­æŒ
- çŠ¶æ…‹é–“ã®æ•´åˆæ€§ã‚’ä¿ã¤

### 2. å‰¯ä½œç”¨ã®ç®¡ç†
- å‰¯ä½œç”¨ã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å‡¦ç†
- useEffectã®é©åˆ‡ãªä½¿ç”¨
- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã®å®Ÿè£…

### 3. ãƒ‡ãƒãƒƒã‚°å¯¾å¿œ
- é–‹ç™ºç’°å¢ƒã§ã®ãƒ­ã‚®ãƒ³ã‚°
- DevToolsã¨ã®çµ±åˆ
- ã‚¨ãƒ©ãƒ¼è¿½è·¡ã®å®¹æ˜“ã•

## å®Ÿè£…ä¾‹

### åŸºæœ¬çš„ãªä½¿ç”¨
```typescript
'use client';

import { useStore } from '@/lib/store/useStore';

export const ChatBox: React.FC = () => {
  // å¿…è¦ãªçŠ¶æ…‹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
  const {
    messages,
    isStreaming,
    addMessage,
    appendStreamingMessage
  } = useStore();
  
  return (
    <div>
      {messages.map(msg => (
        <div key={msg.id}>{msg.content}</div>
      ))}
      {isStreaming && <div>å…¥åŠ›ä¸­...</div>}
    </div>
  );
};
```

### é¸æŠçš„è³¼èª­
```typescript
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿
const addMessage = useStore((state) => state.addMessage);

// å˜ä¸€ã®å€¤
const selectedAI = useStore((state) => state.selectedAI);

// è¨ˆç®—ã•ã‚ŒãŸå€¤
const hasMessages = useStore((state) => state.messages.length > 0);
```

## ç¾åœ¨ã®å®Ÿè£…çŠ¶æ…‹

- âœ… åŸºæœ¬ã‚¹ãƒˆã‚¢æ§‹é€ 
- âœ… ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ç®¡ç†
- âœ… ã—ãŠã‚ŠçŠ¶æ…‹ç®¡ç†
- âœ… UIçŠ¶æ…‹ç®¡ç†
- âœ… æ°¸ç¶šåŒ–ï¼ˆLocalStorageï¼‰
- ğŸ“‹ DevToolsçµ±åˆï¼ˆé–‹ç™ºæ™‚ã®ã¿ã€å¿…è¦ã«å¿œã˜ã¦ï¼‰

## å‚è€ƒãƒªãƒ³ã‚¯

- [Zustandå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/pmndrs/zustand)
- [lib/store/useStore.ts](mdc:lib/store/useStore.ts) - ã‚¹ãƒˆã‚¢å®Ÿè£…
- [lib/store/useStore-helper.ts](mdc:lib/store/useStore-helper.ts) - ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

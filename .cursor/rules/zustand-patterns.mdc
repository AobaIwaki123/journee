---
globs: "lib/store/**/*,components/**/*"
---

# ZustandçŠ¶æ…‹ç®¡ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

## ã‚¹ãƒˆã‚¢æ§‹é€ 

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒˆã‚¢
ã™ã¹ã¦ã®çŠ¶æ…‹ç®¡ç†ã¯ [useStore.ts](mdc:lib/store/useStore.ts) ã«é›†ç´„ã€‚

### ã‚¹ãƒ†ãƒ¼ãƒˆåˆ†é¡
1. **ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
2. **ã—ãŠã‚ŠçŠ¶æ…‹**: ç¾åœ¨ã®ã—ãŠã‚Šãƒ‡ãƒ¼ã‚¿
3. **UIçŠ¶æ…‹**: AIãƒ¢ãƒ‡ãƒ«é¸æŠãªã©

## ã‚¹ãƒˆã‚¢å®šç¾©ãƒ‘ã‚¿ãƒ¼ãƒ³

### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
```typescript
interface AppState {
  // ã‚¹ãƒ†ãƒ¼ãƒˆ
  messages: Message[];
  isLoading: boolean;
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
  addMessage: (message: Message) => void;
  setLoading: (loading: boolean) => void;
}
```

### ã‚¹ãƒˆã‚¢ä½œæˆ
```typescript
export const useStore = create<AppState>((set) => ({
  // åˆæœŸå€¤
  messages: [],
  isLoading: false,
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
  addMessage: (message) =>
    set((state) => ({ messages: [...state.messages, message] })),
  setLoading: (loading) => set({ isLoading: loading }),
}));
```

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ä½¿ç”¨

### ã‚¹ãƒ†ãƒ¼ãƒˆå–å¾—
```typescript
// âœ… Good - å¿…è¦ãªéƒ¨åˆ†ã®ã¿å–å¾—
const { messages, isLoading } = useStore();

// âœ… Good - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿
const addMessage = useStore((state) => state.addMessage);

// âŒ Bad - å…¨ä½“ã‚’å–å¾—
const store = useStore();
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
```typescript
// âœ… Good - ã‚»ãƒ¬ã‚¯ã‚¿ä½¿ç”¨ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€å°åŒ–ï¼‰
const messageCount = useStore((state) => state.messages.length);

// âŒ Bad - å…¨ä½“å–å¾—ï¼ˆmessagesãŒå¤‰ã‚ã‚‹ãŸã³ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰
const { messages } = useStore();
const messageCount = messages.length;
```

## ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³

### å˜ç´”ãªæ›´æ–°
```typescript
setLoading: (loading) => set({ isLoading: loading })
```

### é…åˆ—ã¸ã®è¿½åŠ 
```typescript
addMessage: (message) =>
  set((state) => ({ 
    messages: [...state.messages, message] 
  }))
```

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
```typescript
updateItinerary: (updates) =>
  set((state) => ({
    currentItinerary: state.currentItinerary
      ? { ...state.currentItinerary, ...updates }
      : null,
  }))
```

### ã‚¯ãƒªã‚¢ãƒ»ãƒªã‚»ãƒƒãƒˆ
```typescript
clearMessages: () => set({ messages: [] })
```

### è¤‡æ•°ã‚¹ãƒ†ãƒ¼ãƒˆåŒæ™‚æ›´æ–°
```typescript
resetChat: () => set({ 
  messages: [], 
  isLoading: false 
})
```

## éåŒæœŸå‡¦ç†

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§async/await
```typescript
// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…
const { addMessage, setLoading } = useStore();

const handleSend = async (content: string) => {
  setLoading(true);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
  addMessage({
    id: generateId(),
    role: 'user',
    content,
    timestamp: new Date(),
  });
  
  try {
    // APIå‘¼ã³å‡ºã—
    const response = await fetch('/api/chat', {
      method: 'POST',
      body: JSON.stringify({ content }),
    });
    const data = await response.json();
    
    // AIå¿œç­”è¿½åŠ 
    addMessage({
      id: generateId(),
      role: 'assistant',
      content: data.message,
      timestamp: new Date(),
    });
  } catch (error) {
    console.error('Error:', error);
  } finally {
    setLoading(false);
  }
};
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚¹ãƒˆã‚¢ã«asyncã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆPhase 3ä»¥é™ï¼‰
```typescript
// useStore.ts
interface AppState {
  // ...
  sendMessage: (content: string) => Promise<void>;
}

export const useStore = create<AppState>((set, get) => ({
  // ...
  sendMessage: async (content) => {
    set({ isLoading: true });
    
    try {
      // APIå‘¼ã³å‡ºã—
      const response = await fetch('/api/chat', {
        method: 'POST',
        body: JSON.stringify({ content }),
      });
      const data = await response.json();
      
      // ã‚¹ãƒ†ãƒ¼ãƒˆæ›´æ–°
      set((state) => ({
        messages: [
          ...state.messages,
          { id: generateId(), role: 'user', content, timestamp: new Date() },
          { id: generateId(), role: 'assistant', content: data.message, timestamp: new Date() },
        ],
      }));
    } catch (error) {
      console.error('Error:', error);
    } finally {
      set({ isLoading: false });
    }
  },
}));
```

## ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é€£æºï¼ˆPhase 4ä»¥é™ï¼‰

### æ°¸ç¶šåŒ–
```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

export const useStore = create<AppState>()(
  persist(
    (set) => ({
      // ã‚¹ãƒˆã‚¢å®šç¾©
    }),
    {
      name: 'journee-storage',
      // æ°¸ç¶šåŒ–ã—ãŸã„ã‚­ãƒ¼ã‚’æŒ‡å®š
      partialize: (state) => ({
        selectedAI: state.selectedAI,
      }),
    }
  )
);
```

## ãƒ‡ãƒãƒƒã‚°

### Redux DevToolsï¼ˆé–‹ç™ºæ™‚ï¼‰
```typescript
import { devtools } from 'zustand/middleware';

export const useStore = create<AppState>()(
  devtools(
    (set) => ({
      // ã‚¹ãƒˆã‚¢å®šç¾©
    }),
    { name: 'JourneeStore' }
  )
);
```

## ç¦æ­¢äº‹é …
- âŒ ç›´æ¥ã‚¹ãƒ†ãƒ¼ãƒˆã‚’å¤‰æ›´ï¼ˆ`state.messages.push()`ï¼‰
- âŒ è¤‡æ•°ã®ã‚¹ãƒˆã‚¢ã«åˆ†å‰²ï¼ˆå˜ä¸€ã‚¹ãƒˆã‚¢åŸå‰‡ï¼‰
- âŒ useEffectå†…ã§ã®ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼ˆä¾å­˜é…åˆ—ã«æ³¨æ„ï¼‰

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- âœ… ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªæ›´æ–°ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ä½¿ç”¨ï¼‰
- âœ… å‹å®šç¾©ã‚’å¸¸ã«æ˜ç¤º
- âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åã¯å‹•è©ã§å§‹ã‚ã‚‹ï¼ˆadd, set, update, clearï¼‰
- âœ… å¿…è¦ãªéƒ¨åˆ†ã®ã¿ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å–å¾—
- âœ… ã‚»ãƒ¬ã‚¯ã‚¿é–¢æ•°ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

## ç¾åœ¨ã®å®Ÿè£…çŠ¶æ…‹ï¼ˆPhase 1å®Œäº†ï¼‰
- âœ… åŸºæœ¬ã‚¹ãƒˆã‚¢æ§‹é€ 
- âœ… ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ç®¡ç†
- âœ… ã—ãŠã‚ŠçŠ¶æ…‹ç®¡ç†
- âœ… UIçŠ¶æ…‹ç®¡ç†
- ğŸ“‹ æ°¸ç¶šåŒ–ï¼ˆPhase 4ã§å®Ÿè£…ï¼‰
- ğŸ“‹ DevToolsçµ±åˆï¼ˆé–‹ç™ºæ™‚ã®ã¿ã€å¿…è¦ã«å¿œã˜ã¦ï¼‰
